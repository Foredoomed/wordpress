<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">

<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<title>闭包及其在Java中的模拟实现 — Zhixingheyi</title>

<link rel="stylesheet" href="http://liuxuan.info/wp-content/themes/uncomplicated/style.css" type="text/css" media="screen" />
<link rel="pingback" href="http://liuxuan.info/xmlrpc.php" />




<link rel='stylesheet' id='wp-pagenavi-css'  href='http://liuxuan.info/wp-content/plugins/wp-pagenavi/pagenavi-css.css?ver=2.70' type='text/css' media='all' />
<script type='text/javascript' src='http://liuxuan.info/wp-includes/js/l10n.js?ver=20101110'></script>
<script type='text/javascript' src='http://liuxuan.info/wp-includes/js/comment-reply.js?ver=20090102'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://liuxuan.info/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://liuxuan.info/wp-includes/wlwmanifest.xml" /> 
<link rel='index' title='Zhixingheyi' href='http://liuxuan.info/' />
<link rel='start' title='为什么Java匿名内部类中的方法参数必须定义为final' href='http://liuxuan.info/2011/03/07/java-anonymous-class/' />
<link rel='prev' title='为什么Java匿名内部类中的方法参数必须定义为final' href='http://liuxuan.info/2011/03/07/java-anonymous-class/' />
<link rel='next' title='2011年的计划' href='http://liuxuan.info/2011/03/07/plans-in-2011/' />
<meta name="generator" content="WordPress 3.1.3" />
<link rel='shortlink' href='http://liuxuan.info/?p=33' />

<!-- All in One SEO Pack 1.6.13.2 by Michael Torbert of Semper Fi Web Design[307,372] -->
<meta name="description" content="解释了什么是闭包以及怎样在Java中模拟闭包的实现" />
<meta name="keywords" content="java,anonymous class,closure" />
<link rel="canonical" href="http://liuxuan.info/2011/03/07/%e9%97%ad%e5%8c%85%e5%8f%8a%e5%85%b6%e5%9c%a8java%e4%b8%ad%e7%9a%84%e6%a8%a1%e6%8b%9f%e5%ae%9e%e7%8e%b0/" />
<!-- /all in one seo pack -->

<!-- Bad Behavior 2.0.43 run time: 4.689 ms -->
<script type="text/javascript">
<!--
function bb2_addLoadEvent(func) {
	var oldonload = window.onload;
	if (typeof window.onload != 'function') {
		window.onload = func;
	} else {
		window.onload = function() {
			oldonload();
			func();
		}
	}
}

bb2_addLoadEvent(function() {
	for ( i=0; i < document.forms.length; i++ ) {
		if (document.forms[i].method == 'post') {
			var myElement = document.createElement('input');
			myElement.setAttribute('type', 'hidden');
			myElement.name = 'bb2_screener_';
			myElement.value = '1307498668 218.249.47.126 172.27.27.36';
			document.forms[i].appendChild(myElement);
		}
	}
});
// --></script>
		
<link rel="stylesheet" href="http://liuxuan.info/wp-content/plugins/wp-syntax/wp-syntax.css" type="text/css" media="screen" />
</head>

<body>

<div id="container">


<div id="header">
	<h1><a href="http://liuxuan.info/">Zhixingheyi</a></h1>
		<div class="border"></div>
	<h2>Where the truth distortion is.</h2>
</div>
	

<div id="menuholder">
		<div class="menu">
			<div class="page-navi"><ul><li ><a href="http://liuxuan.info/" title="Home">Home</a></li><li class="page_item page-item-41"><a href="http://liuxuan.info/about/" title="About">About</a></li><li class="page_item page-item-110"><a href="http://liuxuan.info/programmer-competency-matrix/" title="Programmer Competency Matrix">Programmer Competency Matrix</a></li></ul></div>
		</div>

		
</div>
	<div id="content">

	
		<div class="post-33 post type-post status-publish format-standard hentry category-java tag-anonymous-class tag-closure tag-java" id="post-33">
			<h2><a href="http://liuxuan.info/2011/03/07/%e9%97%ad%e5%8c%85%e5%8f%8a%e5%85%b6%e5%9c%a8java%e4%b8%ad%e7%9a%84%e6%a8%a1%e6%8b%9f%e5%ae%9e%e7%8e%b0/" rel="bookmark" title="Permanent Link: 闭包及其在Java中的模拟实现">闭包及其在Java中的模拟实现</a></h2>
			<div class="postmetadata"><p>Posted on March 7th, 2011 under <a href="http://liuxuan.info/category/java/" title="View all posts in Java" rel="category tag">Java</a></p></div>
	
			<div class="entry">
				<p>在上一篇博文<a href="http://www.liuxuan.info/2011/01/04/java-anonymous-class/">关于Java内部类的一些问题</a>中提到在Stackoverflow上搜索答案时，有老外在答案中提到了Closure（&#8221;闭包&#8221;）这个词，而这篇博文中就是关于闭包的。</p>
<p>我们先来看一下维基上给出的关于闭包的解释：</p>
<blockquote><p>In computer science, a <strong>closure</strong> is a <a href="http://en.wikipedia.org/wiki/First-class_function">first-class function</a> with <a href="http://en.wikipedia.org/wiki/Free_variables">free variables</a> that are bound in the <a href="http://en.wikipedia.org/wiki/Lexical_environment">lexical environment</a>. Such a function is said to be &#8220;closed over&#8221; its free variables. A closure is defined within the scope of its free variables, and the extent of those variables is at least as long as the lifetime of the closure itself.</p></blockquote>
<p>第一次看这段英文的解释的时候很难搞懂他的意思，原因在于其中出现了较多第一次碰见的计算机编程领域的专业术语，如果不把这些专业术语搞明白的话整段话就自然而然搞不明白了（有朋友可能会说，你只要点击左侧边栏里的languages里的中文链接就能自动看中文版本的内容，而我想说的是中文版比英文版更看不明白XD）。</p>
<p>好了，我们来逐个看一下这些专业名词。首先第一个是first-class function，这个名词已经做成了超链接，点击一下就可以看到关于first-class function的详细解释，所以这里就不贴了。有一个与first-class function对应的名词是first-class object（第一类对象），维基上给出的解释是：第一类对象是个实体，它可以被当作函数的参数，可以从子程序中返回，可以赋值给变量。那么套用到first-class?function就是：如果某种函数可以作为参数传给其他函数，可以赋值给变量，可以被函数动态的创建和返回，那么这类函数被称为first-class function（第一类函数）。</p>
<p>看了这个定义后你可能会有这样一个疑问：在命令式编程语言中（例如Java），我们也可以把返回类型不是void的函数的调用作为另一个函数的参数传给他。其实在这个场景里，函数参数的类型还是基本类型或者引用类型，我们只是把原来的两行代码写在了一行里，真正传入的还是基本类型或者引用类型。而第一类函数可以作为参数传入另一个函数是指：可以在一段程序的执行过程中可以创建新的函数，可以在数据结构中保存新创建的函数，可以把这些新创建的函数作为参数传给其他函数，并且可以作为其他函数的返回值。也就是说其他函数可以把第一类函数（整个声明体或匿名）做为他的参数存在，这是和一般的命令式编程语言很大的区别（C#等混合语言除外）。</p>
<p>好了，上面只是文字上的解释，我们来看一下第一类函数的例子：</p>
<p>(1)第一类函数赋值给变量，这个函数的作用是对每个Int类型的值都加1（Scala）：</p>

<div class="wp_syntax"><div class="code"><pre class="scala" style="font-family: Consolas, Menlo, Monaco, Lucida Console, Liberation Mono, DejaVu Sans Mono, Bitstream Vera Sans Mono, Courier New, monospace, serif;"><span style="color: #0000ff; font-weight: bold;">var</span> increase <span style="color: #000080;">=</span> <span style="color: #F78811;">&#40;</span>x <span style="color: #000080;">:</span> Int<span style="color: #F78811;">&#41;</span> <span style="color: #000080;">=&gt;</span> x + <span style="color: #F78811;">1</span></pre></div></div>

<p>(2)第一类函数作为参数传给另一个函数，这个函数的作用是打印集合中的每个元素（Scala）：</p>

<div class="wp_syntax"><div class="code"><pre class="scala" style="font-family: Consolas, Menlo, Monaco, Lucida Console, Liberation Mono, DejaVu Sans Mono, Bitstream Vera Sans Mono, Courier New, monospace, serif;">List.<span style="color: #000000;">foreach</span><span style="color: #F78811;">&#40;</span><span style="color: #F78811;">&#40;</span>x <span style="color: #000080;">:</span> Int<span style="color: #F78811;">&#41;</span> <span style="color: #000080;">=&gt;</span> println<span style="color: #F78811;">&#40;</span>x<span style="color: #F78811;">&#41;</span><span style="color: #F78811;">&#41;</span></pre></div></div>

<p>(3)第一类函数作为返回值，这个函数的作用是对x求导（C#）：</p>

<div class="wp_syntax"><div class="code"><pre class="java" style="font-family: Consolas, Menlo, Monaco, Lucida Console, Liberation Mono, DejaVu Sans Mono, Bitstream Vera Sans Mono, Courier New, monospace, serif;">using <span style="color: #003399;">System</span><span style="color: #339933;">;</span>
<span style="color: #7F0055; font-weight: bold;">class</span> Program
<span style="color: #009900;">&#123;</span>
    <span style="color: #666666; font-style: italic;font-style: normal;">// f: function that takes a double and returns a double</span>
    <span style="color: #666666; font-style: italic;font-style: normal;">// deltaX: small positive number</span>
    <span style="color: #666666; font-style: italic;font-style: normal;">// returns a function that is an approximate derivative of f</span>
    <span style="color: #7F0055; font-weight: bold;">static</span> Func＜<span style="color: #000066; font-weight: bold;">double</span> , <span style="color: #000066; font-weight: bold;">double</span>＞ MakeDerivative<span style="color: #009900;">&#40;</span>Func＜<span style="color: #000066; font-weight: bold;">double</span> , <span style="color: #000066; font-weight: bold;">double</span>＞ f, <span style="color: #000066; font-weight: bold;">double</span> deltaX<span style="color: #009900;">&#41;</span>
    <span style="color: #009900;">&#123;</span>
        <span style="color: #7F0055; font-weight: bold;">return</span> x <span style="color: #339933;">=&gt;</span> <span style="color: #009900;">&#40;</span>f<span style="color: #009900;">&#40;</span>x <span style="color: #339933;">+</span> deltaX<span style="color: #009900;">&#41;</span> <span style="color: #339933;">-</span> f<span style="color: #009900;">&#40;</span>x<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">/</span> deltaX<span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
    <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #000066; font-weight: bold;">void</span> Main<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>
    <span style="color: #009900;">&#123;</span>
        var cos <span style="color: #339933;">=</span> MakeDerivative<span style="color: #009900;">&#40;</span><span style="color: #003399;">Math</span>.<span style="color: #006633;">Sin</span>, <span style="color: #cc66cc;">0.00000001</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        Console.<span style="color: #006633;">WriteLine</span><span style="color: #009900;">&#40;</span>cos<span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">0</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #339933;">?</span> <span style="color: #339933;">?</span> <span style="color: #339933;">?</span> <span style="color: #339933;">?</span> <span style="color: #339933;">?</span> <span style="color: #339933;">?</span> <span style="color: #339933;">?</span> <span style="color: #339933;">?</span> <span style="color: #339933;">?</span> <span style="color: #339933;">?</span> <span style="color: #339933;">?</span> <span style="color: #339933;">?</span><span style="color: #666666; font-style: italic;font-style: normal;">// 1</span>
        Console.<span style="color: #006633;">WriteLine</span><span style="color: #009900;">&#40;</span>cos<span style="color: #009900;">&#40;</span><span style="color: #003399;">Math</span>.<span style="color: #006633;">PI</span> <span style="color: #339933;">/</span> <span style="color: #cc66cc;">2</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #339933;">?</span>        <span style="color: #666666; font-style: italic;font-style: normal;">// 0</span>
    <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span></pre></div></div>

<p>好了，到现在为止只搞明白了first-class function是个什么东西，下面一个是free variable（自由变量）。点击词汇上的超链接，维基给出的解释是：自由变量是一个函数中的变量，并且既没有在上下文声明过，也不是函数的参数，并且会在函数的创建执行过程中被特定的值替换。lexical environment的意思可以理解为变量的作用域。</p>
<p>现在我们可以来翻译这段关于闭包的解释了：</p>
<blockquote><p>闭包是第一类函数和自由变量绑定在作用域中，这种函数被称为“关闭”他的自由变量。闭包是被定义在他的自由变量的作用域中，并且这些自由变量的生命周期至少跟闭包本身的生命周期一样。</p></blockquote>
<p>因为闭包需要第一类函数和自由变量是函数式编程语言必须的要素，所以闭包更多的是在函数式编程语言中应用（JavaScript除外）。而Java不支持第一类函数，所以Java目前还不支持闭包（至少目前不支持，以后不好说）。但是我们在Java中可以模拟闭包（但是并不是真正的闭包，因为Java不支持上述所说的第一类函数），依靠内部类具有外部类引用的特性来模拟：</p>

<div class="wp_syntax"><div class="code"><pre class="java" style="font-family: Consolas, Menlo, Monaco, Lucida Console, Liberation Mono, DejaVu Sans Mono, Bitstream Vera Sans Mono, Courier New, monospace, serif;"><span style="color: #7F0055; font-weight: bold;">final</span> User user <span style="color: #339933;">=</span> <span style="color: #7F0055; font-weight: bold;">new</span> User<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #7F0055; font-weight: bold;">new</span> AbstractExecutionThreadService<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    @Override
    <span style="color: #7F0055; font-weight: bold;">protected</span> <span style="color: #000066; font-weight: bold;">void</span> run<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #003399;">Exception</span> <span style="color: #009900;">&#123;</span>
    mailManager.<span style="color: #006633;">sendActivateMail</span><span style="color: #009900;">&#40;</span>user<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span>.<span style="color: #006633;">start</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre></div></div>

<p>其实关于Java引入闭包的争论由来已久，几个月之前有消息说在JDK 7中将支持lamda表达式，并且我也在一些网站上看过语法的示例。但是看过后就感觉，即使把那些蛋疼的语法加入到Java中去，是不是也会有蛋疼的程序员去用？如果蛋疼的程序员写了蛋疼的代码，那读代码的人岂不是更蛋疼？</p>
<p>现在已经有很多OO和FP混合的语言，比如Scala,Ruby,Python，C#现在更是把动态语言的特性也引入进去。我想说是不是真的有必要这么做？以C#为例，Linq可以把几行的循环代码等价转换成只有一行代码，这确实提高了编码效率。但是从我的感受来说，如果大段的命令式代码中突然夹杂了几行函数式的代码有一种非常强烈的跳跃感，除非你对命令式和函数式语言都非常的熟悉。</p>
<p>语言之争（或者平台之争）一直是在激烈的持续着，这种情况下有点像冷战思维也不觉得奇怪，但是我觉得Java没必要跟C#学，C#想把自己变成一把瑞士军刀，但是，我们日常生活中有多少机会会用到这把功能虽多但很难用的刀呢？</p>
			</div>
		
		</div>

	
<!-- You can start editing here. -->
<div id="commentssection">


			<!-- If comments are closed. -->
		<p class="nocomments">Comments are closed.</p>

	


</div>
	
	</div>

<div id="sidebar">
<ul>
<h2>Search</h2><form method="get" id="searchform" action="http://liuxuan.info/">

<table cellpadding="0" cellspacing="0" style="width:200px; height:32px;"><tbody><tr id="WLSearchBoxPlaceholder"><td style="width:100%; border:solid 1px #cccccc; border-right-style:none;  padding-right:10px; vertical-align:middle;"><input id="WLSearchBoxInput" type="text"  style="background-image:url(http://www.bing.com/siteowner/s/siteowner/searchbox_background_k.png); background-position:right; background-repeat:no-repeat; font-family:Arial; font-size:14px; color:#000000; width:100%; border:none 0 transparent;" autocomplete="off" maxlength="200"></td><td style="border:solid 1px #cccccc; border-left-style:none; padding-left:0px; padding-right:3px;"><input id="WLSearchBoxButton" type="image" src="http://www.bing.com/siteowner/s/siteowner/searchbutton_normal_k.gif" style="border:none 0 transparent; height:24px; width:24px; vertical-align:top;"></td></tr></tbody></table>
</form>				<h2>Recent Posts</h2>		<ul>
				<li><a href="http://liuxuan.info/2011/06/01/comparison-of-nosql-databases/" title="Comparison of NoSQL databases">Comparison of NoSQL databases</a></li>
				<li><a href="http://liuxuan.info/2011/06/01/guide-to-open-source-licenses/" title="Guide to open source licenses">Guide to open source licenses</a></li>
				<li><a href="http://liuxuan.info/2011/05/19/block-advertising-on-youku-and-tudou/" title="屏蔽优酷和土豆网的广告方法">屏蔽优酷和土豆网的广告方法</a></li>
				<li><a href="http://liuxuan.info/2011/05/14/the-best-timetable-for-health-in-the-world/" title="世界上最健康的作息时间表">世界上最健康的作息时间表</a></li>
				<li><a href="http://liuxuan.info/2011/05/10/facebooks-architecture/" title="Facebook&#8217;s architecture">Facebook&#8217;s architecture</a></li>
				<li><a href="http://liuxuan.info/2011/05/08/pragmatic-programmers-practices-of-an-agile-developer-notes/" title="《Pragmatic Programmers &#8211; Practices of an Agile Developer》读书笔记">《Pragmatic Programmers &#8211; Practices of an Agile Developer》读书笔记</a></li>
				<li><a href="http://liuxuan.info/2011/05/08/initialization-on-demand-holder-idiom/" title="Initialization on demand holder idiom">Initialization on demand holder idiom</a></li>
				<li><a href="http://liuxuan.info/2011/05/04/http-definitive-guide-notes/" title="《Http Definitive Guide》读书笔记">《Http Definitive Guide》读书笔记</a></li>
				<li><a href="http://liuxuan.info/2011/04/13/learn-invokeinterface-invokespecial-invokestatic-invokevirtual/" title="Java bytecode : invokeinterface , invokespecial , invokestatic &amp; invokevirtual 的含义和区别">Java bytecode : invokeinterface , invokespecial , invokestatic &#038; invokevirtual 的含义和区别</a></li>
				<li><a href="http://liuxuan.info/2011/03/08/java-memory-management/" title="JVM内存管理">JVM内存管理</a></li>
				</ul>
		<h2>Categories</h2>		<ul>
	<li class="cat-item cat-item-31"><a href="http://liuxuan.info/category/architecture/" title="View all posts filed under Architecture">Architecture</a> (1)
</li>
	<li class="cat-item cat-item-38"><a href="http://liuxuan.info/category/cool/" title="View all posts filed under Cool">Cool</a> (1)
</li>
	<li class="cat-item cat-item-39"><a href="http://liuxuan.info/category/database/" title="View all posts filed under Database">Database</a> (1)
</li>
	<li class="cat-item cat-item-23"><a href="http://liuxuan.info/category/http/" title="View all posts filed under Http">Http</a> (1)
</li>
	<li class="cat-item cat-item-14"><a href="http://liuxuan.info/category/ide/" title="View all posts filed under IDE">IDE</a> (1)
</li>
	<li class="cat-item cat-item-3"><a href="http://liuxuan.info/category/java/" title="View all posts filed under Java">Java</a> (7)
</li>
	<li class="cat-item cat-item-5"><a href="http://liuxuan.info/category/life/" title="View all posts filed under Life">Life</a> (2)
</li>
	<li class="cat-item cat-item-4"><a href="http://liuxuan.info/category/objective-c/" title="View all posts filed under Objective-C">Objective-C</a> (1)
</li>
	<li class="cat-item cat-item-40"><a href="http://liuxuan.info/category/opensource/" title="View all posts filed under Opensource">Opensource</a> (1)
</li>
	<li class="cat-item cat-item-28"><a href="http://liuxuan.info/category/programming/" title="View all posts filed under Programming">Programming</a> (1)
</li>
		</ul>
<h2>Archives</h2>		<ul>
			<li><a href='http://liuxuan.info/2011/06/' title='June 2011'>June 2011</a>&nbsp;(2)</li>
	<li><a href='http://liuxuan.info/2011/05/' title='May 2011'>May 2011</a>&nbsp;(6)</li>
	<li><a href='http://liuxuan.info/2011/04/' title='April 2011'>April 2011</a>&nbsp;(1)</li>
	<li><a href='http://liuxuan.info/2011/03/' title='March 2011'>March 2011</a>&nbsp;(8)</li>
		</ul>

</ul>

</div>

<div id="footer">

<!-- To help keep our themes 100% free, please consider leaving our credit links intact. Thanks! -->

<p>&copy; 2011 Zhixingheyi | Powered by <a href="http://wordpress.org/">WordPress</a> | Theme by <a href="http://liuxuan.info/" title="WordPress theme by Foredoomed">Foredoomed</a></p>

</div> <!-- end footer -->

</div> <!-- end container -->

<div align="center">
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/"><img alt="知识共享许可协议" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">知识共享署名-非商业性使用-相同方式共享 3.0 Unported许可协议</a>进行许可。
<div>
</body>
</html>
<!-- Dynamic page generated in 1.132 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2011-06-08 02:04:29 -->
<!-- super cache -->