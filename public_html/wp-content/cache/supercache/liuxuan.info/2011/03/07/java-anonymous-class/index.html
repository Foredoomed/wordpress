<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">

<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<title>为什么Java匿名内部类中的方法参数必须定义为final — Zhixingheyi</title>

<link rel="stylesheet" href="http://liuxuan.info/wp-content/themes/uncomplicated/style.css" type="text/css" media="screen" />
<link rel="pingback" href="http://liuxuan.info/xmlrpc.php" />



<link rel='stylesheet' id='wp-pagenavi-css'  href='http://liuxuan.info/wp-content/plugins/wp-pagenavi/pagenavi-css.css?ver=2.70' type='text/css' media='all' />
<script type='text/javascript' src='http://liuxuan.info/wp-includes/js/l10n.js?ver=20101110'></script>
<script type='text/javascript' src='http://liuxuan.info/wp-includes/js/comment-reply.js?ver=20090102'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://liuxuan.info/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://liuxuan.info/wp-includes/wlwmanifest.xml" /> 
<link rel='index' title='Zhixingheyi' href='http://liuxuan.info/' />
<link rel='start' title='为什么Java匿名内部类中的方法参数必须定义为final' href='http://liuxuan.info/2011/03/07/java-anonymous-class/' />
<link rel='next' title='闭包及其在Java中的模拟实现' href='http://liuxuan.info/2011/03/07/%e9%97%ad%e5%8c%85%e5%8f%8a%e5%85%b6%e5%9c%a8java%e4%b8%ad%e7%9a%84%e6%a8%a1%e6%8b%9f%e5%ae%9e%e7%8e%b0/' />
<meta name="generator" content="WordPress 3.1.2" />
<link rel='shortlink' href='http://liuxuan.info/?p=31' />

<!-- All in One SEO Pack 1.6.13.2 by Michael Torbert of Semper Fi Web Design[307,401] -->
<meta name="description" content="从字节码分析研究为什么在匿名内部类中的方法参数必须定义为final" />
<meta name="keywords" content="java,inner class,anonymous inner class" />
<link rel="canonical" href="http://liuxuan.info/2011/03/07/java-anonymous-class/" />
<!-- /all in one seo pack -->

<!-- Bad Behavior 2.0.43 run time: 4.283 ms -->
<script type="text/javascript">
<!--
function bb2_addLoadEvent(func) {
	var oldonload = window.onload;
	if (typeof window.onload != 'function') {
		window.onload = func;
	} else {
		window.onload = function() {
			oldonload();
			func();
		}
	}
}

bb2_addLoadEvent(function() {
	for ( i=0; i < document.forms.length; i++ ) {
		if (document.forms[i].method == 'post') {
			var myElement = document.createElement('input');
			myElement.setAttribute('type', 'hidden');
			myElement.name = 'bb2_screener_';
			myElement.value = '1306200156 122.130.137.216';
			document.forms[i].appendChild(myElement);
		}
	}
});
// --></script>
		
<link rel="stylesheet" href="http://liuxuan.info/wp-content/plugins/wp-syntax/wp-syntax.css" type="text/css" media="screen" />
</head>

<body>

<div id="container">


<div id="header">
	<h1><a href="http://liuxuan.info/">Zhixingheyi</a></h1>
		<div class="border"></div>
	<h2>Where the truth distortion is.</h2>
</div>
	

<div id="menuholder">
		<div class="menu">
			<div class="page-navi"><ul><li ><a href="http://liuxuan.info/" title="Home">Home</a></li><li class="page_item page-item-41"><a href="http://liuxuan.info/about/" title="About">About</a></li><li class="page_item page-item-110"><a href="http://liuxuan.info/programmer-competency-matrix/" title="Programmer Competency Matrix">Programmer Competency Matrix</a></li></ul></div>
		</div>

		
</div>
	<div id="content">

	
		<div class="post-31 post type-post status-publish format-standard hentry category-java tag-anonymous-inner-class tag-java" id="post-31">
			<h2><a href="http://liuxuan.info/2011/03/07/java-anonymous-class/" rel="bookmark" title="Permanent Link: 为什么Java匿名内部类中的方法参数必须定义为final">为什么Java匿名内部类中的方法参数必须定义为final</a></h2>
			<div class="postmetadata"><p>Posted on March 7th, 2011 under <a href="http://liuxuan.info/category/java/" title="View all posts in Java" rel="category tag">Java</a></p></div>
	
			<div class="entry">
				<p>今天在做一个功能，就是用户在注册后给他发送帐号激活邮件。在做这个功能的时候，我用匿名内部类来创建一个线程发送激活邮件，代码如下：</p>

<div class="wp_syntax"><div class="code"><pre class="java" style="font-family: Consolas, Menlo, Monaco, Lucida Console, Liberation Mono, DejaVu Sans Mono, Bitstream Vera Sans Mono, Courier New, monospace, serif;">&nbsp;
@Controller<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>
@RequestMapping<span style="color: #009900;">&#40;</span>value <span style="color: #339933;">=</span>  <span style="color: #0000ff;">&quot;/users&quot;</span><span style="color: #009900;">&#41;</span>
<span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> UserController <span style="color: #009900;">&#123;</span>
&nbsp;
@Autowired
<span style="color: #7F0055; font-weight: bold;">private</span> MailManager  mailManager<span style="color: #339933;">;</span>
&nbsp;
<span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> setMailManager<span style="color: #009900;">&#40;</span>MailManager  mailManager<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #7F0055; font-weight: bold;">this</span>.<span style="color: #006633;">mailManager</span> <span style="color: #339933;">=</span> mailManager<span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span>
&nbsp;
@RequestMapping<span style="color: #009900;">&#40;</span>method <span style="color: #339933;">=</span>  RequestMethod.<span style="color: #006633;">POST</span><span style="color: #009900;">&#41;</span>
<span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #003399;">String</span>  doingSignUp<span style="color: #009900;">&#40;</span>@RequestParam<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;user_email_address&quot;</span><span style="color: #009900;">&#41;</span> <span style="color: #003399;">String</span> user_email_address,  @RequestParam<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;user_password&quot;</span><span style="color: #009900;">&#41;</span> <span style="color: #003399;">String</span> user_password, @RequestParam<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;user_name&quot;</span><span style="color: #009900;">&#41;</span>  <span style="color: #003399;">String</span> user_name<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
&nbsp;
<span style="color: #7F0055; font-weight: bold;">try</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #666666; font-style: italic;font-style: normal;">//用户注册代码省略</span>
    <span style="color: #7F0055; font-weight: bold;">new</span> AbstractExecutionThreadService<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    @Override
    <span style="color: #7F0055; font-weight: bold;">protected</span> <span style="color: #000066; font-weight: bold;">void</span> run<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #003399;">Exception</span> <span style="color: #009900;">&#123;</span>
    mailManager.<span style="color: #006633;">sendActivateMail</span><span style="color: #009900;">&#40;</span>user<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><span style="color: #666666; font-style: italic;font-style: normal;">//发送邮件</span>
<span style="color: #009900;">&#125;</span><span style="color: #009900;">&#125;</span>.<span style="color: #006633;">start</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span> <span style="color: #7F0055; font-weight: bold;">catch</span> <span style="color: #009900;">&#40;</span><span style="color: #003399;">Exception</span> e<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    e.<span style="color: #006633;">printStackTrace</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span>
    <span style="color: #7F0055; font-weight: bold;">return</span> <span style="color: #0000ff;">&quot;index&quot;</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span></pre></div></div>

<p>MVC框架用的是Spring  MVC，这个框架以后还会写一些关于他的文章（从我目前使用过的MVC框架对比来看，Spring  MVC是我认为的使用起来最舒服的框架，至于和Struts比较的话，就仁者见仁，智者见智了）。创建多线程的时候使用了Google的<a title="guava-libraries" href="http://code.google.com/p/guava-libraries/">guava-libraries</a>工具包里的多线程类来创建多线程（以后还会写一些关于这个工具包的文章）。从代码中可以看到，AbstractExecutionThreadService是抽象类，在里面重写了run方法，run方法里面就是干一件事就是发送邮件。那么到这里就有一个问题了，由于sendActivateMail这个方法需要一个User类作为参数，而因为这个发送邮件的方法是在匿名内部类的里面，所以这个User类必须：(1)作为UserController类的实例变量，或者(2)在doingSignUp方法中把User类定义为final的局部变量。</p>
<p>一般在写Web程序的时候碰到类的实例变量的时候我们就因该当心多线程问题了，这里也是一样。由于Spring  MVC里的Controller类不是线程安全的，所以第一种把User类定义为UserController类的实例变量的方法就不能用了，那么剩下就只有用第二种方法：把User类定义为final。到这里第二个问题来了，这个问题是我以前没有想过的，为什么匿名内部类里的方法参数只能是final的。</p>
<p>在《Core Java 8th Editon》里是这么说的：<strong>A local variable  that is declared final cannot be modified after it has been initialized. Thus,  it is guaranteed that the local variable and the copy that is made inside the  local class always have the same value</strong>.  这句话是在介绍局部内部类的时候说的，用到匿名内部类上是一样的。简单的两句话只说了局部变量要和和他的拷贝要保持一致，但为什么要保持一致没有说。在stackoverflow上搜索了一下，发现了这个帖子：<a href="http://stackoverflow.com/questions/3910324?tab=active#tab-top">Why inner  classes require &#8220;final&#8221; outer instance variables?</a> 在这个帖子里还提到了另一个词：&#8221;Closures&#8221;（闭包），有兴趣的读者可以去看一下关于闭包的内容，这里只给出<a href="http://en.wikipedia.org/wiki/Closure_(computer_science)">维基百科上关于闭包的解释</a>。在这个帖子里又一次提到了为了防止在匿名内部类中的方法执行之前改变外部类局部变量的值，避免一些不可预测（奇怪）的问题，必须把外部类的局部变量声明为final。</p>
<p>我们再来看一下class文件会发现，UserController类被编译成了两个class文件：UserController.class和UserController$1.class。其中UserController.class还是本来的类，而UserController$1.class则是匿名内部类。我们用javap  -private classname命令来看一下这两个class文件里面都有些什么。</p>
<p>UserController.class：</p>

<div class="wp_syntax"><div class="code"><pre class="java" style="font-family: Consolas, Menlo, Monaco, Lucida Console, Liberation Mono, DejaVu Sans Mono, Bitstream Vera Sans Mono, Courier New, monospace, serif;">&nbsp;
D<span style="color: #339933;">:</span>\<span style="color: #339933;">&gt;</span>javap <span style="color: #339933;">-</span><span style="color: #7F0055; font-weight: bold;">private</span> UserController
Compiled from  <span style="color: #0000ff;">&quot;UserController.java&quot;</span>
<span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> info.<span style="color: #006633;">liuxuan</span>.<span style="color: #006633;">controller</span>.<span style="color: #006633;">UserController</span>  <span style="color: #7F0055; font-weight: bold;">extends</span> java.<span style="color: #006633;">lang</span>.<span style="color: #003399;">Object</span><span style="color: #009900;">&#123;</span>
<span style="color: #7F0055; font-weight: bold;">private</span> info.<span style="color: #006633;">liuxuan</span>.<span style="color: #006633;">mail</span>.<span style="color: #006633;">MailManager</span> mailManager<span style="color: #339933;">;</span>
<span style="color: #7F0055; font-weight: bold;">public</span> info.<span style="color: #006633;">liuxuan</span>.<span style="color: #006633;">controller</span>.<span style="color: #006633;">UserController</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span>  setMailManager<span style="color: #009900;">&#40;</span>info.<span style="color: #006633;">liuxuan</span>.<span style="color: #006633;">mail</span>.<span style="color: #006633;">MailManager</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #7F0055; font-weight: bold;">public</span> java.<span style="color: #006633;">lang</span>.<span style="color: #003399;">String</span>  doingSignUp<span style="color: #009900;">&#40;</span>java.<span style="color: #006633;">lang</span>.<span style="color: #003399;">String</span>, java.<span style="color: #006633;">lang</span>.<span style="color: #003399;">String</span>, java.<span style="color: #006633;">lang</span>.<span style="color: #003399;">String</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #7F0055; font-weight: bold;">static</span>  info.<span style="color: #006633;">liuxuan</span>.<span style="color: #006633;">mail</span>.<span style="color: #006633;">MailManager</span> access$0<span style="color: #009900;">&#40;</span>info.<span style="color: #006633;">liuxuan</span>.<span style="color: #006633;">controller</span>.<span style="color: #006633;">UserController</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span></pre></div></div>

<p>UserController$1.class：</p>

<div class="wp_syntax"><div class="code"><pre class="java" style="font-family: Consolas, Menlo, Monaco, Lucida Console, Liberation Mono, DejaVu Sans Mono, Bitstream Vera Sans Mono, Courier New, monospace, serif;">&nbsp;
D<span style="color: #339933;">:</span>\<span style="color: #339933;">&gt;</span>javap <span style="color: #339933;">-</span><span style="color: #7F0055; font-weight: bold;">private</span> UserController$1
Compiled from  <span style="color: #0000ff;">&quot;UserController.java&quot;</span>
<span style="color: #7F0055; font-weight: bold;">class</span> info.<span style="color: #006633;">liuxuan</span>.<span style="color: #006633;">controller</span>.<span style="color: #006633;">UserController</span>$1 <span style="color: #7F0055; font-weight: bold;">extends</span>  com.<span style="color: #006633;">google</span>.<span style="color: #006633;">common</span>.<span style="color: #006633;">util</span>.<span style="color: #006633;">concurrent</span>.<span style="color: #006633;">AbstractExecutionThreadService</span><span style="color: #009900;">&#123;</span>
<span style="color: #7F0055; font-weight: bold;">final</span>  info.<span style="color: #006633;">liuxuan</span>.<span style="color: #006633;">controller</span>.<span style="color: #006633;">UserController</span> <span style="color: #7F0055; font-weight: bold;">this</span>$0<span style="color: #339933;">;</span>
<span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #7F0055; font-weight: bold;">final</span>  info.<span style="color: #006633;">liuxuan</span>.<span style="color: #006633;">entity</span>.<span style="color: #006633;">User</span> val$user<span style="color: #339933;">;</span>
info.<span style="color: #006633;">liuxuan</span>.<span style="color: #006633;">controller</span>.<span style="color: #006633;">UserController</span>$1<span style="color: #009900;">&#40;</span>info.<span style="color: #006633;">liuxuan</span>.<span style="color: #006633;">controller</span>.<span style="color: #006633;">UserController</span>,  info.<span style="color: #006633;">liuxuan</span>.<span style="color: #006633;">entity</span>.<span style="color: #006633;">User</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #7F0055; font-weight: bold;">protected</span> <span style="color: #000066; font-weight: bold;">void</span> run<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> java.<span style="color: #006633;">lang</span>.<span style="color: #003399;">Exception</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span></pre></div></div>

<p>我们可以清楚的看到在编译后的UserController$1.class中，User类已经变成了UserController$1的私有成员变量，并且通过构造方法来初始化。现在来看的话就可以理解为什么要保持一致了：构造方法传入外部类方法的局部变量，如果在内部类方法执行之前改变的话将发生与预想不同的结果。</p>
<p>也许你已经注意到了，在UserController.class中的access$0方法被定义成了static，为什么被定义为static的呢？为了不被其他子类重写。</p>
			</div>
		
		</div>

	
<!-- You can start editing here. -->
<div id="commentssection">


			<!-- If comments are closed. -->
		<p class="nocomments">Comments are closed.</p>

	


</div>
	
	</div>

<div id="sidebar">
<ul>
<h2>Search</h2><form method="get" id="searchform" action="http://liuxuan.info/">

<table cellpadding="0" cellspacing="0" style="width:200px; height:32px;"><tbody><tr id="WLSearchBoxPlaceholder"><td style="width:100%; border:solid 1px #cccccc; border-right-style:none;  padding-right:10px; vertical-align:middle;"><input id="WLSearchBoxInput" type="text"  style="background-image:url(http://www.bing.com/siteowner/s/siteowner/searchbox_background_k.png); background-position:right; background-repeat:no-repeat; font-family:Arial; font-size:14px; color:#000000; width:100%; border:none 0 transparent;" autocomplete="off" maxlength="200"></td><td style="border:solid 1px #cccccc; border-left-style:none; padding-left:0px; padding-right:3px;"><input id="WLSearchBoxButton" type="image" src="http://www.bing.com/siteowner/s/siteowner/searchbutton_normal_k.gif" style="border:none 0 transparent; height:24px; width:24px; vertical-align:top;"></td></tr></tbody></table>
</form>				<h2>Recent Posts</h2>		<ul>
				<li><a href="http://liuxuan.info/2011/05/19/block-advertising-on-youku-and-tudou/" title="屏蔽优酷和土豆网的广告方法">屏蔽优酷和土豆网的广告方法</a></li>
				<li><a href="http://liuxuan.info/2011/05/14/the-best-timetable-for-health-in-the-world/" title="世界上最健康的作息时间表">世界上最健康的作息时间表</a></li>
				<li><a href="http://liuxuan.info/2011/05/10/facebooks-architecture/" title="Facebook&#8217;s architecture">Facebook&#8217;s architecture</a></li>
				<li><a href="http://liuxuan.info/2011/05/08/pragmatic-programmers-practices-of-an-agile-developer-notes/" title="《Pragmatic Programmers &#8211; Practices of an Agile Developer》读书笔记">《Pragmatic Programmers &#8211; Practices of an Agile Developer》读书笔记</a></li>
				<li><a href="http://liuxuan.info/2011/05/08/initialization-on-demand-holder-idiom/" title="Initialization on demand holder idiom">Initialization on demand holder idiom</a></li>
				<li><a href="http://liuxuan.info/2011/05/04/http-definitive-guide-notes/" title="《Http Definitive Guide》读书笔记">《Http Definitive Guide》读书笔记</a></li>
				<li><a href="http://liuxuan.info/2011/04/13/learn-invokeinterface-invokespecial-invokestatic-invokevirtual/" title="Java bytecode : invokeinterface , invokespecial , invokestatic &amp; invokevirtual 的含义和区别">Java bytecode : invokeinterface , invokespecial , invokestatic &#038; invokevirtual 的含义和区别</a></li>
				<li><a href="http://liuxuan.info/2011/03/08/java-memory-management/" title="JVM内存管理">JVM内存管理</a></li>
				<li><a href="http://liuxuan.info/2011/03/07/optimize-myeclipse/" title="MyEclipse优化实例">MyEclipse优化实例</a></li>
				<li><a href="http://liuxuan.info/2011/03/07/java-doubt-and-traps/" title="Java常见疑惑和陷阱">Java常见疑惑和陷阱</a></li>
				</ul>
		<h2>Categories</h2>		<ul>
	<li class="cat-item cat-item-31"><a href="http://liuxuan.info/category/architecture/" title="View all posts filed under Architecture">Architecture</a> (1)
</li>
	<li class="cat-item cat-item-38"><a href="http://liuxuan.info/category/cool/" title="View all posts filed under Cool">Cool</a> (1)
</li>
	<li class="cat-item cat-item-23"><a href="http://liuxuan.info/category/http/" title="View all posts filed under Http">Http</a> (1)
</li>
	<li class="cat-item cat-item-14"><a href="http://liuxuan.info/category/ide/" title="View all posts filed under IDE">IDE</a> (1)
</li>
	<li class="cat-item cat-item-3"><a href="http://liuxuan.info/category/java/" title="View all posts filed under Java">Java</a> (7)
</li>
	<li class="cat-item cat-item-5"><a href="http://liuxuan.info/category/life/" title="View all posts filed under Life">Life</a> (2)
</li>
	<li class="cat-item cat-item-4"><a href="http://liuxuan.info/category/objective-c/" title="View all posts filed under Objective-C">Objective-C</a> (1)
</li>
	<li class="cat-item cat-item-28"><a href="http://liuxuan.info/category/programming/" title="View all posts filed under Programming">Programming</a> (1)
</li>
		</ul>
<h2>Archives</h2>		<ul>
			<li><a href='http://liuxuan.info/2011/05/' title='May 2011'>May 2011</a>&nbsp;(6)</li>
	<li><a href='http://liuxuan.info/2011/04/' title='April 2011'>April 2011</a>&nbsp;(1)</li>
	<li><a href='http://liuxuan.info/2011/03/' title='March 2011'>March 2011</a>&nbsp;(8)</li>
		</ul>

</ul>

</div>

<div id="footer">

<!-- To help keep our themes 100% free, please consider leaving our credit links intact. Thanks! -->

<p>&copy; 2011 Zhixingheyi | Powered by <a href="http://wordpress.org/">WordPress</a> | Theme by <a href="http://liuxuan.info/" title="WordPress theme by Foredoomed">Foredoomed</a></p>

</div> <!-- end footer -->

</div> <!-- end container -->

<div align="center">
<a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/"><img alt="知识共享许可协议" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" /></a><br />本站作品采用<a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">知识共享署名-相同方式共享 3.0 Unported许可协议</a>进行许可。
<div>
</body>
</html>
<!-- Dynamic page generated in 0.440 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2011-05-24 01:22:36 -->
<!-- super cache -->