<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">

<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<title>JVM内存管理 — Zhixingheyi</title>

<link rel="stylesheet" href="http://liuxuan.info/wp-content/themes/uncomplicated/style.css" type="text/css" media="screen" />
<link rel="pingback" href="http://liuxuan.info/xmlrpc.php" />



<link rel='stylesheet' id='wp-pagenavi-css'  href='http://liuxuan.info/wp-content/plugins/wp-pagenavi/pagenavi-css.css?ver=2.70' type='text/css' media='all' />
<script type='text/javascript' src='http://liuxuan.info/wp-includes/js/l10n.js?ver=20101110'></script>
<script type='text/javascript' src='http://liuxuan.info/wp-includes/js/comment-reply.js?ver=20090102'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://liuxuan.info/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://liuxuan.info/wp-includes/wlwmanifest.xml" /> 
<link rel='index' title='Zhixingheyi' href='http://liuxuan.info/' />
<link rel='start' title='为什么Java匿名内部类中的方法参数必须定义为final' href='http://liuxuan.info/2011/03/07/java-anonymous-class/' />
<link rel='prev' title='MyEclipse优化实例' href='http://liuxuan.info/2011/03/07/optimize-myeclipse/' />
<link rel='next' title='Java bytecode : invokeinterface , invokespecial , invokestatic &amp; invokevirtual 的含义和区别' href='http://liuxuan.info/2011/04/13/learn-invokeinterface-invokespecial-invokestatic-invokevirtual/' />
<meta name="generator" content="WordPress 3.1.2" />
<link rel='shortlink' href='http://liuxuan.info/?p=54' />

<!-- All in One SEO Pack 1.6.13.2 by Michael Torbert of Semper Fi Web Design[307,350] -->
<meta name="description" content="JVM的内存模型,GC工作方式,GC调优" />
<meta name="keywords" content="jvm,gc tuning,java" />
<link rel="canonical" href="http://liuxuan.info/2011/03/08/java-memory-management/" />
<!-- /all in one seo pack -->

<!-- Bad Behavior 2.0.43 run time: 2.897 ms -->
<script type="text/javascript">
<!--
function bb2_addLoadEvent(func) {
	var oldonload = window.onload;
	if (typeof window.onload != 'function') {
		window.onload = func;
	} else {
		window.onload = function() {
			oldonload();
			func();
		}
	}
}

bb2_addLoadEvent(function() {
	for ( i=0; i < document.forms.length; i++ ) {
		if (document.forms[i].method == 'post') {
			var myElement = document.createElement('input');
			myElement.setAttribute('type', 'hidden');
			myElement.name = 'bb2_screener_';
			myElement.value = '1306228767 72.14.194.49 60.247.93.190';
			document.forms[i].appendChild(myElement);
		}
	}
});
// --></script>
		
<link rel="stylesheet" href="http://liuxuan.info/wp-content/plugins/wp-syntax/wp-syntax.css" type="text/css" media="screen" />
</head>

<body>

<div id="container">


<div id="header">
	<h1><a href="http://liuxuan.info/">Zhixingheyi</a></h1>
		<div class="border"></div>
	<h2>Where the truth distortion is.</h2>
</div>
	

<div id="menuholder">
		<div class="menu">
			<div class="page-navi"><ul><li ><a href="http://liuxuan.info/" title="Home">Home</a></li><li class="page_item page-item-41"><a href="http://liuxuan.info/about/" title="About">About</a></li><li class="page_item page-item-110"><a href="http://liuxuan.info/programmer-competency-matrix/" title="Programmer Competency Matrix">Programmer Competency Matrix</a></li></ul></div>
		</div>

		
</div>
	<div id="content">

	
		<div class="post-54 post type-post status-publish format-standard hentry category-java tag-gc-tuning tag-java tag-jvm" id="post-54">
			<h2><a href="http://liuxuan.info/2011/03/08/java-memory-management/" rel="bookmark" title="Permanent Link: JVM内存管理">JVM内存管理</a></h2>
			<div class="postmetadata"><p>Posted on March 8th, 2011 under <a href="http://liuxuan.info/category/java/" title="View all posts in Java" rel="category tag">Java</a></p></div>
	
			<div class="entry">
				<p><strong>一.Java基本类型和类的大小</strong></p>
<p>1.Java手册上的类型大小<br />
byte : 8-bit<br />
short : 16-bit<br />
Int : 32-bit<br />
long : 64-bit<br />
char : 16 bit unsigned integer<br />
float : 32-bit<br />
double: 64-bit<br />
boolean: 1-bit                             </p>
<p>2.实际存储大小(根据JVM实现而定)<br />
Byte : 16 bytes<br />
Short : 16 bytes<br />
Integer : 16 bytes<br />
Long : 16 bytes<br />
Character : 16 bytes<br />
Float : 16 bytes<br />
Double : 16 bytes<br />
Boolean : 16 bytes<br />
Object ：8 bytes</p>
<p><strong>二.JVM的堆结构</strong></p>
<p><a href="http://www.flickr.com/photos/60110479@N08/5504939947/" title="Flickr 上 Foredoomed 的 JVMHeapStructure"><img src="http://farm6.static.flickr.com/5136/5504939947_19ed9a8dbc.jpg" width="500" height="330" alt="JVMHeapStructure" /></a></p>
<p>运行时数据区域，所有类实例和数组的内存均从此处分配，由Java 虚拟机启动时创建。对象的堆内存由称为垃圾回收器 的自动内存管理系统回收。<br />
堆由两部分组成:</p>
<p>    Eden+From Space+To Space也叫做Young Generation(年轻代),Tenured Space也叫做Old Generation(老年代)。</p>
<p>    Survivor Space包括S0和S1。</p>
<p>    Permanent Space(方法区)： JVM具有一个由所有线程共享的方法区。它存储每个类结构，如运行时常数池、字段和方法 数据，以及方法和构造方法的代码，它是在 Java 虚拟机启动时创建的，不包括在JVM堆内，默认为4M。<br />
    这个区域主要存放：<br />
    1.Class的信息<br />
       Package Name<br />
       Super class package name<br />
       Class or interface<br />
       Type modifiers<br />
       Super inferface package name</p>
<p>    2.其它信息<br />
       The constant pool for the type<br />
       Field information<br />
       Method information<br />
       All class (static) variables declared in the type, except constants<br />
       A reference to class ClassLoader<br />
       A reference to class Class</p>
<p><strong>三.GC的工作流程</strong></p>
<p>1. 绝大多数情况下对象初始化被分配在 Eden 中。 (一个非常大的对象会被分配在老年代中)<br />
2. 如果 Eden 空间占满了， 会触发 minor GC。 Minor GC 后仍然存活的对象会被复制到 S0 中去。这样 Eden 就被清空可以    分配给新的对象。<br />
3. 又触发了一次 Minor GC ， S0 和 Eden 中存活的对象被复制到 S1 中， 并且 S0 和 Eden 被清空。 在同一时刻, 只有 Eden 和一个 Survivor Space 同时被操作。<br />
4. 当每次对象从 Eden 复制到 Survivor Space 或者从 Survivor Space 中的一个复制到另外一个，有一个计数器会自动增加值。 默认情况下如果复制发生超过16次， JVM 会停止复制并把他们移到老年代中去。<br />
5. 如果一个对象不能在 Eden 中被创建，它会直接被创建在老年代中。 如果老年代的空间被占满会触发老年代的 GC，也被称为 Full GC。full GC 是一个压缩处理过程，所以它比 Minor GC 要慢很多。</p>
<p><strong>四.GC算法</strong></p>
<p>1. Serial Collector<br />
大部分平台或者强制 java -client 默认会使用这种。<br />
Young Generation  = Serial<br />
Old Generation  = Serial (Mark-Sweep-Compact)<br />
这种方法的缺点很明显，Stop-the-world, 速度慢。服务器应用不推荐使用。</p>
<p>2. Parallel Collector<br />
在Linux x64上默认是这种算法，其他平台要加 java -server 参数。<br />
Young Generation = parallel，多个thread同时copy<br />
Old Generation = Mark-Sweep-Compact = 1<br />
优点：新生代回收更快。因为系统大部分时间做的GC都是新生代的，这样提高了Throughput(CPU用于非GC时间)。<br />
缺点：当运行在8G/16G Server 上 Old Generation 存活对象太多的时候暂停时间(Pause Time)过长。</p>
<p>3. Parallel Compacting Collector (ParallelOld)<br />
Young Generation = parallel<br />
Old Generation = parallel<br />
优点：Old Generation 上性能较 Parallel Collector 方式有提高。<br />
缺点：大部分Server系统Old Generation内存占用会达到60%-80%, Compact方面开销比起Parallel Collector并没明显减少。</p>
<p>4. Concurent Mark-Sweep(CMS) Collector (low-latency collector)<br />
Young Generation = parallel<br />
Old Generation = CMS<br />
同时不做 compact 操作。<br />
优点：Pause Time会降低, Pause Time敏感但CPU有空闲的场景需要建议使用策略4。<br />
缺点：CPU占用过多，CPU密集型服务器不适合。需要更大的堆空间，会造成很多碎片。</p>
<p><strong>五.JVM的默认设置</strong></p>
<p>1.堆 （heap）即（New Generation 和Old Generaion 之和）的设置</p>
<p>初始分配的内存由-Xms指定，默认是物理内存的1/64但小于1G。</p>
<p>最大分配的内存由-Xmx指定，默认是物理内存的1/4但小于1G。</p>
<p>默认空余堆内存小于40%时，JVM就会增大堆直到-Xmx的最大限制，可以由-XX:MinHeapFreeRatio指定。<br />
默认空余堆内存大于70%时，JVM会减少堆直到-Xms的最小限制，可以由-XX:MaxHeapFreeRatio指定。</p>
<p>服务器一般设置-Xms、-Xmx相等以避免在每次GC后调整堆的大小，所以上面的两个参数没啥用。 </p>
<p>      -Xmn 设置Young Generation的heap大小</p>
<p>      -XX:MinHeapFreeRatio与-XX:MaxHeapFreeRatio设定空闲内存占总内存的比例范围，这两个参数会影响GC的频率和单次GC的耗时。-XX:NewRatio决定Young与Old Generation的比例。Young generation空间越大，Minor GC频率越低，但是Old Generation空间小了，又可能导致Major GC频率增加。-XX:NewSize和-XX:MaxNewSize直接指定了Young Generation的缺省大小和最大大小。</p>
<p>2.非堆内存的设置</p>
<p>     默认分配为64M</p>
<p>     -XX:PermSize设置最小分配空间，-XX:MaxPermSize设置最大分配空间。一般把这两个数值设为相同，以减少申请内存空间的时间。</p>
<p><strong>六.GC调优</strong></p>
<p>GC调优例子：http://java.sun.com/docs/hotspot/gc1.4.2/example.html  </p>
<p>1. 设置Xms=Xmx=3/4物理内存，-Xmn为1/4的-Xmx值<br />
2. 如果是CPU密集型服务器，使用–XX:+UseParallelOldGC, 否则–XX:+UseConcMarkSweepGC<br />
3. 新生代,Parallel/ParallelOld可设大于Xmx1/4，CMS可设小，小于Xmx1/4<br />
4. 经验之谈：通常情况下，JVM堆的大小应为物理内存的80%</p>
<p><strong>七.Dump heap</strong></p>
<p>1.Linux下： jmap -dump:file=xxx.hprof pid，其中 pid 通过 ps -aux 命令查看</p>
<p>2.命令行: jstat -gcutil pid p1 p2，其中 p1 表示每多少毫秒打印一次；p2 表示一共打印几次。</p>
<p>   输出的参数含义：<br />
       S0：Heap上的 Survivor space 0 段已使用空间的百分比<br />
       S1：Heap上的 Survivor space 1 段已使用空间的百分比<br />
       E： Heap上的 Eden space 段已使用空间的百分比<br />
       O： Heap上的 Old space 段已使用空间的百分比<br />
       P： Perm space 已使用空间的百分比<br />
       YGC：从程序启动到采样时发生Young GC的次数<br />
       YGCT：Young GC所用的时间(单位秒)<br />
       FGC：从程序启动到采样时发生Full GC的次数<br />
       FGCT：Full GC所用的时间(单位秒)<br />
       GCT：用于垃圾回收的总时间(单位秒)</p>
<p>    jstat 命令其他参数含义：</p>
<p>        jstat -class pid:显示加载class的数量，及所占空间等信息。<br />
        jstat -compiler pid:显示VM实时编译的数量等信息。<br />
        jstat -gc pid:可以显示gc的信息，查看gc的次数，及时间。其中最后五项，分别是young gc的次数，young gc的时间，full gc的次数，full gc的时间，gc的总时间。<br />
        jstat -gccapacity:可以显示，VM内存中三代（young,old,perm）对象的使用和占用大小，如：PGCMN显示的是最小perm的内存使用量，PGCMX显示的是perm的内存最大使用量，PGC是当前新生成的perm内存占用量，PC是但前perm内存占用量。其他的可以根据这个类推， OC是old内纯的占用量。<br />
        jstat -gcnew pid:new对象的信息。<br />
        jstat -gcnewcapacity pid:new对象的信息及其占用量。<br />
        jstat -gcold pid:old对象的信息。<br />
        jstat -gcoldcapacity pid:old对象的信息及其占用量。<br />
        jstat -gcpermcapacity pid: perm对象的信息及其占用量。<br />
        jstat -util pid:统计gc信息统计。<br />
        jstat -printcompilation pid:当前VM执行的信息。 </p>
<p>3.GC Log  </p>
<p>  -Xloggc:d:\gc.log<br />
  -XX:+PrintGC<br />
  -XX:+PrintGCDetails<br />
  -XX:+PrintGCTimeStamps – add time stamp </p>
<p><strong>八.Out of Memory &#8211; java.lang.OutOfMemoryError</strong></p>
<p>1.Java heap space<br />
    Configuration issue: -Xmx<br />
Memory Leak<br />
    The excessive use of finalizers<br />
PermGen space<br />
    Too many classes: -XX:MaxPermSize<br />
Requested array size exceeds VM limit<br />
    Need a so big array?<br />
Request <size> bytes for <reason>. Out of swap space?<br />
    Native Memory Leak?<br />
</reason><reason> <stack trace> (Native method)<br />
    Native Memory Allocation Issue </p>
<p>2.Perm Memory Leak</p>
<p>Too Many Interned String</p>
<ul>
<li>String.intern()</li>
<li>Constant String will be interned implicitly</li>
<li>No Enough Info provided by Heap Dump on Interned String</li>
<li>If Perm Memory increased dynamically, be careful</li>
</ul>
<p>Too Many Classes or Class Load Leak<br />
    Enlarge the perm generation<br />
    Avoid duplicated class loader</p>
<p>3.Out of Swap Space</p>
<ul>
<li>Enlarge the swap space</li>
<li>Systems with 4GB of ram or less require a minimum of 2GB of swap space</li>
<li>Systems with 4GB to 16GB of ram require a minimum of 4GB of swap space </li>
<li>For Unix Family OS, use pmdump or pmap, libumem for Solaris</li>
</ul>
<p></stack></reason></size></p>
			</div>
		
		</div>

	
<!-- You can start editing here. -->
<div id="commentssection">


			<!-- If comments are closed. -->
		<p class="nocomments">Comments are closed.</p>

	


</div>
	
	</div>

<div id="sidebar">
<ul>
<h2>Search</h2><form method="get" id="searchform" action="http://liuxuan.info/">

<table cellpadding="0" cellspacing="0" style="width:200px; height:32px;"><tbody><tr id="WLSearchBoxPlaceholder"><td style="width:100%; border:solid 1px #cccccc; border-right-style:none;  padding-right:10px; vertical-align:middle;"><input id="WLSearchBoxInput" type="text"  style="background-image:url(http://www.bing.com/siteowner/s/siteowner/searchbox_background_k.png); background-position:right; background-repeat:no-repeat; font-family:Arial; font-size:14px; color:#000000; width:100%; border:none 0 transparent;" autocomplete="off" maxlength="200"></td><td style="border:solid 1px #cccccc; border-left-style:none; padding-left:0px; padding-right:3px;"><input id="WLSearchBoxButton" type="image" src="http://www.bing.com/siteowner/s/siteowner/searchbutton_normal_k.gif" style="border:none 0 transparent; height:24px; width:24px; vertical-align:top;"></td></tr></tbody></table>
</form>				<h2>Recent Posts</h2>		<ul>
				<li><a href="http://liuxuan.info/2011/05/19/block-advertising-on-youku-and-tudou/" title="屏蔽优酷和土豆网的广告方法">屏蔽优酷和土豆网的广告方法</a></li>
				<li><a href="http://liuxuan.info/2011/05/14/the-best-timetable-for-health-in-the-world/" title="世界上最健康的作息时间表">世界上最健康的作息时间表</a></li>
				<li><a href="http://liuxuan.info/2011/05/10/facebooks-architecture/" title="Facebook&#8217;s architecture">Facebook&#8217;s architecture</a></li>
				<li><a href="http://liuxuan.info/2011/05/08/pragmatic-programmers-practices-of-an-agile-developer-notes/" title="《Pragmatic Programmers &#8211; Practices of an Agile Developer》读书笔记">《Pragmatic Programmers &#8211; Practices of an Agile Developer》读书笔记</a></li>
				<li><a href="http://liuxuan.info/2011/05/08/initialization-on-demand-holder-idiom/" title="Initialization on demand holder idiom">Initialization on demand holder idiom</a></li>
				<li><a href="http://liuxuan.info/2011/05/04/http-definitive-guide-notes/" title="《Http Definitive Guide》读书笔记">《Http Definitive Guide》读书笔记</a></li>
				<li><a href="http://liuxuan.info/2011/04/13/learn-invokeinterface-invokespecial-invokestatic-invokevirtual/" title="Java bytecode : invokeinterface , invokespecial , invokestatic &amp; invokevirtual 的含义和区别">Java bytecode : invokeinterface , invokespecial , invokestatic &#038; invokevirtual 的含义和区别</a></li>
				<li><a href="http://liuxuan.info/2011/03/08/java-memory-management/" title="JVM内存管理">JVM内存管理</a></li>
				<li><a href="http://liuxuan.info/2011/03/07/optimize-myeclipse/" title="MyEclipse优化实例">MyEclipse优化实例</a></li>
				<li><a href="http://liuxuan.info/2011/03/07/java-doubt-and-traps/" title="Java常见疑惑和陷阱">Java常见疑惑和陷阱</a></li>
				</ul>
		<h2>Categories</h2>		<ul>
	<li class="cat-item cat-item-31"><a href="http://liuxuan.info/category/architecture/" title="View all posts filed under Architecture">Architecture</a> (1)
</li>
	<li class="cat-item cat-item-38"><a href="http://liuxuan.info/category/cool/" title="View all posts filed under Cool">Cool</a> (1)
</li>
	<li class="cat-item cat-item-23"><a href="http://liuxuan.info/category/http/" title="View all posts filed under Http">Http</a> (1)
</li>
	<li class="cat-item cat-item-14"><a href="http://liuxuan.info/category/ide/" title="View all posts filed under IDE">IDE</a> (1)
</li>
	<li class="cat-item cat-item-3"><a href="http://liuxuan.info/category/java/" title="View all posts filed under Java">Java</a> (7)
</li>
	<li class="cat-item cat-item-5"><a href="http://liuxuan.info/category/life/" title="View all posts filed under Life">Life</a> (2)
</li>
	<li class="cat-item cat-item-4"><a href="http://liuxuan.info/category/objective-c/" title="View all posts filed under Objective-C">Objective-C</a> (1)
</li>
	<li class="cat-item cat-item-28"><a href="http://liuxuan.info/category/programming/" title="View all posts filed under Programming">Programming</a> (1)
</li>
		</ul>
<h2>Archives</h2>		<ul>
			<li><a href='http://liuxuan.info/2011/05/' title='May 2011'>May 2011</a>&nbsp;(6)</li>
	<li><a href='http://liuxuan.info/2011/04/' title='April 2011'>April 2011</a>&nbsp;(1)</li>
	<li><a href='http://liuxuan.info/2011/03/' title='March 2011'>March 2011</a>&nbsp;(8)</li>
		</ul>

</ul>

</div>

<div id="footer">

<!-- To help keep our themes 100% free, please consider leaving our credit links intact. Thanks! -->

<p>&copy; 2011 Zhixingheyi | Powered by <a href="http://wordpress.org/">WordPress</a> | Theme by <a href="http://liuxuan.info/" title="WordPress theme by Foredoomed">Foredoomed</a></p>

</div> <!-- end footer -->

</div> <!-- end container -->

<div align="center">
<a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/"><img alt="知识共享许可协议" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" /></a><br />本站作品采用<a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">知识共享署名-相同方式共享 3.0 Unported许可协议</a>进行许可。
<div>
</body>
</html>
<!-- Dynamic page generated in 0.424 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2011-05-24 09:19:28 -->
<!-- super cache -->