<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">
<head profile="http://gmpg.org/xfn/11">

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>  Zhixingheyi</title>

	<link rel="stylesheet" href="http://liuxuan.info/wp-content/themes/primepress/style.css" type="text/css" media="screen" />
	<link rel="stylesheet" href="http://liuxuan.info/wp-content/themes/primepress/custom.css" type="text/css" media="screen" />
	<!--[if lte IE 6]>	<link rel="stylesheet" type="text/css" href="http://liuxuan.info/wp-content/themes/primepress/library/ie6.css" /><![endif]-->
	<link rel="pingback" href="http://liuxuan.info/xmlrpc.php" />
	
	
	<link rel="alternate" type="application/rss+xml" title="Zhixingheyi &raquo; Feed" href="http://liuxuan.info/feed/" />
<link rel="alternate" type="application/rss+xml" title="Zhixingheyi &raquo; Comments Feed" href="http://liuxuan.info/comments/feed/" />
<link rel='stylesheet' id='wp-pagenavi-css'  href='http://liuxuan.info/wp-content/plugins/wp-pagenavi/pagenavi-css.css?ver=2.70' type='text/css' media='all' />
<link rel='index' title='Zhixingheyi' href='http://liuxuan.info/' />

<!-- All in One SEO Pack 1.6.13.4 by Michael Torbert of Semper Fi Web Design[-1,-1] -->
<meta name="description" content="Java,RoR,MySQL,Linux,OpenSource" />
<meta name="keywords" content="Java,RoR,MySQL,Linux,OpenSource" />
<link rel="canonical" href="http://liuxuan.info/" />
<!-- /all in one seo pack -->

<!-- Bad Behavior 2.1.14 run time: 3.735 ms -->
<script type="text/javascript">
<!--
function bb2_addLoadEvent(func) {
	var oldonload = window.onload;
	if (typeof window.onload != 'function') {
		window.onload = func;
	} else {
		window.onload = function() {
			oldonload();
			func();
		}
	}
}

bb2_addLoadEvent(function() {
	for ( i=0; i < document.forms.length; i++ ) {
		if (document.forms[i].method == 'post') {
			var myElement = document.createElement('input');
			myElement.setAttribute('type', 'hidden');
			myElement.name = 'bb2_screener_';
			myElement.value = '1315495926 58.221.42.85';
			document.forms[i].appendChild(myElement);
		}
	}
});
// --></script>
		<!-- Meta tags added by Robots Meta: http://yoast.com/wordpress/meta-robots-wordpress-plugin/ -->
<meta name="robots" content="noodp,noydir" />

<link rel="stylesheet" href="http://liuxuan.info/wp-content/plugins/wp-syntax/wp-syntax.css" type="text/css" media="screen" />
<script type="text/javascript">
//<![CDATA[
	var screen_res = "";
	function writeCookie(name,value,hours) {
		var the_cookie = name+"="+escape(value)+"; expires=";
		var expires = "";
		hours=hours+0; //convert to number
		if (hours > 0) { //0==expires on browser close
			var cdate = new Date();
			cdate.setTime(cdate.getTime()+(hours*60*60*1000));
			expires = expires+cdate.toGMTString();
		} 
		document.cookie = the_cookie+expires+"; path=/; domain=";
	}
	screen_res = screen.width+" x "+screen.height;
	if (screen_res==" x ") screen_res = window.screen.width+" x "+window.screen.height;
	if (screen_res==" x ") screen_res = screen.availWidth+" x "+screen.availHeight;
	if (screen_res!=" x ") { 
		writeCookie("wassup_screen_res",screen_res,"48"); //keep 2 days
	} else {
		screen_res = "";
	}
//]]>
</script>
<style type="text/css">.broken_link, a.broken_link {
	text-decoration: line-through;
}</style></head>
<body class="home blog custom">
<div id="page" class="hfeed content-620px">

	<div id="header">
		<div id="branding">
						<h1 class="homelink"><a href="http://liuxuan.info" title="Zhixingheyi">Zhixingheyi</a></h1>
						<p class="description">Where the truth distortion happens.</p>
		</div>
		
		<div id="skip"><a title="Skip to content" href="#primary" accesskey="S">Skip to Content &darr;</a></div>
		
		<div class="menu"><ul><li class="current_page_item"><a href="http://liuxuan.info/" title="Home">Home</a></li><li class="page_item page-item-41"><a href="http://liuxuan.info/about/" title="About">About</a></li><li class="page_item page-item-110"><a href="http://liuxuan.info/programmer-competency-matrix/" title="Programmer Competency Matrix">Programmer Competency Matrix</a></li></ul></div>
	</div><!--#header-->
<div id="container">
	<div id="rotating">
		<img src="http://liuxuan.info/wp-content/themes/primepress/rotating.php?image=16" 
width="920" alt="Zhixingheyi Rotating Header Image" title="Zhixingheyi Random Header Image" />	</div>	
	<div id="primary" class="looped">
		
				
				
		<div id="post-553" class="post-553 post type-post status-publish format-standard hentry category-opensource tag-ibatis tag-java tag-mybatis tag-sourcecode entry">
			
			<h2 class="entry-title"><a href="http://liuxuan.info/2011/08/ibatis-and-mybatis-source-code-analysis-two-logging/" rel="bookmark" title="Permalink to iBatis/myBatis源码分析之二:日志">iBatis/myBatis源码分析之二:日志</a></h2>
			
			<div class="entry-byline">
				<a class="entry-date" rel="bookmark" title="2011-08-26T23:35:47+0000" href="http://liuxuan.info/2011/08/ibatis-and-mybatis-source-code-analysis-two-logging/"><abbr class="updated" title="2011-08-26T23:35:47+0000">Aug 26th, 2011</abbr></a>
				<address class="author vcard">by <a class="url fn" href="">Foredoomed</a>. </address>
				<a href="http://liuxuan.info/2011/08/ibatis-and-mybatis-source-code-analysis-two-logging/#respond" class="comments-link"  rel="nofollow" title="Comment on iBatis/myBatis源码分析之二:日志">No comments yet</a>							</div>
			
			<div class="entry-content">
				<a href="http://liuxuan.info/2011/08/ibatis-and-mybatis-source-code-analysis-two-logging/" title="iBatis/myBatis源码分析之二:日志"></a>				<p><strong>一.包结构分析</strong></p>
<p>1.iBatis的logging包结构：</p>
<table border="1" width="100%" cellpadding="3" cellspacing="0" summary="">
<tbody>
<th align="left" colspan="2" style="background-color:#CCCCFF">
<b>Packages</b></th>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.common.logging</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.common.logging.jakarta</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.common.logging.jdk14</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.common.logging.log4j</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.common.logging.nologging</b></td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p>iBatis把对logging支持的类全部放在了common包的子包下，并且又根据不同的logging实现又分成了commons-logging，jdk1.4自带的logging，log4j和nologging四个子包。个人感觉整个包的划分还是非常清晰的，但是nologging包的存在感觉有点鸡肋，因为日志是一个系统必备的功能之一，很难想象一个系统缺少了日志怎么做数据分析，性能调优等。难道作者认为有些时候或有一天就不需要日志了？</p>
<p>2.myBatis的logging包结构：</p>
<table border="1" width="100%" cellpadding="3" cellspacing="0" summary="">
<tbody>
<th align="left" colspan="2" style="background-color:#CCCCFF">
<b>Packages</b></th>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.logging</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.logging.commons</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.logging.jdbc</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.logging.jdk14</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.logging.log4j</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.logging.nologging</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.logging.slf4j</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.logging.stdout</b></td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p>可以看到myBatis的logging包结构较之iBatis基本没变，但是增加了jdbc，slf4j以及stdout的支持。对jdbc执行sql语句的日志支持看上去很美好，但是给性能带来的影响比较大，这个等下面的源码分析再详细说明；增加对slf4j的支持应该是大势所趋没有问题；而增加对stdout的支持是一个很好的功能，在测试阶段应该会是一个很好的日志功能实现。</p>
<p><strong>二.源码分析</strong></p>
<p><em>1.iBatis</em></p>
<p>(1)Log接口：</p>

<div class="wp_syntax"><div class="code"><pre class="java" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">interface</span> Log <span style="color: #009900;">&#123;</span>
&nbsp;
  <span style="color: #00008B; font-weight: bold;">boolean</span> isDebugEnabled<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #00008B; font-weight: bold;">void</span> error<span style="color: #009900;">&#40;</span><span style="color: #2B91AF;">String</span> s, <span style="color: #2B91AF;">Throwable</span> e<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #00008B; font-weight: bold;">void</span> error<span style="color: #009900;">&#40;</span><span style="color: #2B91AF;">String</span> s<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #00008B; font-weight: bold;">void</span> debug<span style="color: #009900;">&#40;</span><span style="color: #2B91AF;">String</span> s<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #00008B; font-weight: bold;">void</span> warn<span style="color: #009900;">&#40;</span><span style="color: #2B91AF;">String</span> s<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #009900;">&#125;</span></pre></div></div>

<p>Log接口定义了三个log级别，所有的log实现都会去实现这个接口，所以它是所有log的代表。</p>
<p>(2)LogFactory工厂类：</p>

<div class="wp_syntax"><div class="code"><pre class="java" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> LogFactory <span style="color: #009900;">&#123;</span>
&nbsp;
  <span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #2B91AF;">Constructor</span> logConstructor<span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #009900;">&#123;</span>
    tryImplementation<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;org.apache.commons.logging.LogFactory&quot;</span>, <span style="color: #0000ff;">&quot;com.ibatis.common.logging.jakarta.JakartaCommonsLoggingImpl&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    tryImplementation<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;org.apache.log4j.Logger&quot;</span>, <span style="color: #0000ff;">&quot;com.ibatis.common.logging.log4j.Log4jImpl&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    tryImplementation<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;java.util.logging.Logger&quot;</span>, <span style="color: #0000ff;">&quot;com.ibatis.common.logging.jdk14.Jdk14LoggingImpl&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    tryImplementation<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;java.lang.Object&quot;</span>, <span style="color: #0000ff;">&quot;com.ibatis.common.logging.nologging.NoLoggingImpl&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #00008B; font-weight: bold;">void</span> tryImplementation<span style="color: #009900;">&#40;</span><span style="color: #2B91AF;">String</span> testClassName, <span style="color: #2B91AF;">String</span> implClassName<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #7F0055; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>logConstructor <span style="color: #339933;">==</span> <span style="color: #7F0055; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
      <span style="color: #7F0055; font-weight: bold;">try</span> <span style="color: #009900;">&#123;</span>
        Resources.<span style="color: #006633;">classForName</span><span style="color: #009900;">&#40;</span>testClassName<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #7F0055; font-weight: bold;">Class</span> implClass <span style="color: #339933;">=</span> Resources.<span style="color: #006633;">classForName</span><span style="color: #009900;">&#40;</span>implClassName<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        logConstructor <span style="color: #339933;">=</span> implClass.<span style="color: #006633;">getConstructor</span><span style="color: #009900;">&#40;</span><span style="color: #7F0055; font-weight: bold;">new</span> <span style="color: #7F0055; font-weight: bold;">Class</span><span style="color: #009900;">&#91;</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#123;</span><span style="color: #7F0055; font-weight: bold;">Class</span>.<span style="color: #7F0055; font-weight: bold;">class</span><span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      <span style="color: #009900;">&#125;</span> <span style="color: #7F0055; font-weight: bold;">catch</span> <span style="color: #009900;">&#40;</span><span style="color: #2B91AF;">Throwable</span> t<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
      <span style="color: #009900;">&#125;</span>
    <span style="color: #009900;">&#125;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">static</span> Log getLog<span style="color: #009900;">&#40;</span><span style="color: #7F0055; font-weight: bold;">Class</span> aClass<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #7F0055; font-weight: bold;">try</span> <span style="color: #009900;">&#123;</span>
      <span style="color: #7F0055; font-weight: bold;">return</span> <span style="color: #009900;">&#40;</span>Log<span style="color: #009900;">&#41;</span>logConstructor.<span style="color: #006633;">newInstance</span><span style="color: #009900;">&#40;</span><span style="color: #7F0055; font-weight: bold;">new</span> <span style="color: #2B91AF;">Object</span><span style="color: #009900;">&#91;</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#123;</span>aClass<span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span> <span style="color: #7F0055; font-weight: bold;">catch</span> <span style="color: #009900;">&#40;</span><span style="color: #2B91AF;">Throwable</span> t<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
      <span style="color: #7F0055; font-weight: bold;">throw</span> <span style="color: #7F0055; font-weight: bold;">new</span> <span style="color: #2B91AF;">RuntimeException</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;Error creating logger for class &quot;</span> <span style="color: #339933;">+</span> aClass <span style="color: #339933;">+</span> <span style="color: #0000ff;">&quot;.  Cause: &quot;</span> <span style="color: #339933;">+</span> t, t<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #7F0055; font-weight: bold;">synchronized</span> <span style="color: #00008B; font-weight: bold;">void</span> selectLog4JLogging<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #7F0055; font-weight: bold;">try</span> <span style="color: #009900;">&#123;</span>
      Resources.<span style="color: #006633;">classForName</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;org.apache.log4j.Logger&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      <span style="color: #7F0055; font-weight: bold;">Class</span> implClass <span style="color: #339933;">=</span> Resources.<span style="color: #006633;">classForName</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;com.ibatis.common.logging.log4j.Log4jImpl&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      logConstructor <span style="color: #339933;">=</span> implClass.<span style="color: #006633;">getConstructor</span><span style="color: #009900;">&#40;</span><span style="color: #7F0055; font-weight: bold;">new</span> <span style="color: #7F0055; font-weight: bold;">Class</span><span style="color: #009900;">&#91;</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#123;</span><span style="color: #7F0055; font-weight: bold;">Class</span>.<span style="color: #7F0055; font-weight: bold;">class</span><span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span> <span style="color: #7F0055; font-weight: bold;">catch</span> <span style="color: #009900;">&#40;</span><span style="color: #2B91AF;">Throwable</span> t<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #009900;">&#125;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #7F0055; font-weight: bold;">synchronized</span> <span style="color: #00008B; font-weight: bold;">void</span> selectJavaLogging<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #7F0055; font-weight: bold;">try</span> <span style="color: #009900;">&#123;</span>
      Resources.<span style="color: #006633;">classForName</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;java.util.logging.Logger&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      <span style="color: #7F0055; font-weight: bold;">Class</span> implClass <span style="color: #339933;">=</span> Resources.<span style="color: #006633;">classForName</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;com.ibatis.common.logging.jdk14.Jdk14LoggingImpl&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      logConstructor <span style="color: #339933;">=</span> implClass.<span style="color: #006633;">getConstructor</span><span style="color: #009900;">&#40;</span><span style="color: #7F0055; font-weight: bold;">new</span> <span style="color: #7F0055; font-weight: bold;">Class</span><span style="color: #009900;">&#91;</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#123;</span><span style="color: #7F0055; font-weight: bold;">Class</span>.<span style="color: #7F0055; font-weight: bold;">class</span><span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span> <span style="color: #7F0055; font-weight: bold;">catch</span> <span style="color: #009900;">&#40;</span><span style="color: #2B91AF;">Throwable</span> t<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #009900;">&#125;</span>
  <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span></pre></div></div>

<p>在这个工厂类里我们可以非常容易地感觉到“坏味道”，那就是在catch块中什么都不做，这是应该尽量避免出现的情况。在static块中会尝试依次加载所有的log实现类，这点也是值得商榷的。因为在一个系统中一般只使用一种日志实现，一次性加载所有的实现只会带来性能问题；还有一个问题就是是否需要动态切换日志实现的功能，至少我觉得这个功能也是个鸡肋。</p>
<p><em>2.myBatis</em></p>
<p>(1)Log接口与iBatis的没有变化</p>
<p>(3)LogFactory工厂类：</p>

<div class="wp_syntax"><div class="code"><pre class="java" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> LogFactory <span style="color: #009900;">&#123;</span>
&nbsp;
  <span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #7F0055; font-weight: bold;">static</span> Constructor<span style="color: #339933;">&lt;</span> <span style="color: #339933;">?</span> <span style="color: #7F0055; font-weight: bold;">extends</span> Log<span style="color: #339933;">&gt;</span> logConstructor<span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #009900;">&#123;</span>
    tryImplementation<span style="color: #009900;">&#40;</span><span style="color: #7F0055; font-weight: bold;">new</span> <span style="color: #2B91AF;">Runnable</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
      <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #00008B; font-weight: bold;">void</span> run<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        useSlf4jLogging<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      <span style="color: #009900;">&#125;</span>
    <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    tryImplementation<span style="color: #009900;">&#40;</span><span style="color: #7F0055; font-weight: bold;">new</span> <span style="color: #2B91AF;">Runnable</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
      <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #00008B; font-weight: bold;">void</span> run<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        useCommonsLogging<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      <span style="color: #009900;">&#125;</span>
    <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    tryImplementation<span style="color: #009900;">&#40;</span><span style="color: #7F0055; font-weight: bold;">new</span> <span style="color: #2B91AF;">Runnable</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
      <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #00008B; font-weight: bold;">void</span> run<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        useLog4JLogging<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      <span style="color: #009900;">&#125;</span>
    <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    tryImplementation<span style="color: #009900;">&#40;</span><span style="color: #7F0055; font-weight: bold;">new</span> <span style="color: #2B91AF;">Runnable</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
      <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #00008B; font-weight: bold;">void</span> run<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        useJdkLogging<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      <span style="color: #009900;">&#125;</span>
    <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    tryImplementation<span style="color: #009900;">&#40;</span><span style="color: #7F0055; font-weight: bold;">new</span> <span style="color: #2B91AF;">Runnable</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
      <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #00008B; font-weight: bold;">void</span> run<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        useNoLogging<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      <span style="color: #009900;">&#125;</span>
    <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">static</span> Log getLog<span style="color: #009900;">&#40;</span>Class<span style="color: #339933;">&lt;</span> <span style="color: #339933;">?&gt;</span> aClass<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #7F0055; font-weight: bold;">try</span> <span style="color: #009900;">&#123;</span>
      <span style="color: #7F0055; font-weight: bold;">return</span> logConstructor.<span style="color: #006633;">newInstance</span><span style="color: #009900;">&#40;</span><span style="color: #7F0055; font-weight: bold;">new</span> <span style="color: #2B91AF;">Object</span><span style="color: #009900;">&#91;</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#123;</span>aClass<span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span> <span style="color: #7F0055; font-weight: bold;">catch</span> <span style="color: #009900;">&#40;</span><span style="color: #2B91AF;">Throwable</span> t<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
      <span style="color: #7F0055; font-weight: bold;">throw</span> <span style="color: #7F0055; font-weight: bold;">new</span> LogException<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;Error creating logger for class &quot;</span> <span style="color: #339933;">+</span> aClass <span style="color: #339933;">+</span> <span style="color: #0000ff;">&quot;.  Cause: &quot;</span> <span style="color: #339933;">+</span> t, t<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #7F0055; font-weight: bold;">synchronized</span> <span style="color: #00008B; font-weight: bold;">void</span> useSlf4jLogging<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    setImplementation<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;org.apache.ibatis.logging.slf4j.Slf4jImpl&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #7F0055; font-weight: bold;">synchronized</span> <span style="color: #00008B; font-weight: bold;">void</span> useCommonsLogging<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    setImplementation<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;org.apache.ibatis.logging.commons.JakartaCommonsLoggingImpl&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #7F0055; font-weight: bold;">synchronized</span> <span style="color: #00008B; font-weight: bold;">void</span> useLog4JLogging<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    setImplementation<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;org.apache.ibatis.logging.log4j.Log4jImpl&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #7F0055; font-weight: bold;">synchronized</span> <span style="color: #00008B; font-weight: bold;">void</span> useJdkLogging<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    setImplementation<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;org.apache.ibatis.logging.jdk14.Jdk14LoggingImpl&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #7F0055; font-weight: bold;">synchronized</span> <span style="color: #00008B; font-weight: bold;">void</span> useStdOutLogging<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    setImplementation<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;org.apache.ibatis.logging.stdout.StdOutImpl&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #7F0055; font-weight: bold;">synchronized</span> <span style="color: #00008B; font-weight: bold;">void</span> useNoLogging<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    setImplementation<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;org.apache.ibatis.logging.nologging.NoLoggingImpl&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #00008B; font-weight: bold;">void</span> tryImplementation<span style="color: #009900;">&#40;</span><span style="color: #2B91AF;">Runnable</span> runnable<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #7F0055; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>logConstructor <span style="color: #339933;">==</span> <span style="color: #7F0055; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
      <span style="color: #7F0055; font-weight: bold;">try</span> <span style="color: #009900;">&#123;</span>
        runnable.<span style="color: #006633;">run</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      <span style="color: #009900;">&#125;</span> <span style="color: #7F0055; font-weight: bold;">catch</span> <span style="color: #009900;">&#40;</span><span style="color: #2B91AF;">Throwable</span> t<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #666666; font-style: italic;">//ignore</span>
      <span style="color: #009900;">&#125;</span>
    <span style="color: #009900;">&#125;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #00008B; font-weight: bold;">void</span> setImplementation<span style="color: #009900;">&#40;</span><span style="color: #2B91AF;">String</span> implClassName<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #7F0055; font-weight: bold;">try</span> <span style="color: #009900;">&#123;</span>
      @SuppressWarnings<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;unchecked&quot;</span><span style="color: #009900;">&#41;</span>
      Class<span style="color: #339933;">&lt;</span> <span style="color: #339933;">?</span> <span style="color: #7F0055; font-weight: bold;">extends</span> Log<span style="color: #339933;">&gt;</span> implClass <span style="color: #339933;">=</span> <span style="color: #009900;">&#40;</span>Class<span style="color: #339933;">&lt;</span> <span style="color: #339933;">?</span> <span style="color: #7F0055; font-weight: bold;">extends</span> Log<span style="color: #339933;">&gt;</span><span style="color: #009900;">&#41;</span> Resources.<span style="color: #006633;">classForName</span><span style="color: #009900;">&#40;</span>implClassName<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      Constructor<span style="color: #339933;">&lt;</span> <span style="color: #339933;">?</span> <span style="color: #7F0055; font-weight: bold;">extends</span> Log<span style="color: #339933;">&gt;</span> candidate <span style="color: #339933;">=</span> implClass.<span style="color: #006633;">getConstructor</span><span style="color: #009900;">&#40;</span><span style="color: #7F0055; font-weight: bold;">new</span> <span style="color: #7F0055; font-weight: bold;">Class</span><span style="color: #009900;">&#91;</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#123;</span><span style="color: #7F0055; font-weight: bold;">Class</span>.<span style="color: #7F0055; font-weight: bold;">class</span><span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      Log log <span style="color: #339933;">=</span> candidate.<span style="color: #006633;">newInstance</span><span style="color: #009900;">&#40;</span><span style="color: #7F0055; font-weight: bold;">new</span> <span style="color: #2B91AF;">Object</span><span style="color: #009900;">&#91;</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#123;</span>LogFactory.<span style="color: #7F0055; font-weight: bold;">class</span><span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      log.<span style="color: #006633;">debug</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;Logging initialized using '&quot;</span> <span style="color: #339933;">+</span> implClassName <span style="color: #339933;">+</span> <span style="color: #0000ff;">&quot;' adapter.&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      logConstructor <span style="color: #339933;">=</span> candidate<span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span> <span style="color: #7F0055; font-weight: bold;">catch</span> <span style="color: #009900;">&#40;</span><span style="color: #2B91AF;">Throwable</span> t<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
      <span style="color: #7F0055; font-weight: bold;">throw</span> <span style="color: #7F0055; font-weight: bold;">new</span> LogException<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;Error setting Log implementation.  Cause: &quot;</span> <span style="color: #339933;">+</span> t, t<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
  <span style="color: #009900;">&#125;</span></pre></div></div>

<p>在myBatis的实现里，除了加入了范型，多线程外没有什么太大的变化。还是要加载所有的log实现类，但是更大的问题是加载方法用synchronized来修饰了，且不论是否有必要全部加载，但就全部的同步方法就会给性能造成负面影响；而且在iBatis中的“坏味道”依旧存在。</p>
<p>三.总结</p>
<p>在这篇博文里比较了iBatis和myBatis的log实现，发现了存在“坏味道”，即在catch块中什么事都没做，这种情况应该避免发生；还有一次性加载所有的log实现类以及动态切换log实现都是不太常用的功能，如果要用iBatis/myBatis的log实现的话需要修改源代码来提高性能。</p>
							</div>
			
			<p class="entry-meta"><span class="entry-categories">Posted in: <a href="http://liuxuan.info/category/opensource/" title="View all posts in Opensource" rel="category tag">Opensource</a>.</span><br />
							<span class="entry-tags">Tagged: <a href="http://liuxuan.info/tag/ibatis/" rel="nofollow tag">iBatis</a> &middot; <a href="http://liuxuan.info/tag/java/" rel="nofollow tag">Java</a> &middot; <a href="http://liuxuan.info/tag/mybatis/" rel="nofollow tag">myBatis</a> &middot; <a href="http://liuxuan.info/tag/sourcecode/" rel="nofollow tag">Sourcecode</a><br /></span>
			</p>
		</div><!--.entry-->
		
				
		<div id="post-530" class="post-530 post type-post status-publish format-standard hentry category-opensource tag-ibatis tag-java tag-mybatis tag-sourcecode entry">
			
			<h2 class="entry-title"><a href="http://liuxuan.info/2011/08/ibatis-and-mybatis-source-code-analysis-one-overview/" rel="bookmark" title="Permalink to iBatis/myBatis源码分析之一:概览">iBatis/myBatis源码分析之一:概览</a></h2>
			
			<div class="entry-byline">
				<a class="entry-date" rel="bookmark" title="2011-08-24T22:29:51+0000" href="http://liuxuan.info/2011/08/ibatis-and-mybatis-source-code-analysis-one-overview/"><abbr class="updated" title="2011-08-24T22:29:51+0000">Aug 24th, 2011</abbr></a>
				<address class="author vcard">by <a class="url fn" href="">Foredoomed</a>. </address>
				<a href="http://liuxuan.info/2011/08/ibatis-and-mybatis-source-code-analysis-one-overview/#respond" class="comments-link"  rel="nofollow" title="Comment on iBatis/myBatis源码分析之一:概览">No comments yet</a>							</div>
			
			<div class="entry-content">
				<a href="http://liuxuan.info/2011/08/ibatis-and-mybatis-source-code-analysis-one-overview/" title="iBatis/myBatis源码分析之一:概览"></a>				<p><strong>一.写在最前</strong></p>
<p>记得第一次知道<a href="http://ibatis.apache.org/" rel="nofollow"  title="http://ibatis.apache.org/">iBatis</a>这个框架还是在2、3年前，那段时间Hibernate风头正劲，Java EE开发已经被概括为SSH，各个软件公司把Hibernate作为Java程序员一种标配的技能而来考核。正是在这样一种情况下，iBatis作为与Hibernate不同的ORM思想的实现，仍然被一部分开发者喜爱和支持，当然我也是其中之一。而且在一个偶然的机会让我知道原来淘宝的ORM工具也是用的iBatis后，就更加坚定了我对iBatis的信心(可能是因为Rails的关系，现在我觉得Spring Ro会更有前途)。</p>
<p>其实当初我开始学习Hibernate的时候就感觉非常的复杂，基本上大部分时间都是花在学习怎么编写hbm.xml映射文件上的。Hibernate文档中的配置说明又非常得多，对于数据库表的各种关系的映射配置都在文档中有着比较详细的描述，整个文档有好几百页长。所以，当时我就觉得这也有点太复杂了，如果一个表有很多字段，并且这个表与其他多个表之间有着复杂的关系，那么编写hbm.xml文件将会是一件苦不堪言的工作。更有甚者，编写完了映射关系还不算完，还要配置字段的属性，而字段属性数量繁多，足以让你在其中摸不着头脑，非常蛋疼。</p>
<p>我并不是说Hibernate不好，因为好与不好是相对的。个人觉得Hibernate在Java企业级开发中还是非常有市场的，毕竟Hibernate已经非常成熟，会使用Hibernate的开发人员也多。但是，在商业网站开发领域，随着对性能的要求不断增加或者说苛刻的地步，数据库端的查询已经基本上放弃了多表之间的join操作以求达到比较理想的性能要求。在这样一个趋势下，Hibernate的作用就不大了。而且hql不利于优化的缺点对于数据库优化来说将成为性能瓶颈所在。对于商业网站而言，Java不能满足快速迭代开发的要求，越来越多的Web2.0网站采用PHP、Ruby或者Python作为开发语言，这也是我为什么觉得Spring Roo更有前途的原因。</p>
<p>不管怎样，Hibernate和iBatis是Java EE平台上非常优秀的ORM框架。但是对我而言，iBatis更轻量，对SQL的映射更符合我的理念，所以就趁现在有时间就来分析一下iBatis的源码。而就在去年，iBatis已经改名为<a href="http://www.mybatis.org" rel="nofollow"  title="http://www.mybatis.org">myBatis</a>，我决定在分析源码的同时对这两个版本做一个比较。但是并不只是分析源码，其中还会加入对JDK源码的分析以及依赖的第三方框架的分析，我希望这次的分析是一个非常细致的分析系列。</p>
<p><strong>二.概览</strong></p>
<p>这篇博文是iBatis/myBatis源码分析系列的第一篇，我想首先来对iBatis/myBatis的整个结构做一个概览。首先来看一下iBatis的包结构(版本为2.3.4.726)：</p>
<table border="1" width="100%" cellpadding="3" cellspacing="0" summary="">
<tbody>
<th align="left" colspan="2" style="background-color:#CCCCFF">
<b>Packages</b></th>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.common.beans</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.common.io</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.common.jdbc</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.common.jdbc.exception</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.common.jdbc.logging</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.common.logging</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.common.logging.jakarta</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.common.logging.jdk14</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.common.logging.log4j</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.common.logging.nologging</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.common.resources</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.common.util</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.common.xml</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.client</b></td>
<td>This package contains the core library client interface.</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.client.event</b></td>
<td>This package contains event handler interfaces.</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.client.extensions</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.accessplan</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.builder.xml</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.cache</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.cache.fifo</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.cache.lru</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.cache.memory</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.cache.oscache</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.config</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.datasource</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.exchange</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.execution</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.impl</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.mapping.parameter</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.mapping.result</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.mapping.result.loader</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.mapping.sql</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.mapping.sql.dynamic</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.mapping.sql.dynamic.elements</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.mapping.sql.raw</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.mapping.sql.simple</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.mapping.sql.stat</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.mapping.statement</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.scope</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.transaction</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.transaction.external</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.transaction.jdbc</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.transaction.jta</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.transaction.user</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.type</b></td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p>我们可以看到，iBatis整个包结构非常的简单，一目了然。仔细观察后可以说就分为两大部分：<strong>common</strong>和<strong>sqlmap</strong>。common包中包括了除了iBatis核心包之外的所有工具类包；而sqlmap包则是整个iBatis的核心包的所在，它又是由两部分组成：<strong>client</strong>和<strong>engine</strong>。client包是操作CRUD的对象所在的包，engine包则是iBatis用来处理映射关系的核心包。</p>
<p>再来看myBatis的包结构(版本为3.05)：</p>
<table border="1" width="100%" cellpadding="3" cellspacing="0" summary="">
<tbody>
<th align="left" colspan="2" style="background-color:#CCCCFF">
<b>Packages</b></th>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.annotations</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.binding</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.builder</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.builder.annotation</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.builder.xml</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.builder.xml.dynamic</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.cache</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.cache.decorators</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.cache.impl</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.datasource</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.datasource.jndi</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.datasource.pooled</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.datasource.unpooled</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.exceptions</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.executor</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.executor.keygen</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.executor.loader</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.executor.parameter</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.executor.result</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.executor.resultset</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.executor.statement</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.io</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.jdbc</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.logging</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.logging.commons</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.logging.jdbc</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.logging.jdk14</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.logging.log4j</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.logging.nologging</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.logging.slf4j</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.logging.stdout</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.mapping</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.metadata</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.migration</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.migration.commands</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.parsing</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.plugin</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.reflection</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.reflection.factory</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.reflection.invoker</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.reflection.property</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.reflection.wrapper</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.session</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.session.defaults</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.transaction</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.transaction.jdbc</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.transaction.managed</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.type</b></td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p>我们可以看到在myBatis的包结构中，各个独立的功能被抽取出来单独成为一了个包，可以说是细化了整个框架的功能分类，较之iBatis整个包结构也更加清晰。除了包结构的变化，我们还可以看到在myBatis中加入了一些新的特性,比如增加了对annotation的支持，日志增加了对slf4j的支持等。</p>
<p>整个概述就到这里，在接下来的一系列博文里将详细地分析各个包已经类和方法的作用。</p>
							</div>
			
			<p class="entry-meta"><span class="entry-categories">Posted in: <a href="http://liuxuan.info/category/opensource/" title="View all posts in Opensource" rel="category tag">Opensource</a>.</span><br />
							<span class="entry-tags">Tagged: <a href="http://liuxuan.info/tag/ibatis/" rel="nofollow tag">iBatis</a> &middot; <a href="http://liuxuan.info/tag/java/" rel="nofollow tag">Java</a> &middot; <a href="http://liuxuan.info/tag/mybatis/" rel="nofollow tag">myBatis</a> &middot; <a href="http://liuxuan.info/tag/sourcecode/" rel="nofollow tag">Sourcecode</a><br /></span>
			</p>
		</div><!--.entry-->
		
				
		<div id="post-525" class="post-525 post type-post status-publish format-standard hentry category-linux tag-vnstat tag-vps entry">
			
			<h2 class="entry-title"><a href="http://liuxuan.info/2011/08/install-vnstat-on-vps/" rel="bookmark" title="Permalink to 在VPS上安装网络流量监控工具vnStat">在VPS上安装网络流量监控工具vnStat</a></h2>
			
			<div class="entry-byline">
				<a class="entry-date" rel="bookmark" title="2011-08-22T21:15:46+0000" href="http://liuxuan.info/2011/08/install-vnstat-on-vps/"><abbr class="updated" title="2011-08-22T21:15:46+0000">Aug 22nd, 2011</abbr></a>
				<address class="author vcard">by <a class="url fn" href="">Foredoomed</a>. </address>
				<a href="http://liuxuan.info/2011/08/install-vnstat-on-vps/#respond" class="comments-link"  rel="nofollow" title="Comment on 在VPS上安装网络流量监控工具vnStat">No comments yet</a>							</div>
			
			<div class="entry-content">
				<a href="http://liuxuan.info/2011/08/install-vnstat-on-vps/" title="在VPS上安装网络流量监控工具vnStat"></a>				<p>用上VPS以后博客的访问速度是比以前快了很多，但是也有烦心的事，就是担心每个月的流量有没有超标。你可以通过VPS提供给你的Control Panel的地址登录，然后查看流量数据。但是这种方法始终有点复杂，最好有种直接输入一个URL就能查看流量数据的方法。在Google上搜索了一会儿之后，终于找到了一个好工具：vnStat。</p>
<p><a href="http://humdi.net/vnstat/" rel="nofollow"  title="http://humdi.net/vnstat/">vnStat</a>是Linux和BSD平台上基于控制台的网络流量监控工具。它使用的是Linux内核提供的网络接口统计作为信息源。vnStat不会嗅探网络并且保证占系统资源少，需要注意的是内核版本要在2.2之上。</p>
<p>vnStat只是1个基于控制台的工具，我们还需要安装一个它的PHP扩展<a href="http://www.sqweek.com/sqweek/index.php?p=1" rel="nofollow"  title="http://www.sqweek.com/sqweek/index.php?p=1">vnStat PHP frontend</a>，那么我们就能直接通过流量器来查看流量数据了。</p>
<p>速度安装起来：</p>
<p>1.安装vnStat:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">wget</span> http:<span style="color: #000000; font-weight: bold;">//</span>humdi.net<span style="color: #000000; font-weight: bold;">/</span>vnstat<span style="color: #000000; font-weight: bold;">/</span>vnstat-<span style="color: #000000;">1.11</span>.tar.gz
<span style="color: #c20cb9; font-weight: bold;">tar</span> zxvf vnstat-<span style="color: #000000;">1.11</span>.tar.gz
<span style="color: #7a0874; font-weight: bold;">cd</span> vnstat-<span style="color: #000000;">1.11</span>
<span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #000000; font-weight: bold;">&amp;&amp;</span> <span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #c20cb9; font-weight: bold;">install</span></pre></div></div>

<p>2.安装vnStat PHP frontend：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">wget</span> http:<span style="color: #000000; font-weight: bold;">//</span>www.sqweek.com<span style="color: #000000; font-weight: bold;">/</span>sqweek<span style="color: #000000; font-weight: bold;">/</span>files<span style="color: #000000; font-weight: bold;">/</span>vnstat_php_frontend-1.5.1.tar.gz
<span style="color: #c20cb9; font-weight: bold;">cp</span> <span style="color: #660033;">-r</span> vnstat_php_frontend-1.5.1 <span style="color: #000000; font-weight: bold;">/</span>你的Nginx的根目录<span style="color: #000000; font-weight: bold;">/</span>vnstat</pre></div></div>

<p>然后就可以通过访问http://www.yourdomain.com/vnstat，应该就可以看到流量数据页面了，但是现在还没有数据，接下来我们来给系统生成数据。</p>
<p>3.建立流量数据库:</p>
<p>首先查看你是哪种外网网卡：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">ifconfig</span>    <span style="color: #000000; font-weight: bold;">//</span>Xen一般是eth0；OpenVZ一般是venet0</pre></div></div>

<p>然后生成数据库：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>vnstat <span style="color: #660033;">-u</span> <span style="color: #660033;">-i</span> venet0  <span style="color: #000000; font-weight: bold;">//</span>因为我的VPS是基于OpenVZ的，所以就是venet0</pre></div></div>

<p>配置通过cron的方式定时更新数据库：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">vim</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>cron.d<span style="color: #000000; font-weight: bold;">/</span>vnstat</pre></div></div>

<p>加入下面的内容：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #000000;">0</span>-<span style="color: #000000;">55</span><span style="color: #000000; font-weight: bold;">/</span><span style="color: #000000;">5</span> <span style="color: #000000; font-weight: bold;">*</span> <span style="color: #000000; font-weight: bold;">*</span> <span style="color: #000000; font-weight: bold;">*</span> <span style="color: #000000; font-weight: bold;">*</span>   root   vnstat <span style="color: #660033;">-u</span> <span style="color: #660033;">-i</span> venet0
<span style="color: #000000;">0</span>-<span style="color: #000000;">55</span><span style="color: #000000; font-weight: bold;">/</span><span style="color: #000000;">5</span> <span style="color: #000000; font-weight: bold;">*</span> <span style="color: #000000; font-weight: bold;">*</span> <span style="color: #000000; font-weight: bold;">*</span> <span style="color: #000000; font-weight: bold;">*</span>   root   vnstat <span style="color: #660033;">--dumpdb</span> <span style="color: #660033;">-i</span> venet0 <span style="color: #000000; font-weight: bold;">&gt;/</span>var<span style="color: #000000; font-weight: bold;">/</span>lib<span style="color: #000000; font-weight: bold;">/</span>vnstat<span style="color: #000000; font-weight: bold;">/</span>vnstat_dump_venet0</pre></div></div>

<p>注意：第二行是为了更新venet0的数据后，dump出来一个文件提供给PHP访问.这里dump出来的vnstat_dump_venet0文件名是有规定的。</p>
<p>4.修改配置文件：</p>
<p>编辑文件：/你的Nginx的根目录/vnstat/config.php：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #007800;">$language</span> = <span style="color: #ff0000;">'en'</span>;
<span style="color: #007800;">$iface_list</span> = array<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #ff0000;">'venet0'</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>;
<span style="color: #007800;">$iface_title</span><span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #ff0000;">'venet0'</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> = <span style="color: #ff0000;">'VPS'</span>;
<span style="color: #007800;">$data_dir</span> = <span style="color: #ff0000;">'/var/lib/vnstat/'</span>;
<span style="color: #007800;">$graph_format</span>=<span style="color: #ff0000;">'png'</span>;</pre></div></div>

<p>到这里安装就都完成了，就这么简单。现在访问www.yourdomain.com/vnstat就会发现有流量统计了,统计数据更新是５分钟刷新一次。</p>
							</div>
			
			<p class="entry-meta"><span class="entry-categories">Posted in: <a href="http://liuxuan.info/category/linux/" title="View all posts in Linux" rel="category tag">Linux</a>.</span><br />
							<span class="entry-tags">Tagged: <a href="http://liuxuan.info/tag/vnstat/" rel="nofollow tag">vnStat</a> &middot; <a href="http://liuxuan.info/tag/vps/" rel="nofollow tag">VPS</a><br /></span>
			</p>
		</div><!--.entry-->
		
				
		<div id="post-459" class="post-459 post type-post status-publish format-standard hentry category-linux tag-dropbear tag-linux tag-mysql tag-nginx tag-php tag-pptp tag-vps tag-vsftp entry">
			
			<h2 class="entry-title"><a href="http://liuxuan.info/2011/08/setup-lnmp-and-pptp-on-vps/" rel="bookmark" title="Permalink to 在VPS上搭建LNMP(Linux/Nginx/MySQL/PHP)和PPTP">在VPS上搭建LNMP(Linux/Nginx/MySQL/PHP)和PPTP</a></h2>
			
			<div class="entry-byline">
				<a class="entry-date" rel="bookmark" title="2011-08-20T14:11:05+0000" href="http://liuxuan.info/2011/08/setup-lnmp-and-pptp-on-vps/"><abbr class="updated" title="2011-08-20T14:11:05+0000">Aug 20th, 2011</abbr></a>
				<address class="author vcard">by <a class="url fn" href="">Foredoomed</a>. </address>
				<a href="http://liuxuan.info/2011/08/setup-lnmp-and-pptp-on-vps/#comments" class="comments-link"  rel="nofollow" title="Comment on 在VPS上搭建LNMP(Linux/Nginx/MySQL/PHP)和PPTP">1 comment</a>							</div>
			
			<div class="entry-content">
				<a href="http://liuxuan.info/2011/08/setup-lnmp-and-pptp-on-vps/" title="在VPS上搭建LNMP(Linux/Nginx/MySQL/PHP)和PPTP"></a>				<p><strong>一.写在最前</strong></p>
<p>从我开博到现在也有半年有余了，之前一直是放在一个共享空间里。当初选择共享空间主要是因为价格便宜，而且我只在空间里放一个WordPress，不需要很大的空间和流量。但是在这半年多时间里，这个空间经常出现响应速度变得很慢，FTP和CPANEL无法登录等问题，真让我的忍耐到达了极点；再加上我们不知道什么原因访问一些网站经常返回错误页面，所以我决定抛弃这个空间(一年的时间还没到，浪费劳资的钱啊。。。)，转投VPS的怀抱。</p>
<p>其实在几年之前就知道VPS这样东西了，但是真正当我要去搞一个的时候，却发现有太多的选择。经过一番思想斗争，我最终选择了<a href="http://buyvm.net/" rel="nofollow"  title="buyvm">buyvm</a>这个VPS。如果你要问我为什么选择这个VPS，我想有三个原因：1.便宜 2.便宜 3.还是便宜。谁不想要被称为最好的VPS之称的<a href="http://www.linode.com/" rel="nofollow"  title="Linode">Linode</a>啊，但是穷逼只能捡便宜的用。当然，并不是便宜的就不好，buyvm的VPS虽然便宜，质量和服务也是非常好的，并且它还在<a href="http://www.lowendbox.com" rel="nofollow"  title="lowendbox">lowendbox</a>的评选中获得过第三名的好成绩。</p>
<p>重要的来了，你需要搞清楚在VPS上放些什么东西，因为这关系着你选OpenVZ还是Xen。提前告知一下：<strong>如果你想在VPS上装L2TP/IPSec VPN的话，就不要选OpenVZ</strong>。以我的经验来看，OpenVZ还是有很多限制的，如果手头宽裕的话还是首选Xen吧。好了，扯蛋完毕，开工搭建。</p>
<p><a href="http://www.flickr.com/photos/60110479@N08/6055625427/" rel="nofollow"  title="Flickr 上 Foredoomed 的 lnmp"><img src="http://farm7.static.flickr.com/6182/6055625427_8b11e5b85b.jpg" width="500" height="250" alt="6055625427 8b11e5b85b 在VPS上搭建LNMP(Linux/Nginx/MySQL/PHP)和PPTP"  title="在VPS上搭建LNMP(Linux/Nginx/MySQL/PHP)和PPTP" /></a></p>
<p><strong>二.安装LNMP+Dropbear+vsFTP</strong></p>
<p>本次搭建必要的是：</p>
<ul>
<li>1台VPS(这不是废话么)</li>
<li>CentOS操作系统(我的是CentOS 5.6，其他Linux发行版应该差不多)</li>
<li>能够以root权限从SSH登录</li>
<li>有足够的耐心和时间，因为接下来的工作还是蛮多的</li>
</ul>
<p><strong>1.安装必要的软件包</strong></p>
<p>首先以root权限从SSH登录，然后运行下面的命令：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;">yum <span style="color: #660033;">-y</span> <span style="color: #c20cb9; font-weight: bold;">install</span> <span style="color: #c20cb9; font-weight: bold;">gcc</span> gcc-c++ <span style="color: #c20cb9; font-weight: bold;">autoconf</span> libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel libxml2 libxml2-devel zlib zlib-devel glibc glibc-devel glib2 glib2-devel <span style="color: #c20cb9; font-weight: bold;">bzip2</span> bzip2-devel ncurses ncurses-devel curl curl-devel e2fsprogs e2fsprogs-devel krb5 krb5-devel libidn libidn-devel openssl openssl-devel openldap openldap-devel nss_ldap openldap-clients openldap-servers</pre></div></div>

<p><strong>2.在home目录新建一个software目录用来存放这次搭建所需的软件：</strong></p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #7a0874; font-weight: bold;">cd</span> ~
<span style="color: #c20cb9; font-weight: bold;">mkdir</span> software
<span style="color: #7a0874; font-weight: bold;">cd</span> software</pre></div></div>

<p>然后下载我们需要的软件：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">wget</span> http:<span style="color: #000000; font-weight: bold;">//</span>nginx.org<span style="color: #000000; font-weight: bold;">/</span>download<span style="color: #000000; font-weight: bold;">/</span>nginx-1.0.5.tar.gz
<span style="color: #c20cb9; font-weight: bold;">wget</span> http:<span style="color: #000000; font-weight: bold;">//</span>www.php.net<span style="color: #000000; font-weight: bold;">/</span>get<span style="color: #000000; font-weight: bold;">/</span>php-5.3.7.tar.gz<span style="color: #000000; font-weight: bold;">/</span>from<span style="color: #000000; font-weight: bold;">/</span>a<span style="color: #000000; font-weight: bold;">/</span>mirror
<span style="color: #c20cb9; font-weight: bold;">wget</span> http:<span style="color: #000000; font-weight: bold;">//</span>dev.mysql.com<span style="color: #000000; font-weight: bold;">/</span>downloads<span style="color: #000000; font-weight: bold;">/</span>mirror.php?<span style="color: #007800;">id</span>=<span style="color: #000000;">403104</span><span style="color: #666666; font-style: italic;">#mirrors</span>
<span style="color: #c20cb9; font-weight: bold;">wget</span> http:<span style="color: #000000; font-weight: bold;">//</span>ftp.gnu.org<span style="color: #000000; font-weight: bold;">/</span>pub<span style="color: #000000; font-weight: bold;">/</span>gnu<span style="color: #000000; font-weight: bold;">/</span>libiconv<span style="color: #000000; font-weight: bold;">/</span>libiconv-<span style="color: #000000;">1.14</span>.tar.gz
<span style="color: #c20cb9; font-weight: bold;">wget</span> http:<span style="color: #000000; font-weight: bold;">//</span>sourceforge.net<span style="color: #000000; font-weight: bold;">/</span>projects<span style="color: #000000; font-weight: bold;">/</span>mcrypt<span style="color: #000000; font-weight: bold;">/</span>files<span style="color: #000000; font-weight: bold;">/</span>Libmcrypt<span style="color: #000000; font-weight: bold;">/</span>2.5.8<span style="color: #000000; font-weight: bold;">/</span>libmcrypt-2.5.8.tar.bz2<span style="color: #000000; font-weight: bold;">/</span>download
<span style="color: #c20cb9; font-weight: bold;">wget</span> http:<span style="color: #000000; font-weight: bold;">//</span>sourceforge.net<span style="color: #000000; font-weight: bold;">/</span>projects<span style="color: #000000; font-weight: bold;">/</span>mcrypt<span style="color: #000000; font-weight: bold;">/</span>files<span style="color: #000000; font-weight: bold;">/</span>MCrypt<span style="color: #000000; font-weight: bold;">/</span>2.6.8<span style="color: #000000; font-weight: bold;">/</span>mcrypt-2.6.8.tar.gz<span style="color: #000000; font-weight: bold;">/</span>download
<span style="color: #c20cb9; font-weight: bold;">wget</span> http:<span style="color: #000000; font-weight: bold;">//</span>pecl.php.net<span style="color: #000000; font-weight: bold;">/</span>get<span style="color: #000000; font-weight: bold;">/</span>memcache-3.0.6.tgz
<span style="color: #c20cb9; font-weight: bold;">wget</span> http:<span style="color: #000000; font-weight: bold;">//</span>sourceforge.net<span style="color: #000000; font-weight: bold;">/</span>projects<span style="color: #000000; font-weight: bold;">/</span>mhash<span style="color: #000000; font-weight: bold;">/</span>files<span style="color: #000000; font-weight: bold;">/</span>mhash<span style="color: #000000; font-weight: bold;">/</span>0.9.9.9<span style="color: #000000; font-weight: bold;">/</span>mhash-0.9.9.9.tar.gz<span style="color: #000000; font-weight: bold;">/</span>download
<span style="color: #c20cb9; font-weight: bold;">wget</span> <span style="color: #c20cb9; font-weight: bold;">ftp</span>:<span style="color: #000000; font-weight: bold;">//</span>ftp.csx.cam.ac.uk<span style="color: #000000; font-weight: bold;">/</span>pub<span style="color: #000000; font-weight: bold;">/</span>software<span style="color: #000000; font-weight: bold;">/</span>programming<span style="color: #000000; font-weight: bold;">/</span>pcre<span style="color: #000000; font-weight: bold;">/</span>
<span style="color: #c20cb9; font-weight: bold;">wget</span> http:<span style="color: #000000; font-weight: bold;">//</span>pecl.php.net<span style="color: #000000; font-weight: bold;">/</span>get<span style="color: #000000; font-weight: bold;">/</span>APC-3.1.9.tgz
<span style="color: #c20cb9; font-weight: bold;">wget</span> http:<span style="color: #000000; font-weight: bold;">//</span>pecl.php.net<span style="color: #000000; font-weight: bold;">/</span>get<span style="color: #000000; font-weight: bold;">/</span>PDO_MYSQL-1.0.2.tgz
<span style="color: #c20cb9; font-weight: bold;">wget</span> <span style="color: #c20cb9; font-weight: bold;">ftp</span>:<span style="color: #000000; font-weight: bold;">//</span>ftp.imagemagick.org<span style="color: #000000; font-weight: bold;">/</span>pub<span style="color: #000000; font-weight: bold;">/</span>ImageMagick<span style="color: #000000; font-weight: bold;">/</span>ImageMagick.tar.gz
<span style="color: #c20cb9; font-weight: bold;">wget</span> http:<span style="color: #000000; font-weight: bold;">//</span>pecl.php.net<span style="color: #000000; font-weight: bold;">/</span>get<span style="color: #000000; font-weight: bold;">/</span>imagick-3.0.1.tgz</pre></div></div>

<p><strong>3.编译安装MySQL</strong></p>
<p>首先添加mysql用户组和用户：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>sbin<span style="color: #000000; font-weight: bold;">/</span>groupadd mysql
<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>sbin<span style="color: #000000; font-weight: bold;">/</span>useradd <span style="color: #660033;">-g</span> mysql mysql</pre></div></div>

<p>编译安装mysql：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">tar</span> zxvf mysql-5.1.58.tar.gz
<span style="color: #7a0874; font-weight: bold;">cd</span> mysql-5.1.58
.<span style="color: #000000; font-weight: bold;">/</span>configure <span style="color: #660033;">--prefix</span>=<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>mysql<span style="color: #000000; font-weight: bold;">/</span> <span style="color: #660033;">--localstatedir</span>=<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>mysql<span style="color: #000000; font-weight: bold;">/</span>data <span style="color: #660033;">--with-unix-socket-path</span>=<span style="color: #000000; font-weight: bold;">/</span>tmp<span style="color: #000000; font-weight: bold;">/</span>mysql.sock <span style="color: #660033;">--with-charset</span>=utf8 <span style="color: #660033;">--with-collation</span>=utf8_general_ci <span style="color: #660033;">--enable-assembler</span> <span style="color: #660033;">--with-extra-charsets</span>=complex <span style="color: #660033;">--enable-thread-safe-client</span> <span style="color: #660033;">--with-big-tables</span> <span style="color: #660033;">--with-readline</span> <span style="color: #660033;">--with-ssl</span> <span style="color: #660033;">--with-embedded-server</span> <span style="color: #660033;">--enable-local-infile</span> <span style="color: #660033;">--with-client-ldflags</span>=-all-static <span style="color: #660033;">--with-mysqld-ldflags</span>=-all-static <span style="color: #660033;">--with-plugins</span>=partition,innobase,myisammrg
<span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #000000; font-weight: bold;">&amp;&amp;</span> <span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #c20cb9; font-weight: bold;">install</span>
<span style="color: #c20cb9; font-weight: bold;">cp</span> support-files<span style="color: #000000; font-weight: bold;">/</span>my-medium.cnf <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>mysql<span style="color: #000000; font-weight: bold;">/</span>my.cnf</pre></div></div>

<p>赋予mysql权限：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">chmod</span> +<span style="color: #c20cb9; font-weight: bold;">w</span> <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>mysql
<span style="color: #c20cb9; font-weight: bold;">chown</span> <span style="color: #660033;">-R</span> mysql:mysql <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>mysql</pre></div></div>

<p>以mysql用户建立数据库表：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>mysql<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>mysql_install_db <span style="color: #660033;">--basedir</span>=<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>mysql <span style="color: #660033;">--datadir</span>=<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>mysql<span style="color: #000000; font-weight: bold;">/</span>data <span style="color: #660033;">--user</span>=mysql</pre></div></div>

<p>修改mysql的配置文件为：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #7a0874; font-weight: bold;">&#91;</span>client<span style="color: #7a0874; font-weight: bold;">&#93;</span>
character-set-server = utf8
port		= <span style="color: #000000;">3306</span>
socket		= <span style="color: #000000; font-weight: bold;">/</span>tmp<span style="color: #000000; font-weight: bold;">/</span>mysql.sock
&nbsp;
<span style="color: #7a0874; font-weight: bold;">&#91;</span>mysqld<span style="color: #7a0874; font-weight: bold;">&#93;</span>
character-set-server = utf8
port		= <span style="color: #000000;">3306</span>
socket		= <span style="color: #000000; font-weight: bold;">/</span>tmp<span style="color: #000000; font-weight: bold;">/</span>mysql.sock
skip-locking
key_buffer_size = 16M
max_allowed_packet = 16M
table_open_cache = <span style="color: #000000;">64</span>
sort_buffer_size = 128K
net_buffer_length = 8K
read_buffer_size = 256K
read_rnd_buffer_size = 512K
myisam_sort_buffer_size = 8M
&nbsp;
basedir = <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>mysql
datadir = <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>mysql<span style="color: #000000; font-weight: bold;">/</span>data
open_files_limit = <span style="color: #000000;">600</span>
back_log = <span style="color: #000000;">20</span>
max_connections = <span style="color: #000000;">100</span>
max_connect_errors = <span style="color: #000000;">200</span>
table_cache = <span style="color: #000000;">60</span>
external-locking = FALSE
join_buffer_size = 128K
thread_cache_size = <span style="color: #000000;">10</span>
thread_concurrency = <span style="color: #000000;">8</span>
query_cache_size = 0M
query_cache_limit = 2M
query_cache_min_res_unit = 2k
default_table_type = MyISAM
thread_stack = 192K
tmp_table_size = 512K
max_heap_table_size = 32M
long_query_time = <span style="color: #000000;">1</span>
log_long_format
binlog_cache_size = 2M
max_binlog_cache_size = 4M
max_binlog_size = 512M
expire_logs_days = <span style="color: #000000;">7</span>
&nbsp;
<span style="color: #7a0874; font-weight: bold;">&#91;</span>myisamchk<span style="color: #7a0874; font-weight: bold;">&#93;</span>
key_buffer_size = 4M
sort_buffer_size = 1M
read_buffer = 2M
write_buffer = 2M
&nbsp;
read_rnd_buffer_size = 2M
bulk_insert_buffer_size = 2M
myisam_sort_buffer_size = 4M
myisam_max_sort_file_size = 10G
myisam_max_extra_sort_file_size = 10G
myisam_repair_threads = <span style="color: #000000;">1</span>
myisam_recover</pre></div></div>

<p>创建一个脚本，方便管理mysql：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">vim</span> <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>mysql<span style="color: #000000; font-weight: bold;">/</span>mysql</pre></div></div>

<p>在其中添加下面的脚本命令：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #666666; font-style: italic;">#!/bin/sh</span>
&nbsp;
function_start_mysql<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>
<span style="color: #7a0874; font-weight: bold;">&#123;</span>
<span style="color: #7a0874; font-weight: bold;">printf</span> <span style="color: #ff0000;">&quot;Starting MySQL...<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span>
<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span><span style="color: #c20cb9; font-weight: bold;">sh</span> <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>mysql<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>mysqld_safe <span style="color: #660033;">--defaults-file</span>=<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>mysql<span style="color: #000000; font-weight: bold;">/</span>my.cnf <span style="color: #000000; font-weight: bold;">&amp;</span>
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
function_stop_mysql<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>
<span style="color: #7a0874; font-weight: bold;">&#123;</span>
<span style="color: #7a0874; font-weight: bold;">printf</span> <span style="color: #ff0000;">&quot;Stopping MySQL...<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span>
<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>mysql<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>mysqladmin <span style="color: #660033;">-u</span> mysql <span style="color: #660033;">-pmysql</span> shutdown
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
function_restart_mysql<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>
<span style="color: #7a0874; font-weight: bold;">&#123;</span>
<span style="color: #7a0874; font-weight: bold;">printf</span> <span style="color: #ff0000;">&quot;Restarting MySQL...<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span>
function_stop_mysql
<span style="color: #c20cb9; font-weight: bold;">sleep</span> <span style="color: #000000;">5</span>
function_start_mysql
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
function_kill_mysql<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>
<span style="color: #7a0874; font-weight: bold;">&#123;</span>
<span style="color: #c20cb9; font-weight: bold;">kill</span> <span style="color: #660033;">-9</span> $<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #c20cb9; font-weight: bold;">ps</span> <span style="color: #660033;">-ef</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">grep</span> <span style="color: #ff0000;">'bin/mysqld_safe'</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">grep</span> <span style="color: #000000;">3306</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">awk</span> <span style="color: #ff0000;">'{printf $2}'</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>
<span style="color: #c20cb9; font-weight: bold;">kill</span> <span style="color: #660033;">-9</span> $<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #c20cb9; font-weight: bold;">ps</span> <span style="color: #660033;">-ef</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">grep</span> <span style="color: #ff0000;">'libexec/mysqld'</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">grep</span> <span style="color: #000000;">3306</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">awk</span> <span style="color: #ff0000;">'{printf $2}'</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#91;</span> <span style="color: #ff0000;">&quot;$1&quot;</span> = <span style="color: #ff0000;">&quot;start&quot;</span> <span style="color: #7a0874; font-weight: bold;">&#93;</span>; <span style="color: #000000; font-weight: bold;">then</span>
function_start_mysql
<span style="color: #000000; font-weight: bold;">elif</span> <span style="color: #7a0874; font-weight: bold;">&#91;</span> <span style="color: #ff0000;">&quot;$1&quot;</span> = <span style="color: #ff0000;">&quot;stop&quot;</span> <span style="color: #7a0874; font-weight: bold;">&#93;</span>; <span style="color: #000000; font-weight: bold;">then</span>
function_stop_mysql
<span style="color: #000000; font-weight: bold;">elif</span> <span style="color: #7a0874; font-weight: bold;">&#91;</span> <span style="color: #ff0000;">&quot;$1&quot;</span> = <span style="color: #ff0000;">&quot;restart&quot;</span> <span style="color: #7a0874; font-weight: bold;">&#93;</span>; <span style="color: #000000; font-weight: bold;">then</span>
function_restart_mysql
<span style="color: #000000; font-weight: bold;">elif</span> <span style="color: #7a0874; font-weight: bold;">&#91;</span> <span style="color: #ff0000;">&quot;$1&quot;</span> = <span style="color: #ff0000;">&quot;kill&quot;</span> <span style="color: #7a0874; font-weight: bold;">&#93;</span>; <span style="color: #000000; font-weight: bold;">then</span>
function_kill_mysql
<span style="color: #000000; font-weight: bold;">else</span>
<span style="color: #7a0874; font-weight: bold;">printf</span> <span style="color: #ff0000;">&quot;Usage: /usr/local/webserver/mysql {start|stop|restart|kill}<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span>
<span style="color: #000000; font-weight: bold;">fi</span></pre></div></div>

<p>然后赋予脚本执行权限：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">chmod</span> +x <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>mysql<span style="color: #000000; font-weight: bold;">/</span>mysql</pre></div></div>

<p>启动mysql：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>mysql<span style="color: #000000; font-weight: bold;">/</span>mysql start</pre></div></div>

<p>给mysql用户赋予数据库的所有权限：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;">GRANT ALL PRIVILEGES ON <span style="color: #000000; font-weight: bold;">*</span>.<span style="color: #000000; font-weight: bold;">*</span> TO <span style="color: #ff0000;">'mysql'</span><span style="color: #000000; font-weight: bold;">@</span><span style="color: #ff0000;">'localhost'</span> IDENTIFIED BY <span style="color: #ff0000;">'mysql'</span>;
GRANT ALL PRIVILEGES ON <span style="color: #000000; font-weight: bold;">*</span>.<span style="color: #000000; font-weight: bold;">*</span> TO <span style="color: #ff0000;">'mysql'</span><span style="color: #000000; font-weight: bold;">@</span><span style="color: #ff0000;">'127.0.0.1'</span> IDENTIFIED BY <span style="color: #ff0000;">'mysql'</span>;</pre></div></div>

<p>配置开机自启动mysql</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">vim</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>rc.local
<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>mysql<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>mysqld_safe <span style="color: #660033;">--defaults-file</span>=<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>mysql<span style="color: #000000; font-weight: bold;">/</span>my.cnf <span style="color: #000000; font-weight: bold;">&amp;</span></pre></div></div>

<p><strong>4.编译安装PHP</strong></p>
<p>首先创建一个用户和组(用来管理PHP/Nginx/Wordpress)<br />
创建用户和组</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;">groupadd www
useradd <span style="color: #660033;">-g</span> www www
<span style="color: #c20cb9; font-weight: bold;">mkdir</span> <span style="color: #660033;">-p</span> <span style="color: #000000; font-weight: bold;">/</span>data<span style="color: #000000; font-weight: bold;">/</span>htdocs<span style="color: #000000; font-weight: bold;">/</span>blog  <span style="color: #000000; font-weight: bold;">//</span>blog目录是Wordpress的根目录
<span style="color: #c20cb9; font-weight: bold;">chmod</span> +<span style="color: #c20cb9; font-weight: bold;">w</span> <span style="color: #000000; font-weight: bold;">/</span>data<span style="color: #000000; font-weight: bold;">/</span>htdocs<span style="color: #000000; font-weight: bold;">/</span>blog
<span style="color: #c20cb9; font-weight: bold;">chown</span> <span style="color: #660033;">-R</span> www:www <span style="color: #000000; font-weight: bold;">/</span>data<span style="color: #000000; font-weight: bold;">/</span>htdocs<span style="color: #000000; font-weight: bold;">/</span>blog</pre></div></div>

<p>编译安装PHP所需的支持库：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">tar</span> zxvf libiconv-<span style="color: #000000;">1.14</span>.tar.gz
<span style="color: #7a0874; font-weight: bold;">cd</span> libiconv-1.13.1<span style="color: #000000; font-weight: bold;">/</span>
.<span style="color: #000000; font-weight: bold;">/</span>configure <span style="color: #660033;">--prefix</span>=<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span><span style="color: #7a0874; font-weight: bold;">local</span>
<span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #000000; font-weight: bold;">&amp;&amp;</span> <span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #c20cb9; font-weight: bold;">install</span>
&nbsp;
<span style="color: #c20cb9; font-weight: bold;">tar</span> zxvf libmcrypt-2.5.8.tar.gz
<span style="color: #7a0874; font-weight: bold;">cd</span> libmcrypt-2.5.8<span style="color: #000000; font-weight: bold;">/</span>
.<span style="color: #000000; font-weight: bold;">/</span>configure
<span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #000000; font-weight: bold;">&amp;&amp;</span> <span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #c20cb9; font-weight: bold;">install</span>
<span style="color: #000000; font-weight: bold;">/</span>sbin<span style="color: #000000; font-weight: bold;">/</span>ldconfig
<span style="color: #7a0874; font-weight: bold;">cd</span> libltdl
.<span style="color: #000000; font-weight: bold;">/</span>configure <span style="color: #660033;">--enable-ltdl-install</span>
<span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #000000; font-weight: bold;">&amp;&amp;</span> <span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #c20cb9; font-weight: bold;">install</span>
&nbsp;
<span style="color: #c20cb9; font-weight: bold;">tar</span> zxvf mhash-0.9.9.9.tar.gz
<span style="color: #7a0874; font-weight: bold;">cd</span> mhash-0.9.9.9<span style="color: #000000; font-weight: bold;">/</span>
.<span style="color: #000000; font-weight: bold;">/</span>configure
<span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #000000; font-weight: bold;">&amp;&amp;</span> <span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #c20cb9; font-weight: bold;">install</span>
&nbsp;
<span style="color: #c20cb9; font-weight: bold;">tar</span> zxvf mcrypt-2.6.8.tar.gz
<span style="color: #7a0874; font-weight: bold;">cd</span> mcrypt-2.6.8<span style="color: #000000; font-weight: bold;">/</span>
<span style="color: #000000; font-weight: bold;">/</span>sbin<span style="color: #000000; font-weight: bold;">/</span>ldconfig
.<span style="color: #000000; font-weight: bold;">/</span>configure
<span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #000000; font-weight: bold;">&amp;&amp;</span> <span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #c20cb9; font-weight: bold;">install</span>
&nbsp;
<span style="color: #c20cb9; font-weight: bold;">ln</span> <span style="color: #660033;">-s</span> <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>lib<span style="color: #000000; font-weight: bold;">/</span>libmcrypt.la <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>lib<span style="color: #000000; font-weight: bold;">/</span>libmcrypt.la
<span style="color: #c20cb9; font-weight: bold;">ln</span> <span style="color: #660033;">-s</span> <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>lib<span style="color: #000000; font-weight: bold;">/</span>libmcrypt.so <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>lib<span style="color: #000000; font-weight: bold;">/</span>libmcrypt.so
<span style="color: #c20cb9; font-weight: bold;">ln</span> <span style="color: #660033;">-s</span> <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>lib<span style="color: #000000; font-weight: bold;">/</span>libmcrypt.so.4 <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>lib<span style="color: #000000; font-weight: bold;">/</span>libmcrypt.so.4
<span style="color: #c20cb9; font-weight: bold;">ln</span> <span style="color: #660033;">-s</span> <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>lib<span style="color: #000000; font-weight: bold;">/</span>libmcrypt.so.4.4.8 <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>lib<span style="color: #000000; font-weight: bold;">/</span>libmcrypt.so.4.4.8
<span style="color: #c20cb9; font-weight: bold;">ln</span> <span style="color: #660033;">-s</span> <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>lib<span style="color: #000000; font-weight: bold;">/</span>libmhash.a <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>lib<span style="color: #000000; font-weight: bold;">/</span>libmhash.a
<span style="color: #c20cb9; font-weight: bold;">ln</span> <span style="color: #660033;">-s</span> <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>lib<span style="color: #000000; font-weight: bold;">/</span>libmhash.la <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>lib<span style="color: #000000; font-weight: bold;">/</span>libmhash.la
<span style="color: #c20cb9; font-weight: bold;">ln</span> <span style="color: #660033;">-s</span> <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>lib<span style="color: #000000; font-weight: bold;">/</span>libmhash.so <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>lib<span style="color: #000000; font-weight: bold;">/</span>libmhash.so
<span style="color: #c20cb9; font-weight: bold;">ln</span> <span style="color: #660033;">-s</span> <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>lib<span style="color: #000000; font-weight: bold;">/</span>libmhash.so.2 <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>lib<span style="color: #000000; font-weight: bold;">/</span>libmhash.so.2
<span style="color: #c20cb9; font-weight: bold;">ln</span> <span style="color: #660033;">-s</span> <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>lib<span style="color: #000000; font-weight: bold;">/</span>libmhash.so.2.0.1 <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>lib<span style="color: #000000; font-weight: bold;">/</span>libmhash.so.2.0.1
<span style="color: #c20cb9; font-weight: bold;">ln</span> <span style="color: #660033;">-s</span> <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>libmcrypt-config <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>libmcrypt-config</pre></div></div>


<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">tar</span> zxvf php-5.3.7.tar.gz
<span style="color: #7a0874; font-weight: bold;">cd</span> php-5.3.7
.<span style="color: #000000; font-weight: bold;">/</span>configure <span style="color: #660033;">--prefix</span>=<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>php <span style="color: #660033;">--with-config-file-path</span>=<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>php<span style="color: #000000; font-weight: bold;">/</span>etc <span style="color: #660033;">--with-mysql</span>=<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>mysql <span style="color: #660033;">--with-mysqli</span>=<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>mysql<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>mysql_config <span style="color: #660033;">--with-iconv-dir</span>=<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span><span style="color: #7a0874; font-weight: bold;">local</span> <span style="color: #660033;">--with-freetype-dir</span> <span style="color: #660033;">--with-jpeg-dir</span> <span style="color: #660033;">--with-png-dir</span> <span style="color: #660033;">--with-zlib</span> <span style="color: #660033;">--with-libxml-dir</span>=<span style="color: #000000; font-weight: bold;">/</span>usr <span style="color: #660033;">--enable-xml</span> <span style="color: #660033;">--disable-rpath</span>  <span style="color: #660033;">--enable-safe-mode</span> <span style="color: #660033;">--enable-bcmath</span> <span style="color: #660033;">--enable-shmop</span> <span style="color: #660033;">--enable-sysvsem</span> <span style="color: #660033;">--enable-inline-optimization</span> <span style="color: #660033;">--with-curl</span> <span style="color: #660033;">--with-curlwrappers</span> <span style="color: #660033;">--enable-mbregex</span>  <span style="color: #660033;">--enable-fpm</span>  <span style="color: #660033;">--enable-mbstring</span> <span style="color: #660033;">--with-mcrypt</span> <span style="color: #660033;">--with-gd</span> <span style="color: #660033;">--enable-gd-native-ttf</span> <span style="color: #660033;">--with-openssl</span> <span style="color: #660033;">--with-mhash</span> <span style="color: #660033;">--enable-pcntl</span> <span style="color: #660033;">--enable-sockets</span> <span style="color: #660033;">--with-ldap</span> <span style="color: #660033;">--with-ldap-sasl</span> <span style="color: #660033;">--with-xmlrpc</span> <span style="color: #660033;">--enable-ftp</span> <span style="color: #660033;">--enable-zip</span> <span style="color: #660033;">--enable-exif</span> <span style="color: #660033;">--enable-soap</span> <span style="color: #660033;">--without-pear</span> <span style="color: #660033;">--with-fpm-user</span>=www <span style="color: #660033;">--with-fpm-group</span>=www
<span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #007800;">ZEND_EXTRA_LIBS</span>=<span style="color: #ff0000;">'-liconv'</span></pre></div></div>

<p>如果遇到下面的问题：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #000000; font-weight: bold;">/</span>root<span style="color: #000000; font-weight: bold;">/</span>source<span style="color: #000000; font-weight: bold;">/</span>php-5.3.7<span style="color: #000000; font-weight: bold;">/</span>sapi<span style="color: #000000; font-weight: bold;">/</span>cli<span style="color: #000000; font-weight: bold;">/</span>php: error <span style="color: #000000; font-weight: bold;">while</span> loading shared libraries: libmysqlclient.so.18: cannot open shared object <span style="color: #c20cb9; font-weight: bold;">file</span>: No such <span style="color: #c20cb9; font-weight: bold;">file</span> or directory
<span style="color: #c20cb9; font-weight: bold;">make</span>: <span style="color: #000000; font-weight: bold;">***</span> <span style="color: #7a0874; font-weight: bold;">&#91;</span>ext<span style="color: #000000; font-weight: bold;">/</span>phar<span style="color: #000000; font-weight: bold;">/</span>phar.php<span style="color: #7a0874; font-weight: bold;">&#93;</span> Error <span style="color: #000000;">127</span></pre></div></div>

<p>解决方法：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">ln</span> <span style="color: #660033;">-s</span> <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>mysql<span style="color: #000000; font-weight: bold;">/</span>lib<span style="color: #000000; font-weight: bold;">/</span>libmysqlclient.so.18 <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>lib<span style="color: #000000; font-weight: bold;">/</span></pre></div></div>

<p>然后再执行：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #c20cb9; font-weight: bold;">install</span>
<span style="color: #c20cb9; font-weight: bold;">cp</span> php.ini-production <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>php<span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>php.ini</pre></div></div>

<p>安装PHP扩展包：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">tar</span> zxvf memcache-3.0.6.tgz
<span style="color: #7a0874; font-weight: bold;">cd</span> memcache-3.0.6
<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>php<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>phpize
.<span style="color: #000000; font-weight: bold;">/</span>configure <span style="color: #660033;">--with-php-config</span>=<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>php<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>php-config
<span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #000000; font-weight: bold;">&amp;&amp;</span> <span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #c20cb9; font-weight: bold;">install</span>
&nbsp;
<span style="color: #c20cb9; font-weight: bold;">tar</span> jxvf APC-3.1.9.tgz
<span style="color: #7a0874; font-weight: bold;">cd</span> APC-3.1.9
<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>php<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>phpize
.<span style="color: #000000; font-weight: bold;">/</span>configure <span style="color: #660033;">--with-php-config</span>=<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>php<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>php-config <span style="color: #660033;">--prefix</span>=<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span> <span style="color: #660033;">--enable-apc</span> <span style="color: #660033;">--enable-apc-mmap</span> <span style="color: #660033;">--enable-apc-spinlocks</span>
<span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #000000; font-weight: bold;">&amp;&amp;</span> <span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #c20cb9; font-weight: bold;">install</span>
&nbsp;
<span style="color: #c20cb9; font-weight: bold;">tar</span> zxvf PDO_MYSQL-1.0.2.tgz
<span style="color: #7a0874; font-weight: bold;">cd</span> PDO_MYSQL-1.0.2
<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>php<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>phpize
.<span style="color: #000000; font-weight: bold;">/</span>configure <span style="color: #660033;">--with-php-config</span>=<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>php<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>php-config <span style="color: #660033;">--with-pdo-mysql</span>=<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>mysql
<span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #000000; font-weight: bold;">&amp;&amp;</span> <span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #c20cb9; font-weight: bold;">install</span>
&nbsp;
<span style="color: #c20cb9; font-weight: bold;">tar</span> zxvf ImageMagick.tar.gz
<span style="color: #7a0874; font-weight: bold;">cd</span> ImageMagick-6.7.1-<span style="color: #000000;">7</span>
.<span style="color: #000000; font-weight: bold;">/</span>configure
<span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #000000; font-weight: bold;">&amp;&amp;</span> <span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #c20cb9; font-weight: bold;">install</span>
&nbsp;
<span style="color: #c20cb9; font-weight: bold;">tar</span> zxvf imagick-3.0.1.tgz
<span style="color: #7a0874; font-weight: bold;">cd</span> imagick-3.0.1
<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>php<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>phpize
.<span style="color: #000000; font-weight: bold;">/</span>configure <span style="color: #660033;">--with-php-config</span>=<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>php<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>php-config
<span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #000000; font-weight: bold;">&amp;&amp;</span> <span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #c20cb9; font-weight: bold;">install</span></pre></div></div>

<p>修改php.ini文件:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;">output_buffering = On
cgi.fix_pathinfo = <span style="color: #000000;">0</span>
&nbsp;
extension_dir = <span style="color: #ff0000;">&quot;/usr/local/webserver/php/lib/php/extensions/no-debug-non-zts-20090626/&quot;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">//</span>并在此行后增加以下几行
extension = <span style="color: #ff0000;">&quot;memcache.so&quot;</span>
extension = <span style="color: #ff0000;">&quot;pdo_mysql.so&quot;</span>
extension = <span style="color: #ff0000;">&quot;imagick.so&quot;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">//</span>用APC代替eaccelerator
<span style="color: #7a0874; font-weight: bold;">&#91;</span>APC<span style="color: #7a0874; font-weight: bold;">&#93;</span>
apc.enabled = <span style="color: #000000;">1</span>
apc.shm_segments = <span style="color: #000000;">1</span>
apc.shm_size = 8M
apc.ttl = <span style="color: #000000;">7200</span>
apc.user_ttl = <span style="color: #000000;">7200</span>
apc.optimization = <span style="color: #000000;">1</span>
apc.num_files_hint = <span style="color: #000000;">1024</span>
apc.mmap_file_mask =<span style="color: #000000; font-weight: bold;">/</span>tmp<span style="color: #000000; font-weight: bold;">/</span>apc.XXXXXX 
apc.enable_cli = <span style="color: #000000;">1</span></pre></div></div>

<p>打开php-fpm.conf文件:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">vim</span> <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>php<span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>php-fpm.conf</pre></div></div>

<p>修改添加如下配置：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;">pm.max_children = <span style="color: #000000;">1</span>
pid = run<span style="color: #000000; font-weight: bold;">/</span>php-fpm.pid
error_log = log<span style="color: #000000; font-weight: bold;">/</span>php-fpm.log
log_level = notice
emergency_restart_threshold :<span style="color: #000000;">10</span>
emergency_restart_interval:1m
process_control_timeout:5s
daemonize:<span style="color: #c20cb9; font-weight: bold;">yes</span>
&nbsp;
backlog:-<span style="color: #000000;">1</span>
listen.owner = www
listen.group = www
listen.mode = 0666
user = www
group = www
pm = static
request_terminate_timeout = <span style="color: #000000;">0</span>
request_slowlog_timeout = 0s
slowlog = log<span style="color: #000000; font-weight: bold;">/</span><span style="color: #007800;">$pool</span>.log.slow
rlimit_files = <span style="color: #000000;">51200</span>
rlimit_core = <span style="color: #000000;">0</span>
catch_workers_output = <span style="color: #c20cb9; font-weight: bold;">yes</span>
pm.max_requests = <span style="color: #000000;">500</span>
listen.allowed_clients = 127.0.0.1
<span style="color: #c20cb9; font-weight: bold;">env</span><span style="color: #7a0874; font-weight: bold;">&#91;</span>HOSTNAME<span style="color: #7a0874; font-weight: bold;">&#93;</span> = <span style="color: #007800;">$HOSTNAME</span>
<span style="color: #c20cb9; font-weight: bold;">env</span><span style="color: #7a0874; font-weight: bold;">&#91;</span>PATH<span style="color: #7a0874; font-weight: bold;">&#93;</span> = <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>bin:<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>bin:<span style="color: #000000; font-weight: bold;">/</span>bin
<span style="color: #c20cb9; font-weight: bold;">env</span><span style="color: #7a0874; font-weight: bold;">&#91;</span>TMP<span style="color: #7a0874; font-weight: bold;">&#93;</span> = <span style="color: #000000; font-weight: bold;">/</span>tmp
<span style="color: #c20cb9; font-weight: bold;">env</span><span style="color: #7a0874; font-weight: bold;">&#91;</span>TMPDIR<span style="color: #7a0874; font-weight: bold;">&#93;</span> = <span style="color: #000000; font-weight: bold;">/</span>tmp
<span style="color: #c20cb9; font-weight: bold;">env</span><span style="color: #7a0874; font-weight: bold;">&#91;</span>TEMP<span style="color: #7a0874; font-weight: bold;">&#93;</span> = <span style="color: #000000; font-weight: bold;">/</span>tmp
<span style="color: #c20cb9; font-weight: bold;">env</span><span style="color: #7a0874; font-weight: bold;">&#91;</span>OSTYPE<span style="color: #7a0874; font-weight: bold;">&#93;</span> = <span style="color: #007800;">$OSTYPE</span>
<span style="color: #c20cb9; font-weight: bold;">env</span><span style="color: #7a0874; font-weight: bold;">&#91;</span>MACHTYPE<span style="color: #7a0874; font-weight: bold;">&#93;</span> = <span style="color: #007800;">$MACHTYPE</span>
<span style="color: #c20cb9; font-weight: bold;">env</span><span style="color: #7a0874; font-weight: bold;">&#91;</span>MALLOC_CHECK_<span style="color: #7a0874; font-weight: bold;">&#93;</span> = <span style="color: #000000;">2</span></pre></div></div>

<p>启动php-fpm：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>php<span style="color: #000000; font-weight: bold;">/</span>sbin<span style="color: #000000; font-weight: bold;">/</span>php-fpm</pre></div></div>

<p>配置开机自动启动php-fpm:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">vim</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>rc.local
<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>php<span style="color: #000000; font-weight: bold;">/</span>sbin<span style="color: #000000; font-weight: bold;">/</span>php-fpm</pre></div></div>

<p><strong>5.编译安装Nginx</strong><br />
首先编译安装Nginx所需的pcre库：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">tar</span> zxvf pcre-<span style="color: #000000;">8.12</span>.tar.gz
<span style="color: #7a0874; font-weight: bold;">cd</span> pcre-<span style="color: #000000;">8.12</span>
.<span style="color: #000000; font-weight: bold;">/</span>configure
<span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #000000; font-weight: bold;">&amp;&amp;</span> <span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #c20cb9; font-weight: bold;">install</span></pre></div></div>

<p>编译安装Nginx:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">tar</span> zxvf nginx-1.0.5.tar.gz
<span style="color: #7a0874; font-weight: bold;">cd</span> nginx-1.0.5
.<span style="color: #000000; font-weight: bold;">/</span>configure <span style="color: #660033;">--user</span>=www <span style="color: #660033;">--group</span>=www <span style="color: #660033;">--prefix</span>=<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>nginx --with-http_stub_status_module --with-http_ssl_module
<span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #000000; font-weight: bold;">&amp;&amp;</span> <span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #c20cb9; font-weight: bold;">install</span></pre></div></div>

<p>创建Nginx日志目录:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">mkdir</span> <span style="color: #660033;">-p</span> <span style="color: #000000; font-weight: bold;">/</span>data<span style="color: #000000; font-weight: bold;">/</span>log
<span style="color: #c20cb9; font-weight: bold;">chmod</span> +<span style="color: #c20cb9; font-weight: bold;">w</span> <span style="color: #000000; font-weight: bold;">/</span>data<span style="color: #000000; font-weight: bold;">/</span>log
<span style="color: #c20cb9; font-weight: bold;">chown</span> <span style="color: #660033;">-R</span> www:www <span style="color: #000000; font-weight: bold;">/</span>data<span style="color: #000000; font-weight: bold;">/</span>log</pre></div></div>

<p>修改Nginx配置文件:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;">user  www www;
&nbsp;
worker_processes <span style="color: #000000;">1</span>;
&nbsp;
error_log  <span style="color: #000000; font-weight: bold;">/</span>data<span style="color: #000000; font-weight: bold;">/</span>log<span style="color: #000000; font-weight: bold;">/</span>nginx_error.log  crit;
&nbsp;
pid        <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>nginx<span style="color: #000000; font-weight: bold;">/</span>nginx.pid;
&nbsp;
<span style="color: #666666; font-style: italic;">#Specifies the value for maximum file descriptors that can be opened by this process.</span>
worker_rlimit_nofile <span style="color: #000000;">65535</span>;
&nbsp;
events
<span style="color: #7a0874; font-weight: bold;">&#123;</span>
  use epoll;
  worker_connections <span style="color: #000000;">65535</span>;
<span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
http
<span style="color: #7a0874; font-weight: bold;">&#123;</span>
  include       mime.types;
  default_type  application<span style="color: #000000; font-weight: bold;">/</span>octet-stream;
&nbsp;
  <span style="color: #666666; font-style: italic;">#charset  gb2312;</span>
&nbsp;
  server_names_hash_bucket_size <span style="color: #000000;">128</span>;
  client_header_buffer_size 32k;
  large_client_header_buffers <span style="color: #000000;">4</span> 32k;
  client_max_body_size 8m;
&nbsp;
  sendfile on;
  tcp_nopush     on;
  keepalive_timeout <span style="color: #000000;">10</span> <span style="color: #000000;">10</span>;
  tcp_nodelay on;
&nbsp;
  fastcgi_connect_timeout <span style="color: #000000;">300</span>;
  fastcgi_send_timeout <span style="color: #000000;">300</span>;
  fastcgi_read_timeout <span style="color: #000000;">300</span>;
  fastcgi_buffer_size 32k;
  fastcgi_buffers <span style="color: #000000;">4</span> 32k;
  fastcgi_busy_buffers_size 32k;
  fastcgi_temp_file_write_size 32k;
&nbsp;
  fastcgi_intercept_errors on;
&nbsp;
  <span style="color: #c20cb9; font-weight: bold;">gzip</span> on;
  gzip_min_length  1k;
  gzip_buffers     <span style="color: #000000;">4</span> 16k;
  gzip_http_version <span style="color: #000000;">1.0</span>;
  gzip_comp_level <span style="color: #000000;">1</span>;
  gzip_types       text<span style="color: #000000; font-weight: bold;">/</span>plain application<span style="color: #000000; font-weight: bold;">/</span>x-javascript text<span style="color: #000000; font-weight: bold;">/</span>css application<span style="color: #000000; font-weight: bold;">/</span>xml;
  gzip_vary on;
&nbsp;
  <span style="color: #666666; font-style: italic;">#limit_zone  crawler  $binary_remote_addr  10m;</span>
&nbsp;
&nbsp;
  server
  <span style="color: #7a0874; font-weight: bold;">&#123;</span>
    listen       <span style="color: #000000;">80</span>;
    server_name  liuxuan.info www.liuxuan.info;
    index index.html index.htm index.php;
    root  <span style="color: #000000; font-weight: bold;">/</span>data<span style="color: #000000; font-weight: bold;">/</span>htdocs<span style="color: #000000; font-weight: bold;">/</span>blog;
&nbsp;
    <span style="color: #666666; font-style: italic;">#limit_conn   crawler  20;</span>
&nbsp;
    location <span style="color: #000000; font-weight: bold;">/</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>          
       try_files <span style="color: #007800;">$uri</span> <span style="color: #007800;">$uri</span><span style="color: #000000; font-weight: bold;">/</span> <span style="color: #000000; font-weight: bold;">/</span>index.php?<span style="color: #007800;">q</span>=<span style="color: #007800;">$uri</span><span style="color: #000000; font-weight: bold;">&amp;</span><span style="color: #007800;">$args</span>;    
    <span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
    <span style="color: #666666; font-style: italic;"># if file exists return it right away</span>
    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span>-f <span style="color: #007800;">$request_filename</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>      
       <span style="color: #7a0874; font-weight: bold;">break</span>;
    <span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
    <span style="color: #666666; font-style: italic;"># otherwise rewrite the request</span>
    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #000000; font-weight: bold;">!</span>-e <span style="color: #007800;">$request_filename</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span>
       rewrite ^<span style="color: #7a0874; font-weight: bold;">&#40;</span>.+<span style="color: #7a0874; font-weight: bold;">&#41;</span>$ <span style="color: #000000; font-weight: bold;">/</span>index.php<span style="color: #007800;">$1</span> <span style="color: #c20cb9; font-weight: bold;">last</span>;
       <span style="color: #7a0874; font-weight: bold;">break</span>;
    <span style="color: #7a0874; font-weight: bold;">&#125;</span>    
&nbsp;
&nbsp;
    location ~ .<span style="color: #000000; font-weight: bold;">*</span>\.<span style="color: #7a0874; font-weight: bold;">&#40;</span>php<span style="color: #000000; font-weight: bold;">|</span>php5<span style="color: #7a0874; font-weight: bold;">&#41;</span>?$
    <span style="color: #7a0874; font-weight: bold;">&#123;</span>      
      fastcgi_pass  unix:<span style="color: #000000; font-weight: bold;">/</span>tmp<span style="color: #000000; font-weight: bold;">/</span>php-cgi.sock;
      <span style="color: #666666; font-style: italic;">#fastcgi_pass  127.0.0.1:9000;</span>
      fastcgi_index index.php;
      include fastcgi.conf;
&nbsp;
    <span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
    location ~ .<span style="color: #000000; font-weight: bold;">*</span>\.<span style="color: #7a0874; font-weight: bold;">&#40;</span>gif<span style="color: #000000; font-weight: bold;">|</span>jpg<span style="color: #000000; font-weight: bold;">|</span>jpeg<span style="color: #000000; font-weight: bold;">|</span>png<span style="color: #000000; font-weight: bold;">|</span>bmp<span style="color: #000000; font-weight: bold;">|</span>swf<span style="color: #7a0874; font-weight: bold;">&#41;</span>$
    <span style="color: #7a0874; font-weight: bold;">&#123;</span>
      access_log off;
      expires      30d;
    <span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
    location ~ .<span style="color: #000000; font-weight: bold;">*</span>\.<span style="color: #7a0874; font-weight: bold;">&#40;</span>js<span style="color: #000000; font-weight: bold;">|</span>css<span style="color: #7a0874; font-weight: bold;">&#41;</span>?$
    <span style="color: #7a0874; font-weight: bold;">&#123;</span>
      access_log off;
      expires      1d;
    <span style="color: #7a0874; font-weight: bold;">&#125;</span>    
&nbsp;
    <span style="color: #666666; font-style: italic;"># Only allow search engine to access pics</span>
    location ~ .<span style="color: #000000; font-weight: bold;">*</span>\.<span style="color: #7a0874; font-weight: bold;">&#40;</span>gif<span style="color: #000000; font-weight: bold;">|</span>jpg<span style="color: #000000; font-weight: bold;">|</span>jpeg<span style="color: #000000; font-weight: bold;">|</span>png<span style="color: #000000; font-weight: bold;">|</span>bmp<span style="color: #000000; font-weight: bold;">|</span>swf<span style="color: #000000; font-weight: bold;">|</span>flv<span style="color: #7a0874; font-weight: bold;">&#41;</span>$
    <span style="color: #7a0874; font-weight: bold;">&#123;</span>
	valid_referers none blocked <span style="color: #000000; font-weight: bold;">*</span>.liuxuan.info <span style="color: #000000; font-weight: bold;">*</span>.google.com <span style="color: #000000; font-weight: bold;">*</span>.baidu.com;
	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #007800;">$invalid_referer</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>
	<span style="color: #7a0874; font-weight: bold;">&#123;</span>
		<span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #000000;">403</span>;
	<span style="color: #7a0874; font-weight: bold;">&#125;</span>
    <span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
&nbsp;
    log_format  access  <span style="color: #ff0000;">'$remote_addr - $remote_user [$time_local] &quot;$request&quot; '</span>
              <span style="color: #ff0000;">'$status $body_bytes_sent &quot;$http_referer&quot; '</span>
              <span style="color: #ff0000;">'&quot;$http_user_agent&quot; $http_x_forwarded_for'</span>;
    access_log  <span style="color: #000000; font-weight: bold;">/</span>data<span style="color: #000000; font-weight: bold;">/</span>log<span style="color: #000000; font-weight: bold;">/</span>access.log  access;
  <span style="color: #7a0874; font-weight: bold;">&#125;</span>
&nbsp;
&nbsp;
<span style="color: #7a0874; font-weight: bold;">&#125;</span></pre></div></div>

<p>检查Nginx配置是否正确：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>nginx<span style="color: #000000; font-weight: bold;">/</span>sbin<span style="color: #000000; font-weight: bold;">/</span>nginx <span style="color: #660033;">-t</span></pre></div></div>

<p>启动Nginx：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>nginx<span style="color: #000000; font-weight: bold;">/</span>sbin<span style="color: #000000; font-weight: bold;">/</span>nginx</pre></div></div>

<p>配置开机自动启动Nginx：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">vim</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>rc.local
<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>nginx<span style="color: #000000; font-weight: bold;">/</span>sbin<span style="color: #000000; font-weight: bold;">/</span>nginx</pre></div></div>

<p>在不停止Nginx服务的情况下平滑变更Nginx配置：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">kill</span> <span style="color: #660033;">-HUP</span> <span style="color: #000000; font-weight: bold;">`</span><span style="color: #c20cb9; font-weight: bold;">cat</span> <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>webserver<span style="color: #000000; font-weight: bold;">/</span>nginx<span style="color: #000000; font-weight: bold;">/</span>nginx.pid<span style="color: #000000; font-weight: bold;">`</span></pre></div></div>

<p><strong>6.Linux设置：</strong></p>
<p>修改服务器时间为上海时间：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">cp</span> <span style="color: #660033;">-f</span> <span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>share<span style="color: #000000; font-weight: bold;">/</span>zoneinfo<span style="color: #000000; font-weight: bold;">/</span>Asia<span style="color: #000000; font-weight: bold;">/</span>Shanghai <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>localtime</pre></div></div>

<p>关闭不需要的服务：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;">ntsysv  <span style="color: #000000; font-weight: bold;">//</span>按空格选择和取消，按F12退出</pre></div></div>

<p>以下仅列出需要启动的服务，未列出的服务一律关闭：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;">crond
iptables
network
syslog
vsftpd</pre></div></div>

<p><strong>7.编译安装Dropbear替换OpenSSH(会节省很多内存):</strong></p>
<p>首先修改OpenSSH的端口：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">vim</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>ssh<span style="color: #000000; font-weight: bold;">/</span>sshd_config</pre></div></div>

<p>然后找到Port 22这一行，并修改为Port 2200</p>
<p>再重启OpenSSH：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;">service sshd restart</pre></div></div>

<p>编译安装Dropbear:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #7a0874; font-weight: bold;">cd</span> <span style="color: #000000; font-weight: bold;">/</span>data<span style="color: #000000; font-weight: bold;">/</span>software
<span style="color: #c20cb9; font-weight: bold;">wget</span> http:<span style="color: #000000; font-weight: bold;">//</span>matt.ucc.asn.au<span style="color: #000000; font-weight: bold;">/</span>dropbear<span style="color: #000000; font-weight: bold;">/</span>dropbear-0.53.1.tar.gz
<span style="color: #c20cb9; font-weight: bold;">tar</span> <span style="color: #660033;">-zxvf</span> dropbear-0.53.1.tar.gz
<span style="color: #7a0874; font-weight: bold;">cd</span> dropbear-0.53.1
.<span style="color: #000000; font-weight: bold;">/</span>configure
<span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #000000; font-weight: bold;">&amp;&amp;</span> <span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #c20cb9; font-weight: bold;">install</span></pre></div></div>

<p>生成公钥：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">mkdir</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>dropbear
<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>dropbearkey <span style="color: #660033;">-t</span> dss <span style="color: #660033;">-f</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>dropbear<span style="color: #000000; font-weight: bold;">/</span>dropbear_dss_host_key
<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>dropbearkey <span style="color: #660033;">-t</span> rsa <span style="color: #660033;">-s</span> <span style="color: #000000;">4096</span> <span style="color: #660033;">-f</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>dropbear<span style="color: #000000; font-weight: bold;">/</span>dropbear_rsa_host_key</pre></div></div>

<p>启动Dropbear：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>sbin<span style="color: #000000; font-weight: bold;">/</span>dropbear start</pre></div></div>

<p>配置开机自动启动：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">vim</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>rc.local
<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>local<span style="color: #000000; font-weight: bold;">/</span>sbin<span style="color: #000000; font-weight: bold;">/</span>dropbear start</pre></div></div>

<p>Dropbear正确安装完成后，如果能够用ssh登录，那么就可以删除OpenSSH了:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;">yum remove openssh</pre></div></div>

<p><strong>8.编译安装FTP服务器vsFTP</strong></p>
<p>如果编译安装的话会报错，要自己手动复制文件，所以我就从软件库自动安装了：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;">yum <span style="color: #c20cb9; font-weight: bold;">install</span> vsftpd</pre></div></div>

<p>创建FTP用户：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>sbin<span style="color: #000000; font-weight: bold;">/</span>groupadd <span style="color: #c20cb9; font-weight: bold;">ftp</span>
<span style="color: #000000; font-weight: bold;">/</span>usr<span style="color: #000000; font-weight: bold;">/</span>sbin<span style="color: #000000; font-weight: bold;">/</span>useradd <span style="color: #660033;">-g</span> <span style="color: #c20cb9; font-weight: bold;">ftp</span> <span style="color: #c20cb9; font-weight: bold;">ftp</span></pre></div></div>

<p>建立FTP默认目录:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">mkdir</span> <span style="color: #000000; font-weight: bold;">/</span>var<span style="color: #000000; font-weight: bold;">/</span><span style="color: #c20cb9; font-weight: bold;">ftp</span></pre></div></div>

<p>设定FTP的home目录为/var/ftp：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;">useradd <span style="color: #660033;">-d</span> <span style="color: #000000; font-weight: bold;">/</span>var<span style="color: #000000; font-weight: bold;">/</span><span style="color: #c20cb9; font-weight: bold;">ftp</span> <span style="color: #660033;">-s</span> <span style="color: #000000; font-weight: bold;">/</span>sbin<span style="color: #000000; font-weight: bold;">/</span>nologin <span style="color: #c20cb9; font-weight: bold;">ftp</span></pre></div></div>

<p>设定home目录所有者和权限:</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">chown</span> <span style="color: #c20cb9; font-weight: bold;">ftp</span>:<span style="color: #c20cb9; font-weight: bold;">ftp</span> <span style="color: #000000; font-weight: bold;">/</span>var<span style="color: #000000; font-weight: bold;">/</span><span style="color: #c20cb9; font-weight: bold;">ftp</span>
<span style="color: #c20cb9; font-weight: bold;">chmod</span> <span style="color: #000000;">755</span> <span style="color: #000000; font-weight: bold;">/</span>var<span style="color: #000000; font-weight: bold;">/</span><span style="color: #c20cb9; font-weight: bold;">ftp</span></pre></div></div>

<p>打开vsFTP配置文件：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">vim</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>vsftpd<span style="color: #000000; font-weight: bold;">/</span>vsftpd.conf</pre></div></div>

<p>修改为：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;">anonymous_enable = no
listen = <span style="color: #c20cb9; font-weight: bold;">yes</span>
<span style="color: #000000; font-weight: bold;">//</span>并在文件末尾添加：
pasv_enable = <span style="color: #c20cb9; font-weight: bold;">yes</span>
use_localtime = <span style="color: #c20cb9; font-weight: bold;">yes</span>
connect_timeout = <span style="color: #000000;">60</span>
accept_timeout = <span style="color: #000000;">60</span>
max_clients = <span style="color: #000000;">10</span>
max_per_ip = <span style="color: #000000;">10</span></pre></div></div>

<p>到这里为止，LNMP+Drpbear+vsFTP部分的安装就结束了，下面就是安装PPTP了。</p>
<p><strong>三.安装PPTP</strong></p>
<p>1.首先用ssh登录VPS，检查VPS是否有必要的支持，否则将导致无法安装(如果是buyvm的VPS可以跳过这步)。</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;">modprobe ppp-compress-<span style="color: #000000;">18</span> <span style="color: #000000; font-weight: bold;">&amp;&amp;</span> <span style="color: #7a0874; font-weight: bold;">echo</span> ok</pre></div></div>

<p>用模块方式支持MPPE加密模式浏览，如果内核支持则检测不到。如果显示“ok”表明通过，不过还需要做另一个检查：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">cat</span> <span style="color: #000000; font-weight: bold;">/</span>dev<span style="color: #000000; font-weight: bold;">/</span>net<span style="color: #000000; font-weight: bold;">/</span>tun</pre></div></div>

<p>如果显示结果为下面的文本就表明通过：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">cat</span>: <span style="color: #000000; font-weight: bold;">/</span>dev<span style="color: #000000; font-weight: bold;">/</span>net<span style="color: #000000; font-weight: bold;">/</span>tun: File descriptor <span style="color: #000000; font-weight: bold;">in</span> bad state</pre></div></div>

<p>上述两条检测只需一条通过，即可安装pptp。如果还有其他问题，就提Ticket给服务商替你解决。</p>
<p>2.安装ppp：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;">yum <span style="color: #c20cb9; font-weight: bold;">install</span> <span style="color: #660033;">-y</span> ppp</pre></div></div>

<p>3.安装pptp</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;">rpm <span style="color: #660033;">-ivh</span> http:<span style="color: #000000; font-weight: bold;">//</span>acelnmp.googlecode.com<span style="color: #000000; font-weight: bold;">/</span>files<span style="color: #000000; font-weight: bold;">/</span>pptpd-1.3.4-<span style="color: #000000;">1</span>.rhel5.1.i386.rpm</pre></div></div>

<p>4.配置pptp</p>
<p>首先编辑pptp的.conf配置文件：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">vim</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>pptpd.conf</pre></div></div>

<p>把下面字段前面的#去掉即可：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;">localip 192.168.0.1
remoteip 192.168.0.234-<span style="color: #000000;">238</span>,192.168.0.245</pre></div></div>

<p>接下来再编辑/etc/ppp/options.pptpd：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">vim</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>ppp<span style="color: #000000; font-weight: bold;">/</span>options.pptpd</pre></div></div>

<p>去掉ms-dns前面的#，并修改成如下字段：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;">ms-dns 8.8.8.8
ms-dns 8.8.4.4</pre></div></div>

<p>5.设置PPTP VPN的账号和密码：</p>
<p>编辑/etc/ppp/chap-secrets这个文件：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">vim</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>ppp<span style="color: #000000; font-weight: bold;">/</span>chap-secrets</pre></div></div>

<p>直接输入如下字段,username和password就是你要登录VPN的用户名和密码：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;">username pptpd password <span style="color: #000000; font-weight: bold;">*</span></pre></div></div>

<p>6.修改内核设置，使其支持转发:</p>
<p>编辑/etc/sysctl.conf文件：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">vim</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>sysctl.conf</pre></div></div>

<p>做下面的修改：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;">net.ipv4.ip_forward=<span style="color: #000000;">1</span>
<span style="color: #666666; font-style: italic;"># net.ipv4.tcp_syncookies = 1  //注释这行</span></pre></div></div>

<p>保存退出，并执行下面的命令来使它生效：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;">sysctl <span style="color: #660033;">-p</span></pre></div></div>

<p>7.添加iptables转发规则：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;">iptables <span style="color: #660033;">-t</span> nat <span style="color: #660033;">-A</span> POSTROUTING <span style="color: #660033;">-s</span> 192.168.0.0<span style="color: #000000; font-weight: bold;">/</span><span style="color: #000000;">24</span> <span style="color: #660033;">-j</span> SNAT <span style="color: #660033;">--to-source</span> xxx.xxx.xxx.xxx  <span style="color: #000000; font-weight: bold;">//</span>xxx.xxx.xxx.xxx为你的VPS的公网IP地址</pre></div></div>

<p>保存iptables转发规则：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>init.d<span style="color: #000000; font-weight: bold;">/</span>iptables save</pre></div></div>

<p>重启iptables：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>init.d<span style="color: #000000; font-weight: bold;">/</span>iptables restart</pre></div></div>

<p>8.重启pptp服务：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>init.d<span style="color: #000000; font-weight: bold;">/</span>pptpd restart</pre></div></div>

<p>9.设置开机自动启动：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #c20cb9; font-weight: bold;">vim</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>rc.local</pre></div></div>

<p>加入：</p>

<div class="wp_syntax"><div class="code"><pre class="bash" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;">pptpd</pre></div></div>

<p><strong>四.总结</strong></p>
<p>回顾这段搭建的过程可谓历经挫折和痛苦，其中碰到了很多问题，为此我还到StackOverflow上发贴求助，但是我还是坚持了下来，直到搭建成功，所以说坚持和永不放弃的精神是非常重要的。搭建完成后，通过top命令发现虽然只有19个进程，但是内存占用还是蛮高的，特别是系统启动后需要占用的内存。好了，希望能给看到这篇博文的朋友带来帮助，缩短他们搭建的时间。</p>
<p>参考文章：</p>
<p>1.<a href="http://blog.s135.com/nginx_php_v6/" rel="nofollow"  title="http://blog.s135.com/nginx_php_v6/">http://blog.s135.com/nginx_php_v6/</a><br />
2.<a href="http://www.fallday.org/archives/551" rel="nofollow"  title="http://www.fallday.org/archives/551">http://www.fallday.org/archives/551</a></p>
							</div>
			
			<p class="entry-meta"><span class="entry-categories">Posted in: <a href="http://liuxuan.info/category/linux/" title="View all posts in Linux" rel="category tag">Linux</a>.</span><br />
							<span class="entry-tags">Tagged: <a href="http://liuxuan.info/tag/dropbear/" rel="nofollow tag">Dropbear</a> &middot; <a href="http://liuxuan.info/tag/linux/" rel="nofollow tag">Linux</a> &middot; <a href="http://liuxuan.info/tag/mysql/" rel="nofollow tag">MySQL</a> &middot; <a href="http://liuxuan.info/tag/nginx/" rel="nofollow tag">Nginx</a> &middot; <a href="http://liuxuan.info/tag/php/" rel="nofollow tag">PHP</a> &middot; <a href="http://liuxuan.info/tag/pptp/" rel="nofollow tag">PPTP</a> &middot; <a href="http://liuxuan.info/tag/vps/" rel="nofollow tag">VPS</a> &middot; <a href="http://liuxuan.info/tag/vsftp/" rel="nofollow tag">vsFTP</a><br /></span>
			</p>
		</div><!--.entry-->
		
				
		<div id="post-426" class="post-426 post type-post status-publish format-standard hentry category-java tag-java tag-puzzle tag-trap entry">
			
			<h2 class="entry-title"><a href="http://liuxuan.info/2011/08/java-puzzles-and-traps-three/" rel="bookmark" title="Permalink to Java常见疑惑和陷阱(三)">Java常见疑惑和陷阱(三)</a></h2>
			
			<div class="entry-byline">
				<a class="entry-date" rel="bookmark" title="2011-08-11T14:07:25+0000" href="http://liuxuan.info/2011/08/java-puzzles-and-traps-three/"><abbr class="updated" title="2011-08-11T14:07:25+0000">Aug 11th, 2011</abbr></a>
				<address class="author vcard">by <a class="url fn" href="">Foredoomed</a>. </address>
				<a href="http://liuxuan.info/2011/08/java-puzzles-and-traps-three/#respond" class="comments-link"  rel="nofollow" title="Comment on Java常见疑惑和陷阱(三)">No comments yet</a>							</div>
			
			<div class="entry-content">
				<a href="http://liuxuan.info/2011/08/java-puzzles-and-traps-three/" title="Java常见疑惑和陷阱(三)"></a>				<p><strong>29.令人混淆的构造器案例</strong><br />
下面的程序会打印出什么呢?</p>

<div class="wp_syntax"><div class="code"><pre class="java" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> Confusing <span style="color: #009900;">&#123;</span>
  <span style="color: #7F0055; font-weight: bold;">private</span> Confusing<span style="color: #009900;">&#40;</span><span style="color: #2B91AF;">Object</span> o<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #2B91AF;">System</span>.<span style="color: #006633;">out</span>.<span style="color: #006633;">println</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;Object&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #7F0055; font-weight: bold;">private</span> Confusing<span style="color: #009900;">&#40;</span><span style="color: #00008B; font-weight: bold;">double</span><span style="color: #009900;">&#91;</span><span style="color: #009900;">&#93;</span> dArray<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #2B91AF;">System</span>.<span style="color: #006633;">out</span>.<span style="color: #006633;">println</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;double array&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #00008B; font-weight: bold;">void</span> main<span style="color: #009900;">&#40;</span><span style="color: #2B91AF;">String</span><span style="color: #009900;">&#91;</span><span style="color: #009900;">&#93;</span> args<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #7F0055; font-weight: bold;">new</span> Confusing<span style="color: #009900;">&#40;</span><span style="color: #7F0055; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span></pre></div></div>

<p>如果运行该程序，你会发现打印的是“double array“。这是因为：Java的重载解析过程是以两阶段运行的。第一阶段选取所有可获得并且可应用的方法或构造器。第二阶段在第一阶段选取的方法或构造器中选取最精确的一个。<strong>如果一个方法或构造器可以接受传递给另一个方法或构造器的任何参数,那么我们就说第一个方法比第二个方法缺乏精确性。</strong></p>
<p>如果想要调用Confusing(Object)构造方法,你需要这样改写代码:new Confusing((Object)null)。这可以确保只有Confusing(Object)是可应用的。更一般地讲,要想强制要求编译器选择一个精确的重载版本,需要将实际的参数转型为形式参数所声明的类型。</p>
<p><strong>30.我所得到的都是静态的</strong><br />
下面的程序将打印出什么呢?</p>

<div class="wp_syntax"><div class="code"><pre class="java" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #7F0055; font-weight: bold;">class</span> Dog <span style="color: #009900;">&#123;</span>
  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #00008B; font-weight: bold;">void</span> bark<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #2B91AF;">System</span>.<span style="color: #006633;">out</span>.<span style="color: #006633;">print</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;woof&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span>
&nbsp;
<span style="color: #7F0055; font-weight: bold;">class</span> Dog1 <span style="color: #7F0055; font-weight: bold;">extends</span> Dog <span style="color: #009900;">&#123;</span>
  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #00008B; font-weight: bold;">void</span> bark<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span>
&nbsp;
<span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> Bark <span style="color: #009900;">&#123;</span>
  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #00008B; font-weight: bold;">void</span> main<span style="color: #009900;">&#40;</span><span style="color: #2B91AF;">String</span> args<span style="color: #009900;">&#91;</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    Dog woofer <span style="color: #339933;">=</span> <span style="color: #7F0055; font-weight: bold;">new</span> Dog<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    Dog nipper <span style="color: #339933;">=</span> <span style="color: #7F0055; font-weight: bold;">new</span> Basenji<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    woofer.<span style="color: #006633;">bark</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    nipper.<span style="color: #006633;">bark</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span></pre></div></div>

<p>好像该程序应该只打印一个woof，毕竟Dog1继承自Dog,并且它的bark方法定义了什么也不做。main方法调用了bark方法,第一次是在Dog类型的woofer上调用,第二次是在Dog1类型的nipper上调用。但是如果你运行该程序,就会发现它打印的是 “woof woof“。</p>
<p>问题在于bark是一个静态方法,而对静态方法的调用不存在任何动态的分派机制。当一个程序调用了一个静态方法时,要被调用的方法都是在编译时刻被选定的,而这种选定是基于修饰符的编译期类型而做出的,修饰符的编译期类型就是我们给出的方法调用表达式中圆点左边部分的名字。在本例中,两个方法调用的修饰符分别是变量woofer 和nipper,它们都被声明为Dog类型。因为它们具有相同的编译期类型,所以编译器使得它们调用的是相同的方法:Dog.bark。</p>
<p><strong>31.比年龄小</strong><br />
如果运行下面的程序会打印出什么呢?</p>

<div class="wp_syntax"><div class="code"><pre class="java" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> Age <span style="color: #009900;">&#123;</span>
  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #7F0055; font-weight: bold;">final</span> Age INSTANCE <span style="color: #339933;">=</span> <span style="color: #7F0055; font-weight: bold;">new</span> Age<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
  <span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #7F0055; font-weight: bold;">final</span> <span style="color: #00008B; font-weight: bold;">int</span> age<span style="color: #339933;">;</span>
  <span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #7F0055; font-weight: bold;">final</span> <span style="color: #00008B; font-weight: bold;">int</span> CURRENT_YEAR<span style="color: #339933;">=</span><span style="color: #2B91AF;">Calendar</span>.<span style="color: #006633;">getInstance</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">get</span><span style="color: #009900;">&#40;</span><span style="color: #2B91AF;">Calendar</span>.<span style="color: #006633;">YEAR</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #7F0055; font-weight: bold;">private</span> Age<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    age <span style="color: #339933;">=</span> CURRENT_YEAR <span style="color: #339933;">-</span> <span style="color: #cc66cc;">1985</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #00008B; font-weight: bold;">int</span> getAge<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #7F0055; font-weight: bold;">return</span> age<span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #00008B; font-weight: bold;">void</span> main<span style="color: #009900;">&#40;</span><span style="color: #2B91AF;">String</span><span style="color: #009900;">&#91;</span><span style="color: #009900;">&#93;</span> args<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #2B91AF;">System</span>.<span style="color: #006633;">out</span>.<span style="color: #006633;">println</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;My age is &quot;</span> <span style="color: #339933;">+</span> INSTANCE.<span style="color: #006633;">getAge</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">+</span> <span style="color: #0000ff;">&quot; years old.&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span></pre></div></div>

<p>这个程序是在计算当前的年份减去1985的值。如果它是正确的,那么在2011年,该程序将打印出&#8221;My age is 26 years old&#8221;。但是如果你尝试着去运行该程序,该程序将打印出&#8221;My age is -1985 years old&#8221;。</p>
<p>该程序所遇到的问题是由类初始化顺序中的循环而引起的。让我们来看看其细节。首先,其静态域被设置为缺省值,其中INSTANCE被设置为null,CURRENT_YEAR被设置为0。接下来,静态域初始器按照其出现的顺序执行。第一个静态域是INSTANCE,它的值是通过调用 Age()构造器而计算出来的。这个构造器会用一个涉及静态域CURRENT_YEAR的表达式来初始化age。通常,读取一个静态域是会引起一个类被初始化的事件之一,但是我们已经在初始化Age类了，所以递归的初始化尝试会直接被忽略掉。因此,CURRENT_YEAR 的值仍旧是其缺省值0。这就是为什么我的年龄变成了-1985的原因。最后,从构造器返回以完成Age类的初始化,假设我们是在2011年运行该程序,那么我们就将静态域 CURRENT_YEAR初始化成了2011。但是已经太晚了，age的值已经是-1985了。这正是后续所有对Age.INSTANCE.getAge()的调用将返回的值。</p>
<p>该程序表明,在final类型的静态域被初始化之前,存在着读取它的值的可能,而此时该静态域包含的还只是其所属类型的缺省值。这是与直觉相违背的,因为我们通常会将final类型的域看作是常量。final类型的域只有在其初始化表达式是常量表达式时才是常量。</p>
<p>要想修正这个程序,需要重新对静态域的初始化进行排序,使得每一个初始化都出现在任何依赖于它的其他的初始化之前。</p>
<p><strong>32.不是你的类型</strong><br />
下面的三个程序每一个都会打印出什么呢?</p>

<div class="wp_syntax"><div class="code"><pre class="java" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> Type1 <span style="color: #009900;">&#123;</span>
  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #00008B; font-weight: bold;">void</span> main<span style="color: #009900;">&#40;</span><span style="color: #2B91AF;">String</span><span style="color: #009900;">&#91;</span><span style="color: #009900;">&#93;</span> args<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #2B91AF;">String</span> s <span style="color: #339933;">=</span> <span style="color: #7F0055; font-weight: bold;">null</span><span style="color: #339933;">;</span>
    <span style="color: #2B91AF;">System</span>.<span style="color: #006633;">out</span>.<span style="color: #006633;">println</span><span style="color: #009900;">&#40;</span>s <span style="color: #7F0055; font-weight: bold;">instanceof</span> <span style="color: #2B91AF;">String</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span>
&nbsp;
<span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> Type2 <span style="color: #009900;">&#123;</span>
  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #00008B; font-weight: bold;">void</span> main<span style="color: #009900;">&#40;</span><span style="color: #2B91AF;">String</span><span style="color: #009900;">&#91;</span><span style="color: #009900;">&#93;</span> args<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #2B91AF;">System</span>.<span style="color: #006633;">out</span>.<span style="color: #006633;">println</span><span style="color: #009900;">&#40;</span><span style="color: #7F0055; font-weight: bold;">new</span> Type2<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">instanceof</span> <span style="color: #2B91AF;">String</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span>
&nbsp;
<span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> Type3 <span style="color: #009900;">&#123;</span>
  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #00008B; font-weight: bold;">void</span> main<span style="color: #009900;">&#40;</span><span style="color: #2B91AF;">String</span> args<span style="color: #009900;">&#91;</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    Type3 t3 <span style="color: #339933;">=</span> <span style="color: #009900;">&#40;</span>Type3<span style="color: #009900;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">new</span> <span style="color: #2B91AF;">Object</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span></pre></div></div>

<p>第一个程序,Type1展示了instanceof操作符应用于一个空对象引用时的行为。尽管null对于每一个引用类型来说都是其子类型,但是instanceof操作符被定义为在其左操作数为null时返回false。因此,Type1将打印false。这被证明是实践中非常有用的行为。如果instanceof告诉你一个对象引用是某个特定类型的实例,那么你就可以将其转型为该类型,并调用该类型的方法,而不用担心会抛出ClassCastException或NullPointerException。</p>
<p>第二个程序,Type2展示了instanceof操作符在测试一个类的实例,以查看它是否是某个不相关的类的实例时所表现出来的行为。你可能会期望该程序打印出false。毕竟,Type2的实例不是String的实例,因此该测试应该失败。遗憾是,instanceof 测试在编译时刻就失败了,我们只能得到下面这样的出错消息:</p>

<div class="wp_syntax"><div class="code"><pre class="java" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;">Type2.<span style="color: #006633;">java</span><span style="color: #339933;">:</span><span style="color: #cc66cc;">3</span><span style="color: #339933;">:</span> inconvertible types
found<span style="color: #339933;">:</span> Type2, required<span style="color: #339933;">:</span> java.<span style="color: #006633;">lang</span>.<span style="color: #2B91AF;">String</span>
       <span style="color: #2B91AF;">System</span>.<span style="color: #006633;">out</span>.<span style="color: #006633;">println</span><span style="color: #009900;">&#40;</span><span style="color: #7F0055; font-weight: bold;">new</span> Type2<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">instanceof</span> <span style="color: #2B91AF;">String</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre></div></div>

<p>该程序编译失败是因为instanceof操作符有这样的要求:<strong>如果两个操作数的类型都是类,其中一个必须是另一个的子类型</strong>。Type2和String彼此都不是对方的子类型,所以instanceof测试将导致编译期错误。</p>
<p>第三个程序,Type3展示了当要被转型的表达式的静态类型是转型类型的超类时转型操作符的行为:如果在一个转型操作中的两种类型都是类,那么其中一个必须是另一个的子类型。尽管对我们来说,这个转型很显然会失败,但是类型系统还没有强大到能够洞悉表达式new Object()的运行期类型不可能是Type3的一个子类型。因此,该程序将在运行期抛出ClassCastException。</p>
<p><strong>33.特创论</strong><br />
下面的程序会打印出什么呢?</p>

<div class="wp_syntax"><div class="code"><pre class="java" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> Creator <span style="color: #009900;">&#123;</span>
  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #00008B; font-weight: bold;">void</span> main<span style="color: #009900;">&#40;</span><span style="color: #2B91AF;">String</span><span style="color: #009900;">&#91;</span><span style="color: #009900;">&#93;</span> args<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #7F0055; font-weight: bold;">for</span> <span style="color: #009900;">&#40;</span><span style="color: #00008B; font-weight: bold;">int</span> i <span style="color: #339933;">=</span> <span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span> i <span style="color: #339933;">&lt;</span> <span style="color: #cc66cc;">100</span><span style="color: #339933;">;</span> i<span style="color: #339933;">++</span><span style="color: #009900;">&#41;</span>
      Creature creature <span style="color: #339933;">=</span> <span style="color: #7F0055; font-weight: bold;">new</span> Creature<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #2B91AF;">System</span>.<span style="color: #006633;">out</span>.<span style="color: #006633;">println</span><span style="color: #009900;">&#40;</span>Creature.<span style="color: #006633;">numCreated</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span>
&nbsp;
<span style="color: #7F0055; font-weight: bold;">class</span> Creature <span style="color: #009900;">&#123;</span>
  <span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #00008B; font-weight: bold;">long</span> numCreated <span style="color: #339933;">=</span> <span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span>
    <span style="color: #7F0055; font-weight: bold;">public</span> Creature<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
      numCreated<span style="color: #339933;">++;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #00008B; font-weight: bold;">long</span> numCreated<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #7F0055; font-weight: bold;">return</span> numCreated<span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span></pre></div></div>

<p>该程序看起来似乎应该打印100,但是它没有打印任何东西,因为它根本就不能编译。如果你尝试着去编译它,你就会发现编译器的诊断信息基本没什么用处。下面就是javac打印的东西:</p>

<div class="wp_syntax"><div class="code"><pre class="java" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;">Creator.<span style="color: #006633;">java</span><span style="color: #339933;">:</span><span style="color: #cc66cc;">4</span><span style="color: #339933;">:</span> not a statement
Creature creature <span style="color: #339933;">=</span> <span style="color: #7F0055; font-weight: bold;">new</span> Creature<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #339933;">^</span>
Creator.<span style="color: #006633;">java</span><span style="color: #339933;">:</span><span style="color: #cc66cc;">4</span><span style="color: #339933;">:</span> <span style="color: #0000ff;">';'</span> expected
Creature creature <span style="color: #339933;">=</span> <span style="color: #7F0055; font-weight: bold;">new</span> Creature<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #339933;">^</span></pre></div></div>

<p>一个本地变量声明看起来像是一条语句,但是从技术上说,它不是;它应该是一个本地变量声明语句(local variable declaration statement)。Java语言规范不允许一个本地变量声明语句作为一条语句在for、while或do循环中重复执行。一个本地变量声明作为一条语句只能直接出现在一个语句块中。(一个语句块是由一对花括号以及包含在这对花括展中的语句和声明构成的)。</p>
<p>有两种方式可以修正这个问题。最显而易见的方式是将这个声明至于一个语句块<br />
中:</p>

<div class="wp_syntax"><div class="code"><pre class="java" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #7F0055; font-weight: bold;">for</span> <span style="color: #009900;">&#40;</span><span style="color: #00008B; font-weight: bold;">int</span> i <span style="color: #339933;">=</span> <span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span> i <span style="color: #339933;">&lt;</span> <span style="color: #cc66cc;">100</span><span style="color: #339933;">;</span> i<span style="color: #339933;">++</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
  Creature creature <span style="color: #339933;">=</span> <span style="color: #7F0055; font-weight: bold;">new</span> Creature<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span></pre></div></div>

<p>然而,请注意,该程序没有使用本地变量creature。因此,将该声明用一个无任何修饰的构造器调用来替代将更具实际意义,这样可以强调对新创建对象的引用正在被丢弃:</p>

<div class="wp_syntax"><div class="code"><pre class="java" style="font-family:Monaco,Consolas,Menlo,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace,serif;"><span style="color: #7F0055; font-weight: bold;">for</span> <span style="color: #009900;">&#40;</span><span style="color: #00008B; font-weight: bold;">int</span> i <span style="color: #339933;">=</span> <span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span> i <span style="color: #339933;">&lt;</span> <span style="color: #cc66cc;">100</span><span style="color: #339933;">;</span> i<span style="color: #339933;">++</span><span style="color: #009900;">&#41;</span>
  <span style="color: #7F0055; font-weight: bold;">new</span> Creature<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre></div></div>

							</div>
			
			<p class="entry-meta"><span class="entry-categories">Posted in: <a href="http://liuxuan.info/category/java/" title="View all posts in Java" rel="category tag">Java</a>.</span><br />
							<span class="entry-tags">Tagged: <a href="http://liuxuan.info/tag/java/" rel="nofollow tag">Java</a> &middot; <a href="http://liuxuan.info/tag/puzzle/" rel="nofollow tag">Puzzle</a> &middot; <a href="http://liuxuan.info/tag/trap/" rel="nofollow tag">Trap</a><br /></span>
			</p>
		</div><!--.entry-->
		
				
		
	<div class="navigation">
	<div class='wp-pagenavi'>
<span class='pages'>Page 1 of 7</span><span class='current'>1</span><a href='http://liuxuan.info/page/2/' class='page larger'>2</a><a href='http://liuxuan.info/page/3/' class='page larger'>3</a><a href='http://liuxuan.info/page/4/' class='page larger'>4</a><a href='http://liuxuan.info/page/5/' class='page larger'>5</a><a href="http://liuxuan.info/page/2/" class="nextpostslink">»</a><span class='extend'>...</span><a href='http://liuxuan.info/page/7/' class='last'>Last »</a>
</div>	</div>

		
			

	</div><!--#primary-->

<div id="secondary">

<div id="pp-subscribe" class="clearfix">
	<ul class="clearfix">
	<li>
        <a href="http://feeds.feedburner.com/zhixingheyi" title="Subscribe to my feed" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon32x32.png" alt="Subscribe in a reader" style="border:0;vertical-align:middle"/></a><a href="http://feeds.feedburner.com/zhixingheyi" title="Subscribe to my feed" rel="alternate" type="application/rss+xml">Subscribe in a reader</a>
	</li>
<li>
<a target="_blank" href="https://twitter.com/nauxuil" title="Follow me on Twitter">
<img src="/twitter_32x32.png" alt="Follow me on Twitter" style="border:0;vertical-align:middle"/></a><a target="_blank" href="https://twitter.com/nauxuil" title="Follow me on Twitter">Follow me on Twitter</a>
</li>
		</ul>
</div>
<div id="pp-sidebars" class="clearfix">

<div id="sidebar-wide" class="sidebar">
	
	<ul class="xoxo sidebar-items">
	<li id="text-6" class="widget widget_text"><h2 class="widgettitle">Weibo</h2>			<div class="textwidget"><iframe width="250" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?width=250&height=550&fansRow=1&ptype=1&speed=0&skin=1&isTitle=1&noborder=0&isWeibo=1&isFans=1&uid=1928638455&verifier=b92d5ce3"></iframe></div>
		</li><li id="search-4" class="widget widget_search"><h2 class="widgettitle search-title">Search</h2>
<form method="get" id="pp-searchform" action="http://liuxuan.info">
<div>
	<input type="text" name="s" id="s-input" maxlength="150" accesskey="4" title="Search Zhixingheyi" onblur="this.value=(this.value=='') ? 'Type in and hit enter to search' : this.value;" onfocus="this.value=(this.value=='Type in and hit enter to search') ? '' : this.value;" value="Type in and hit enter to search" />
	<input type="hidden" id="s-submit" value="Search" />
</div>
</form></li>		<li id="recent-posts-4" class="widget widget_recent_entries">		<h2 class="widgettitle">Recent Posts</h2>		<ul>
				<li><a href="http://liuxuan.info/2011/08/ibatis-and-mybatis-source-code-analysis-two-logging/" title="iBatis/myBatis源码分析之二:日志">iBatis/myBatis源码分析之二:日志</a></li>
				<li><a href="http://liuxuan.info/2011/08/ibatis-and-mybatis-source-code-analysis-one-overview/" title="iBatis/myBatis源码分析之一:概览">iBatis/myBatis源码分析之一:概览</a></li>
				<li><a href="http://liuxuan.info/2011/08/install-vnstat-on-vps/" title="在VPS上安装网络流量监控工具vnStat">在VPS上安装网络流量监控工具vnStat</a></li>
				<li><a href="http://liuxuan.info/2011/08/setup-lnmp-and-pptp-on-vps/" title="在VPS上搭建LNMP(Linux/Nginx/MySQL/PHP)和PPTP">在VPS上搭建LNMP(Linux/Nginx/MySQL/PHP)和PPTP</a></li>
				<li><a href="http://liuxuan.info/2011/08/java-puzzles-and-traps-three/" title="Java常见疑惑和陷阱(三)">Java常见疑惑和陷阱(三)</a></li>
				<li><a href="http://liuxuan.info/2011/08/java-puzzles-and-traps-two/" title="Java常见疑惑和陷阱(二)">Java常见疑惑和陷阱(二)</a></li>
				<li><a href="http://liuxuan.info/2011/08/single-precision-binary-floating-point-format/" title="单精度浮点类型的二进制表示格式">单精度浮点类型的二进制表示格式</a></li>
				<li><a href="http://liuxuan.info/2011/07/quoras-technology-examined/" title="Quora使用的技术">Quora使用的技术</a></li>
				<li><a href="http://liuxuan.info/2011/07/stack-overflow-architecture/" title="Stack Overflow的系统架构">Stack Overflow的系统架构</a></li>
				<li><a href="http://liuxuan.info/2011/06/flag-argument-for-method/" title="方法的标记参数">方法的标记参数</a></li>
				</ul>
		</li><li id="categories-3" class="widget widget_categories"><h2 class="widgettitle">Categories</h2>		<ul>
	<li class="cat-item cat-item-31"><a href="http://liuxuan.info/category/architecture/" title="View all posts filed under Architecture">Architecture</a>
</li>
	<li class="cat-item cat-item-38"><a href="http://liuxuan.info/category/cool/" title="View all posts filed under Cool">Cool</a>
</li>
	<li class="cat-item cat-item-49"><a href="http://liuxuan.info/category/http/" title="View all posts filed under HTTP">HTTP</a>
</li>
	<li class="cat-item cat-item-14"><a href="http://liuxuan.info/category/ide/" title="View all posts filed under IDE">IDE</a>
</li>
	<li class="cat-item cat-item-3"><a href="http://liuxuan.info/category/java/" title="View all posts filed under Java">Java</a>
</li>
	<li class="cat-item cat-item-5"><a href="http://liuxuan.info/category/life/" title="View all posts filed under Life">Life</a>
</li>
	<li class="cat-item cat-item-69"><a href="http://liuxuan.info/category/linux/" title="View all posts filed under Linux">Linux</a>
</li>
	<li class="cat-item cat-item-42"><a href="http://liuxuan.info/category/nosql/" title="View all posts filed under NoSQL">NoSQL</a>
</li>
	<li class="cat-item cat-item-4"><a href="http://liuxuan.info/category/objective-c/" title="View all posts filed under Objective-C">Objective-C</a>
</li>
	<li class="cat-item cat-item-40"><a href="http://liuxuan.info/category/opensource/" title="View all posts filed under Opensource">Opensource</a>
</li>
	<li class="cat-item cat-item-28"><a href="http://liuxuan.info/category/programming/" title="View all posts filed under Programming">Programming</a>
</li>
	<li class="cat-item cat-item-45"><a href="http://liuxuan.info/category/reading/" title="View all posts filed under Reading">Reading</a>
</li>
		</ul>
</li><li id="archives-3" class="widget widget_archive"><h2 class="widgettitle">Archives</h2>		<ul>
			<li><a href='http://liuxuan.info/2011/08/' title='August 2011'>August 2011</a></li>
	<li><a href='http://liuxuan.info/2011/07/' title='July 2011'>July 2011</a></li>
	<li><a href='http://liuxuan.info/2011/06/' title='June 2011'>June 2011</a></li>
	<li><a href='http://liuxuan.info/2011/05/' title='May 2011'>May 2011</a></li>
	<li><a href='http://liuxuan.info/2011/04/' title='April 2011'>April 2011</a></li>
	<li><a href='http://liuxuan.info/2011/03/' title='March 2011'>March 2011</a></li>
		</ul>
</li><li id="tag_cloud-3" class="widget widget_tag_cloud"><h2 class="widgettitle">Tags</h2><div class="tagcloud"><a href='http://liuxuan.info/tag/2011/' class='tag-link-10' title='1 topic' style='font-size: 8pt;'>2011</a>
<a href='http://liuxuan.info/tag/anonymous-class/' class='tag-link-7' title='1 topic' style='font-size: 8pt;'>Anonymous Class</a>
<a href='http://liuxuan.info/tag/anonymous-inner-class/' class='tag-link-6' title='1 topic' style='font-size: 8pt;'>Anonymous Inner Class</a>
<a href='http://liuxuan.info/tag/architecture/' class='tag-link-31' title='2 topics' style='font-size: 11.111111111111pt;'>Architecture</a>
<a href='http://liuxuan.info/tag/closure/' class='tag-link-8' title='1 topic' style='font-size: 8pt;'>Closure</a>
<a href='http://liuxuan.info/tag/cool/' class='tag-link-38' title='1 topic' style='font-size: 8pt;'>Cool</a>
<a href='http://liuxuan.info/tag/definition/' class='tag-link-65' title='1 topic' style='font-size: 8pt;'>Definition</a>
<a href='http://liuxuan.info/tag/design-pattern/' class='tag-link-26' title='1 topic' style='font-size: 8pt;'>Design Pattern</a>
<a href='http://liuxuan.info/tag/facebook/' class='tag-link-32' title='2 topics' style='font-size: 11.111111111111pt;'>Facebook</a>
<a href='http://liuxuan.info/tag/flag-argumnet/' class='tag-link-52' title='1 topic' style='font-size: 8pt;'>Flag Argumnet</a>
<a href='http://liuxuan.info/tag/gc-tuning/' class='tag-link-18' title='1 topic' style='font-size: 8pt;'>GC Tuning</a>
<a href='http://liuxuan.info/tag/health/' class='tag-link-33' title='1 topic' style='font-size: 8pt;'>Health</a>
<a href='http://liuxuan.info/tag/http-2/' class='tag-link-24' title='1 topic' style='font-size: 8pt;'>http</a>
<a href='http://liuxuan.info/tag/ibatis/' class='tag-link-77' title='2 topics' style='font-size: 11.111111111111pt;'>iBatis</a>
<a href='http://liuxuan.info/tag/invokeinterface/' class='tag-link-19' title='1 topic' style='font-size: 8pt;'>invokeinterface</a>
<a href='http://liuxuan.info/tag/invokespecial/' class='tag-link-20' title='1 topic' style='font-size: 8pt;'>invokespecial</a>
<a href='http://liuxuan.info/tag/invokestatic/' class='tag-link-21' title='1 topic' style='font-size: 8pt;'>invokestatic</a>
<a href='http://liuxuan.info/tag/invokevirtual/' class='tag-link-22' title='1 topic' style='font-size: 8pt;'>invokevirtual</a>
<a href='http://liuxuan.info/tag/java/' class='tag-link-3' title='12 topics' style='font-size: 22pt;'>Java</a>
<a href='http://liuxuan.info/tag/jmeter/' class='tag-link-48' title='1 topic' style='font-size: 8pt;'>JMeter</a>
<a href='http://liuxuan.info/tag/jvm/' class='tag-link-17' title='1 topic' style='font-size: 8pt;'>JVM</a>
<a href='http://liuxuan.info/tag/lazy-initialization/' class='tag-link-27' title='1 topic' style='font-size: 8pt;'>Lazy Initialization</a>
<a href='http://liuxuan.info/tag/license/' class='tag-link-41' title='1 topic' style='font-size: 8pt;'>License</a>
<a href='http://liuxuan.info/tag/life/' class='tag-link-5' title='1 topic' style='font-size: 8pt;'>Life</a>
<a href='http://liuxuan.info/tag/mongodb/' class='tag-link-43' title='1 topic' style='font-size: 8pt;'>MongoDB</a>
<a href='http://liuxuan.info/tag/mybatis/' class='tag-link-78' title='2 topics' style='font-size: 11.111111111111pt;'>myBatis</a>
<a href='http://liuxuan.info/tag/myeclipse/' class='tag-link-15' title='1 topic' style='font-size: 8pt;'>MyEclipse</a>
<a href='http://liuxuan.info/tag/mysql/' class='tag-link-58' title='2 topics' style='font-size: 11.111111111111pt;'>MySQL</a>
<a href='http://liuxuan.info/tag/nosql/' class='tag-link-42' title='1 topic' style='font-size: 8pt;'>NoSQL</a>
<a href='http://liuxuan.info/tag/objective-c/' class='tag-link-4' title='1 topic' style='font-size: 8pt;'>Objective-C</a>
<a href='http://liuxuan.info/tag/opensource/' class='tag-link-40' title='1 topic' style='font-size: 8pt;'>Opensource</a>
<a href='http://liuxuan.info/tag/plans/' class='tag-link-9' title='1 topic' style='font-size: 8pt;'>Plans</a>
<a href='http://liuxuan.info/tag/programming/' class='tag-link-28' title='2 topics' style='font-size: 11.111111111111pt;'>Programming</a>
<a href='http://liuxuan.info/tag/puzzle/' class='tag-link-66' title='3 topics' style='font-size: 13.185185185185pt;'>Puzzle</a>
<a href='http://liuxuan.info/tag/raid/' class='tag-link-47' title='1 topic' style='font-size: 8pt;'>RAID</a>
<a href='http://liuxuan.info/tag/reading/' class='tag-link-45' title='1 topic' style='font-size: 8pt;'>Reading</a>
<a href='http://liuxuan.info/tag/redis/' class='tag-link-44' title='1 topic' style='font-size: 8pt;'>Redis</a>
<a href='http://liuxuan.info/tag/reference-types/' class='tag-link-11' title='1 topic' style='font-size: 8pt;'>Reference Types</a>
<a href='http://liuxuan.info/tag/ruby/' class='tag-link-51' title='1 topic' style='font-size: 8pt;'>Ruby</a>
<a href='http://liuxuan.info/tag/sad/' class='tag-link-46' title='1 topic' style='font-size: 8pt;'>Sad</a>
<a href='http://liuxuan.info/tag/sourcecode/' class='tag-link-79' title='2 topics' style='font-size: 11.111111111111pt;'>Sourcecode</a>
<a href='http://liuxuan.info/tag/timetable/' class='tag-link-34' title='1 topic' style='font-size: 8pt;'>Timetable</a>
<a href='http://liuxuan.info/tag/trap/' class='tag-link-13' title='3 topics' style='font-size: 13.185185185185pt;'>Trap</a>
<a href='http://liuxuan.info/tag/vim/' class='tag-link-50' title='1 topic' style='font-size: 8pt;'>Vim</a>
<a href='http://liuxuan.info/tag/vps/' class='tag-link-70' title='2 topics' style='font-size: 11.111111111111pt;'>VPS</a></div>
</li><li id="picplz-widget-3" class="widget picplz"><h2 class="widgettitle">My Photos</h2>		
				<style type="text/css" media="screen">
		            .pp-user-widget {
		                width:100%;
		                font-family:Helvetica, Arial;
		                font-weight:bold;
		            }
		            .pp-user-widget ul {
		                width:100%;
		                margin:0;
		                padding:0;
		            }
		            .pp-user-widget li, .pp-user-widget li a  {
		                width:100px;
		                height:100px;
		                display:block;
		            }
		            .pp-user-widget li {
		                list-style:none;
		                padding:0;
		                float:left;
		                margin:0 5px 5px 0;
		            }
		            .pp-title {
		                padding-bottom:5px;
		            }
					.pp-brand {
						clear:both;
					}
		            .pp-brand em {
		                text-align:right;
		                padding-right:5px;
		                line-height:13px;
		            }
					ul.picplz-user-widget {
						margin:0;padding:0;
					}
		        </style>
		        <div class="my-widget-holder">
		            <div class="pp-user-widget">
		                <div class='pp-w-body'></div> 
						            </div>
		        </div>
				<script>window.jQuery || document.write("<script src='http://liuxuan.info/wp-content/plugins/picplz-widget/jquery-1.5.1.min.js'>\x3C/script>")</script>
				<script type="text/javascript" charset="utf-8">
				   (function(JQ){
	                show_my_pics = function(username,numberOfPhotos){
						JQ.getJSON("https://api.picplz.com/api/v2/user.json?include_pics=1&username="+username+"&pic_page_size="+numberOfPhotos+"&callback=?", function(data){
	                        if(data.result == "ok"){
	                            var pics = data.value.users[0].pics,
	                                html = "<ul class='picplz-user-widget' style='margin:0;' >",
	                                parent = JQ(".pp-user-widget"),
	                                holder = JQ(".pp-w-body", parent),
	                                val, url, src, width, height;
	                            JQ.each(pics, function(i, val){
	                                url = val.url;
	                                src = val.pic_files["100sh"].img_url;
	                                //width = val.pic_files["100sh"].width;
	                                //height = val.pic_files["100sh"].height;
									width = 100;
	                                height = 100;
	                                html = html + " <li><a href='http://picplz.com"+url+"'><img src='"+src+"' width='"+width+"' height='"+height+"'></a></li>";
	                            });
	                            html = html + "</ul>";
	                            holder.html(html);
	                        }
	                    });
	                };                
			        show_my_pics("Foredoomed", "10");
	            })(jQuery);
				</script>
			</li><!--#sidebar-wide widgets end-->
	</ul>

</div><!--#sidebar-wide-->

</div><!--#pp-sidebars-->

</div><!--#secondary--><!--cos-html-cache-safe-tag-->	<div id="footer">
		<p class="left">&#169; 2011 <strong>Zhixingheyi</strong> | Powered by <strong><a href="http://wordpress.org/">WordPress</a></strong></p>
		<p class="right">A <strong><a href="http://www.techtrot.com/primepress/" title="PrimePress theme homepage">WordPress theme</a></strong> by <strong>Ravi Varma</strong></p>
	</div><!--#footer-->

</div><!--#container-->	
	
</div><!--#page-->

<!--[if IE]>
<script language=javascript>
	var sheight = screen.height;
	var swidth = screen.width;
	document.cookie = "wassup_screen_res=" + swidth + " x " + sheight + "; path=/; domain=" + document.domain;
</script>
<![endif]--><!--
<p class="small"> WassUp 1.8.2 timestamp: 2011-09-08 03:32:09PM UTC (11:32PM)<br />
If above timestamp is not current time, this page is cached.</p> -->
</body>
</html><!--this is a real static html file created at 2011-09-08 15:32:06 by cos-html-cache 2.7.3 -->